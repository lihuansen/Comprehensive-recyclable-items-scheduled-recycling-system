# 基地管理通知系统 - 可视化使用指南

## 界面流程说明

### 1. 基地管理主页面

```
┌─────────────────────────────────────────────────────────────┐
│                      基地管理                                 │
│              管理运输通知和仓库入库操作                         │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────┐    ┌──────────────────────────┐
│   🚚 运输管理              │    │   📦 仓库管理             │
│   [3] ← 消息徽章            │    │                          │
│                          │    │                          │
│   实时查看运输中的订单      │    │   处理可回收物入库操作    │
│   及时了解即将到达基地的    │    │   创建入库单并管理仓库    │
│   可回收物                 │    │   库存                   │
│                          │    │                          │
│   ✓ 查看运输中订单列表     │    │   ✓ 创建入库单           │
│   ✓ 了解预估重量和物品类别 │    │   ✓ 自动清零暂存点重量   │
│   ✓ 查看运输人员和回收员   │    │   ✓ 查看入库记录         │
│                          │    │                          │
│   进入运输管理 →           │    │   进入仓库管理 →          │
└──────────────────────────┘    └──────────────────────────┘
       ↑
       └─── 徽章显示有 3 个新的运输中订单
```

**说明**：
- 红色数字徽章 `[3]` 显示在**运输管理卡片**上
- 用户可以清楚地知道消息来自运输管理功能
- 数字表示**新增**的运输中订单数量（不是总数）

---

### 2. 导航栏徽章

```
┌─────────────────────────────────────────────────────────────┐
│  [基地管理 [3]]    ◇ 基地工作台 ◇    账号管理                  │
│      ↑                                                       │
│      └── 导航栏也显示徽章，与运输管理卡片同步                   │
└─────────────────────────────────────────────────────────────┘
```

**说明**：
- 顶部导航栏的"基地管理"也显示徽章 `[3]`
- 与基地管理页面中的运输管理卡片徽章保持同步
- 每 30 秒自动刷新更新

---

### 3. 点击进入运输管理

```
┌─────────────────────────────────────────────────────────────┐
│  🚚 运输管理                                                  │
│  (数据自动加载，无需点击刷新按钮)                              │
└─────────────────────────────────────────────────────────────┘

┌──────────────────┐
│  🚚 运输中订单    │
│      3           │ ← 自动显示订单统计
└──────────────────┘

运输中订单列表  [🔄 刷新]
┌────────────────────────────────────────────────────────────┐
│ 运输单号  │ 回收员  │ 运输人员 │ 预估重量 │ 取货时间 │ 状态  │
├────────────────────────────────────────────────────────────┤
│ TRN-001  │ 张三    │ 李四     │ 25.5 kg │ 2024-... │运输中 │
│ TRN-002  │ 王五    │ 赵六     │ 18.3 kg │ 2024-... │运输中 │
│ TRN-003  │ 钱七    │ 孙八     │ 32.1 kg │ 2024-... │运输中 │
└────────────────────────────────────────────────────────────┘
```

**关键改进**：
1. ✅ **自动加载数据**：进入页面后数据列表立即显示，无需点击"刷新"按钮
2. ✅ **标记为已读**：系统记录用户已查看 3 个订单
3. 🔄 **自动刷新**：页面每 30 秒自动更新数据

**技术实现**：
- 将 `@Html.AntiForgeryToken()` 移到页面顶部
- 确保 jQuery 可以在 `$(document).ready()` 时获取到令牌
- JavaScript 自动调用 `loadInTransitOrders()` 函数

---

### 4. 返回基地管理页面

```
┌─────────────────────────────────────────────────────────────┐
│                      基地管理                                 │
│              管理运输通知和仓库入库操作                         │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────┐    ┌──────────────────────────┐
│   🚚 运输管理              │    │   📦 仓库管理             │
│   (无徽章)                 │    │                          │
│   ↑                       │    │                          │
│   └── 徽章消失了！          │    │                          │
│                          │    │                          │
│   进入运输管理 →           │    │   进入仓库管理 →          │
└──────────────────────────┘    └──────────────────────────┘
```

**说明**：
- 徽章已经消失，因为用户已经查看了所有订单
- 如果有新订单到达，徽章会再次显示新增数量

---

### 5. 新订单到达

假设有 2 个新的运输订单到达：

```
┌─────────────────────────────────────────────────────────────┐
│                      基地管理                                 │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────┐
│   🚚 运输管理              │
│   [2] ← 显示新增的 2 个订单 │
│                          │
│   进入运输管理 →           │
└──────────────────────────┘
```

**说明**：
- 徽章只显示 `[2]`，而不是总订单数 `[5]`
- 这是因为系统记住了用户上次已经看过 3 个订单
- 徽章只提示**新增**的订单，避免重复提醒

---

## 工作原理

### Session 状态追踪

```
用户首次访问:
LastViewedTransportCount = 0

当前运输中订单数: 3
徽章显示: 3 - 0 = 3 ✓

点击进入运输管理:
LastViewedTransportCount = 3 (更新为当前订单数)

返回基地管理:
当前运输中订单数: 3
徽章显示: 3 - 3 = 0 (不显示徽章) ✓

新订单到达:
当前运输中订单数: 5
徽章显示: 5 - 3 = 2 ✓
```

### 边缘情况处理

```
订单被取消或完成:
上次查看订单数: 5
当前运输中订单数: 3

计算: Math.Max(0, 3 - 5) = 0
徽章显示: 0 (不显示) ✓

同时记录日志: "订单数量减少，可能有订单被取消或完成"
```

---

## 自动更新机制

### 定时刷新

```
页面加载:
  ↓
checkTransportUpdates()  ←─────┐
  ↓                            │
调用 API 获取新订单数量          │
  ↓                            │
更新徽章显示                    │
  ↓                            │
等待 30 秒 ─────────────────────┘
```

**两个地方都有自动更新**：
1. **基地管理页面**：每 30 秒更新运输管理卡片徽章
2. **导航栏**：每 30 秒更新"基地管理"导航项徽章

---

## 用户体验优势

### 之前的问题

❌ **问题 1**：不知道消息来自哪里
```
[基地管理 [3]]  ← 导航栏有数字，但不知道是运输管理还是仓库管理
```

❌ **问题 2**：进入后数字不消失
```
看过订单后，徽章还是显示 [3]，一直提醒
```

❌ **问题 3**：需要手动刷新
```
进入运输管理 → 页面空白 → 必须点击"刷新"按钮 → 才能看到数据
```

### 现在的解决方案

✅ **解决 1**：明确消息来源
```
运输管理卡片上显示 [3]，一目了然
```

✅ **解决 2**：智能已读机制
```
看过后徽章消失，只提醒新订单
```

✅ **解决 3**：自动加载数据
```
进入运输管理 → 数据立即显示，无需手动操作
```

---

## 技术亮点

1. **Session 状态管理**
   - 使用 ASP.NET Session 存储已查看订单数量
   - 登录期间持续有效，退出后自动清除

2. **智能计算逻辑**
   - 新消息数 = 当前总数 - 上次查看数
   - Math.Max 处理订单减少的情况

3. **实时更新**
   - JavaScript 定时器每 30 秒自动刷新
   - 无需用户手动操作

4. **用户友好**
   - 只提示新消息，避免重复提醒
   - 数据自动加载，提升体验

---

## 总结

这个解决方案通过以下方式提升了用户体验：

1. 📍 **明确消息来源**：在运输管理卡片上显示徽章
2. 🔔 **智能通知**：只提示未查看的新订单
3. ⚡ **自动加载**：进入页面立即显示数据
4. 🔄 **实时更新**：每 30 秒自动刷新

用户现在可以更高效地管理运输通知，提高工作效率！
