# 订单回退功能实现总结

## 功能概述

根据需求，在预约订单状态为"进行中"时，回收员可以使用"回退订单"按钮。此功能用于处理线下回收时发现物品不符合回收要求的情况。

## 核心特性

1. **回退按钮**: 仅在订单状态为"进行中"时显示
2. **原因输入**: 回收员必须输入回退原因，默认为"物品不符合回收要求"
3. **状态变更**: 订单状态变为"已取消-回收员回退"（区别于用户主动取消）
4. **通知机制**: 用户自动收到通知，内容包含回收员姓名和回退原因
5. **保持沟通**: 用户仍可通过"联系回收员"按钮与回收员沟通

## 实现的文件变更

### 后端代码

1. **recycling.Model/UserNotifications.cs**
   - 添加 `OrderRolledBack` 通知类型常量
   - 在 `GetDisplayName` 方法中添加显示名称"订单回退"
   - 在 `GetIcon` 方法中添加图标 "fa-undo"
   - 在 `GetColor` 方法中添加颜色 "#fd7e14" (橙色)

2. **recycling.BLL/UserNotificationBLL.cs**
   - 添加 `SendOrderRolledBackNotification` 方法
   - 参数: orderId, recyclerName, reason
   - 发送通知标题: "订单已回退"
   - 通知内容包含订单号、回收员姓名、回退原因及沟通提示

3. **recycling.BLL/RecyclerOrderBLL.cs**
   - 添加 `RollbackOrder` 方法
   - 验证回收员权限
   - 验证订单状态必须为"进行中"
   - 更新订单状态为"已取消-回收员回退"

4. **recycling.Web.UI/Controllers/StaffController.cs**
   - 添加 `RollbackOrder` API 端点
   - 使用 `[ValidateAntiForgeryToken]` 防止 CSRF 攻击
   - 调用 BLL 层回退订单
   - 发送系统消息到对话
   - 发送用户通知

5. **recycling.Web.UI/Controllers/HomeController.cs**
   - 更新 `GetStatusBadgeClass` 方法
   - 添加"已取消-回收员回退"状态的徽章样式类

### 前端代码

1. **recycling.Web.UI/Views/Staff/Recycler_OrderManagement.cshtml**
   - 在"进行中"订单的操作按钮区域添加"回退订单"按钮
   - 按钮样式: `btn-action warning` (黄色警告按钮)
   - 添加 `rollbackOrder(appointmentId)` JavaScript 函数
   - 实现原因输入提示框
   - 实现确认对话框
   - 实现按钮禁用和加载状态
   - 使用防伪令牌进行 AJAX 提交

2. **recycling.Web.UI/Views/Home/Order.cshtml**
   - 添加"已取消-回收员回退"状态的特殊处理
   - 为回退订单显示"联系回收员"按钮（区别于普通取消订单）
   - 添加"再预约一单"按钮
   - 添加 `.status-rolledback-badge` CSS 样式类
   - 徽章背景: #fff3cd (浅黄色)
   - 徽章文字: #856404 (深黄褐色)
   - 徽章边框: #ffeeba (黄色)

## 业务流程

### 回收员回退订单流程

```
1. 回收员登录系统
2. 进入"订单管理"页面
3. 找到状态为"进行中"的订单
4. 点击"回退订单"按钮
5. 系统弹出提示框，要求输入回退原因
6. 回收员输入原因（例如："塑料瓶有污染，不符合回收标准"）
7. 系统弹出确认对话框
8. 回收员确认回退
9. 系统处理回退请求：
   - 更新订单状态为"已取消-回收员回退"
   - 发送系统消息到订单对话
   - 发送通知给用户
10. 回收员看到成功提示
11. 订单列表自动刷新
```

### 用户接收通知流程

```
1. 用户收到通知（我的消息）
2. 通知标题："订单已回退"
3. 通知内容："您的订单 #AP000123 已被回收员 张三 回退。
   原因：塑料瓶有污染，不符合回收标准。
   您可以继续与回收员沟通了解详情。"
4. 用户点击通知，查看详情
5. 用户在"我的订单"中看到该订单状态为"已取消-回收员回退"
6. 用户可以点击"联系回收员"继续沟通
```

## 与普通取消的区别

| 特性 | 用户主动取消 | 回收员回退 |
|------|-------------|-----------|
| 订单状态 | 已取消 | 已取消-回收员回退 |
| 徽章颜色 | 红色 | 橙黄色 |
| 联系回收员按钮 | 无 | 有 |
| 系统消息 | 无 | 有（包含原因） |
| 通知类型 | OrderCancelled | OrderRolledBack |
| 再预约按钮 | 有 | 有 |

## 安全措施

1. **CSRF 保护**: 使用 `[ValidateAntiForgeryToken]` 防止跨站请求伪造
2. **权限验证**: 验证回收员身份和订单权限
3. **状态验证**: 只允许"进行中"状态的订单被回退
4. **输入验证**: 要求必须输入回退原因
5. **按钮防抖**: 禁用按钮防止重复提交

## 用户体验优化

1. **清晰的视觉区分**: 使用不同颜色徽章区分回退订单
2. **保持沟通渠道**: 回退后仍可联系回收员
3. **详细的原因说明**: 用户知道为什么订单被回退
4. **友好的错误提示**: 所有错误情况都有清晰的提示
5. **即时反馈**: 操作成功后立即刷新列表

## 测试建议

详细的测试场景请参考 `ORDER_ROLLBACK_TEST_GUIDE.md` 文件。

关键测试点：
- ✅ 成功回退订单
- ✅ 用户收到通知
- ✅ 用户可以联系回收员
- ✅ 状态验证（只有"进行中"可以回退）
- ✅ 原因必填验证
- ✅ 取消回退操作
- ✅ UI 按钮状态
- ✅ 视觉样式正确性
- ✅ 系统消息发送

## 扩展建议

未来可能的功能扩展：
1. 回退统计：统计回收员回退订单的频率和原因
2. 原因模板：提供常见回退原因的快速选择
3. 回退历史：记录订单的回退历史
4. 自动重新匹配：回退后自动为用户匹配其他回收员
5. 回退评价：允许用户对回退操作进行反馈

## 版本信息

- **实现日期**: 2026-01-08
- **版本**: 1.0
- **开发者**: GitHub Copilot
- **状态**: 已完成，待测试

## 相关文档

- 测试指南: `ORDER_ROLLBACK_TEST_GUIDE.md`
- 项目架构: `ARCHITECTURE.md`
- 订单流程: `ORDER_FLOW_DOCUMENTATION.md`
