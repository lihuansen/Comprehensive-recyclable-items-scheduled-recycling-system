# 回收员区域管理功能说明

## 功能概述

本功能实现了基于区域的回收员权限管理，管理员可以为每个回收员指定服务区域，回收员登录后只能看到属于其服务区域的订单。

## 主要特性

### 1. 管理员功能

管理员在"回收员管理"页面可以：
- 在添加/编辑回收员时，从下拉菜单选择回收员的服务区域
- 支持的区域包括深圳市罗湖区的10个街道：
  1. 清水河街道
  2. 东门街道
  3. 南湖街道
  4. 桂园街道
  5. 黄贝街道
  6. 东湖街道
  7. 翠竹街道
  8. 莲塘街道
  9. 东晓街道
  10. 笋岗街道

### 2. 回收员功能

回收员登录后：
- 自动根据其分配的区域过滤订单
- 只能查看和处理预约地址属于其服务区域的订单
- 适用于所有订单状态：已预约、进行中、已完成、已取消

## 使用示例

### 场景1：管理员分配回收员区域

1. 管理员登录系统
2. 进入"回收员管理"页面
3. 点击"添加回收员"或"编辑"按钮
4. 在"区域"下拉菜单中选择："广东省深圳市罗湖区清水河街道"
5. 填写其他必填信息并保存

### 场景2：回收员查看订单

1. 回收员（区域：清水河街道）登录系统
2. 进入"订单管理"页面
3. 系统自动显示以下订单：
   - ✅ 地址包含"广东省深圳市罗湖区清水河街道"的订单
   - ❌ 不显示其他区域的订单（如东门街道、南湖街道等）

## 技术实现

### 前端更改（RecyclerManagement.cshtml）

```html
<!-- 原来的文本输入框 -->
<input type="text" class="form-control" id="region" required>

<!-- 更改为下拉选择框 -->
<select class="form-control" id="region" required>
    <option value="">请选择区域</option>
    <option value="广东省深圳市罗湖区清水河街道">广东省深圳市罗湖区清水河街道</option>
    <!-- ... 其他9个选项 ... -->
</select>
```

### 后端更改（RecyclerOrderDAL.cs）

1. **新增方法**：`GetRecyclerRegion(int recyclerId)`
   - 从数据库获取回收员的区域信息
   - 包含完整的错误处理机制

2. **修改方法**：`GetRecyclerOrders(OrderFilterModel filter, int recyclerId)`
   - 在查询订单前获取回收员区域
   - 使用SQL LIKE操作符过滤订单地址
   - 确保只返回匹配区域的订单

### 数据库查询逻辑

```sql
-- 添加区域过滤条件
WHERE a.Address LIKE '%广东省深圳市罗湖区清水河街道%'
```

## 性能优化

1. **避免N+1查询问题**
   - 在构建SQL查询前一次性获取回收员区域
   - 避免在循环中重复查询数据库

2. **错误处理**
   - 使用try-catch块捕获数据库异常
   - 失败时记录日志但不影响主流程
   - 回收员区域获取失败时，默认不进行区域过滤

3. **SQL参数化**
   - 使用SqlParameter防止SQL注入
   - 明确指定SqlDbType提高性能

## 数据库要求

### Recyclers表
- 必须有`Region`字段（类型：nvarchar/varchar）
- 存储完整的区域地址，如："广东省深圳市罗湖区清水河街道"

### Appointments表
- 必须有`Address`字段（类型：nvarchar/varchar）
- 存储用户预约的详细地址

## 配置说明

### 添加新区域

如需添加新的服务区域，修改`RecyclerManagement.cshtml`文件：

```html
<select class="form-control" id="region" required>
    <option value="">请选择区域</option>
    <!-- 现有选项 -->
    <option value="广东省深圳市罗湖区清水河街道">广东省深圳市罗湖区清水河街道</option>
    
    <!-- 添加新选项 -->
    <option value="广东省深圳市福田区新区域">广东省深圳市福田区新区域</option>
</select>
```

## 注意事项

1. **地址匹配规则**
   - 使用LIKE模糊匹配
   - 预约地址中只要包含回收员的区域字符串即可匹配
   - 例如：回收员区域为"清水河街道"，地址"广东省深圳市罗湖区清水河街道XX小区"会匹配

2. **用户地址规范**
   - 建议用户在预约时填写完整的详细地址
   - 地址格式应包含：省-市-区-街道-详细地址

3. **回收员权限**
   - 回收员不能修改自己的服务区域
   - 只有管理员可以分配和修改回收员的服务区域

4. **日志记录**
   - 当前使用Debug.WriteLine记录错误
   - 生产环境建议使用专业日志框架（NLog、Serilog等）

## 故障排除

### 问题1：回收员看不到任何订单

**可能原因**：
- 回收员的区域字段为空
- 订单地址与回收员区域不匹配

**解决方案**：
1. 检查回收员的区域是否已正确设置
2. 检查订单地址是否包含回收员的区域字符串

### 问题2：回收员看到不应该看到的订单

**可能原因**：
- 区域过滤失败（GetRecyclerRegion返回空字符串）
- 订单地址包含多个区域名称

**解决方案**：
1. 检查数据库连接是否正常
2. 查看错误日志了解具体原因
3. 确保订单地址格式规范

## 版本历史

- **v1.0** (2024) - 初始版本
  - 实现区域下拉选择
  - 实现基于区域的订单过滤
  - 添加性能优化和错误处理

## 相关文件

- `recycling.Web.UI/Views/Staff/RecyclerManagement.cshtml` - 管理员界面
- `recycling.DAL/RecyclerOrderDAL.cs` - 订单数据访问层
- `recycling.BLL/RecyclerOrderBLL.cs` - 订单业务逻辑层
- `recycling.Model/Recyclers.cs` - 回收员模型
- `recycling.Model/Appointments.cs` - 预约模型
