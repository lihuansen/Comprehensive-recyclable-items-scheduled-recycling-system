# 回收员消息通知功能测试指南

## 功能概述

当回收员通过消息系统给用户发送消息时，系统会自动在用户的"我的消息"页面创建一个通知。用户可以：
- 在"我的消息"页面看到回收员发送的消息通知
- 在导航栏看到未读消息数量徽章
- 点击通知查看相关订单详情

## 测试前准备

### 必需账号
1. **用户账号**：一个普通用户账号（用于接收通知）
2. **回收员账号**：一个回收员账号（用于发送消息）

### 前置条件
1. 用户需要创建至少一个预约订单
2. 回收员需要接单该订单（订单状态变为"进行中"）

## 测试场景

### 场景1：回收员发送消息，用户接收通知

#### 步骤：

1. **用户创建订单**
   - 以用户身份登录系统
   - 在首页选择回收品类
   - 创建预约订单
   - 记录订单号（例如：#AP000123）

2. **回收员接单**
   - 以回收员身份登录系统
   - 进入"订单管理"
   - 找到刚才创建的订单并点击"接收"
   - 确认订单状态变为"进行中"

3. **回收员发送消息**
   - 回收员点击"消息中心"
   - 在左侧订单列表中找到该订单
   - 在右侧输入框输入消息，例如："您好，我是负责您订单的回收员，预计30分钟内到达。"
   - 点击发送

4. **用户查看通知**
   - 切换到用户账号（或重新登录）
   - **验证点1**：导航栏"我的消息"旁边应该显示红色徽章（数字1）
   - 点击"我的消息"进入消息中心
   - **验证点2**：应该看到一条新通知
     - 类型：回收员消息（青绿色）
     - 标题：回收员 [回收员姓名] 发来新消息
     - 内容：消息预览（最多50字符）
     - 图标：信封图标
     - 状态：未读（有蓝色圆点）
   - **验证点3**：通知右侧有"查看订单"按钮

5. **点击通知查看**
   - 点击该通知项
   - **验证点4**：通知变为已读（蓝色圆点消失）
   - **验证点5**：导航栏徽章数字减1（如果只有这一条未读，徽章消失）

6. **点击查看订单**
   - 点击通知右侧的"查看订单"按钮
   - **验证点6**：跳转到"我的订单"页面，定位到相关订单

### 场景2：多条消息通知

#### 步骤：

1. **回收员连续发送多条消息**
   - 回收员在同一订单中发送3条不同的消息
   - 例如：
     - "您好，我是负责您订单的回收员"
     - "预计30分钟内到达"
     - "已到达小区门口，请问您在哪栋楼？"

2. **用户查看通知列表**
   - 用户登录系统
   - **验证点1**：导航栏徽章显示数字3
   - 点击"我的消息"
   - **验证点2**：看到3条独立的通知，每条对应一条消息
   - **验证点3**：通知按时间倒序排列（最新的在最上面）

3. **逐条查看通知**
   - 点击第一条通知
   - **验证点4**：该通知变为已读，徽章数字变为2
   - 点击第二条通知
   - **验证点5**：该通知变为已读，徽章数字变为1
   - 点击第三条通知
   - **验证点6**：该通知变为已读，徽章消失

### 场景3：长消息预览测试

#### 步骤：

1. **回收员发送长消息**
   - 回收员发送一条超过50字符的消息
   - 例如："您好，我是您的回收员小李，非常感谢您使用我们的服务。我目前正在前往您的地址的路上，预计20分钟后到达。由于今天天气不太好，可能会有一些延误，请您耐心等待。如果有任何问题，请随时通过消息联系我。"

2. **用户查看通知**
   - 用户登录并进入"我的消息"
   - **验证点1**：通知内容显示前50个字符，后面跟"..."
   - 例如："您好，我是您的回收员小李，非常感谢您使用我们的服务。我目前正在前往您的地址的路上，..."

### 场景4：通知持久化测试

#### 步骤：

1. **回收员发送消息**
   - 回收员发送一条消息

2. **用户不查看通知并退出**
   - 用户登录看到未读通知
   - 不点击通知
   - 退出登录

3. **用户重新登录**
   - 用户重新登录系统
   - **验证点1**：导航栏徽章仍然显示（未读通知保持）
   - 点击"我的消息"
   - **验证点2**：之前的通知仍然标记为未读

### 场景5：全部标记已读测试

#### 步骤：

1. **回收员发送多条消息**
   - 回收员发送3条消息

2. **用户批量标记已读**
   - 用户登录进入"我的消息"
   - 不点击任何通知
   - 点击右上角"全部已读"按钮
   - **验证点1**：所有通知变为已读状态
   - **验证点2**：导航栏徽章消失

### 场景6：通知与实时聊天结合

#### 步骤：

1. **回收员发送消息**
   - 回收员在消息中心给用户发送消息

2. **用户查看通知和聊天**
   - 用户在"我的消息"看到通知
   - 点击"查看订单"按钮
   - 在订单详情中打开与回收员的对话
   - **验证点1**：对话中显示回收员发送的消息
   - **验证点2**：消息内容与通知预览一致

## 预期结果

### 成功标准

✅ **通知创建**
- 回收员发送消息后，自动创建用户通知
- 通知包含回收员姓名和消息预览
- 通知关联到正确的订单

✅ **UI显示**
- 导航栏徽章正确显示未读数量
- 通知列表显示回收员消息类型
- 图标和颜色正确（信封图标，青绿色）

✅ **交互功能**
- 点击通知标记为已读
- "查看订单"按钮正常工作
- "全部已读"功能正常
- 删除通知功能正常

✅ **持久化**
- 未读状态在重新登录后保持
- 已读状态正确保存
- 通知不会重复出现

### 失败情况

❌ **如果出现以下情况，说明存在问题**：
- 回收员发送消息后，用户没有收到通知
- 导航栏徽章不显示或数字不正确
- 通知内容为空或显示错误
- 点击通知后状态不更新
- 已读通知在重新登录后又变为未读
- 通知类型、图标或颜色显示错误

## 数据库验证

### 检查UserNotifications表

发送消息后，可以在数据库中验证：

```sql
-- 查看最新的回收员消息通知
SELECT TOP 10 
    NotificationID,
    UserID,
    NotificationType,
    Title,
    Content,
    RelatedOrderID,
    CreatedDate,
    IsRead
FROM UserNotifications
WHERE NotificationType = 'RecyclerMessageReceived'
ORDER BY CreatedDate DESC

-- 验证通知是否关联到正确的用户
SELECT 
    n.NotificationID,
    n.Title,
    n.Content,
    u.Username as UserName,
    a.AppointmentID as OrderID
FROM UserNotifications n
INNER JOIN Users u ON n.UserID = u.UserID
LEFT JOIN Appointments a ON n.RelatedOrderID = a.AppointmentID
WHERE n.NotificationType = 'RecyclerMessageReceived'
ORDER BY n.CreatedDate DESC
```

## 性能考虑

- 消息发送性能：通知创建使用异步方式，不影响消息发送速度
- 页面加载：通知列表使用分页，默认每页15条
- 自动刷新：导航栏徽章每60秒自动刷新一次

## 故障排查

### 问题1：用户没有收到通知

**可能原因**：
1. 订单状态不是"进行中"
2. 消息发送者不是回收员
3. 数据库连接问题

**解决方法**：
- 检查订单状态
- 检查回收员登录会话
- 查看服务器日志

### 问题2：徽章数字不正确

**可能原因**：
1. 浏览器缓存问题
2. 前端JavaScript错误

**解决方法**：
- 清除浏览器缓存并刷新
- 检查浏览器控制台错误
- 手动调用 `window.updateNavUnreadBadge()`

### 问题3：点击通知后没有标记为已读

**可能原因**：
1. Session过期
2. 防伪令牌问题
3. 数据库更新失败

**解决方法**：
- 重新登录
- 检查服务器端日志
- 验证数据库连接

## 注意事项

1. **消息预览长度**：自动截取前50个字符，超长消息会加"..."
2. **通知数量**：每条消息创建一条通知，建议回收员合并内容发送
3. **已读状态**：点击通知即标记为已读，无需打开订单详情
4. **删除功能**：删除通知不影响原始消息记录

## 相关文档

- [消息通知持久化修复说明](MESSAGE_NOTIFICATION_FIX_CN.md)
- [用户通知系统架构](ARCHITECTURE.md)
- [开发指南](DEVELOPMENT_GUIDE.md)
