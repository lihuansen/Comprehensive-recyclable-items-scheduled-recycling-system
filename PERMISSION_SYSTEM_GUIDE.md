# 管理员权限分配系统使用指南

## 系统概述

本系统实现了基于角色的访问控制（RBAC），允许超级管理员为普通管理员分配不同的权限，确保管理员只能访问被授权的功能模块。

## 权限类型

系统支持以下6种权限类型：

| 权限代码 | 权限名称 | 可访问功能 |
|---------|---------|-----------|
| `user_management` | 用户管理 | 用户管理页面 - 查看、编辑、删除用户信息 |
| `recycler_management` | 回收员管理 | 回收员管理页面 - 管理回收员账号和信息 |
| `feedback_management` | 反馈管理 | 反馈管理页面 - 查看和处理用户反馈 |
| `homepage_management` | 首页页面管理 | 首页页面管理 - 管理轮播图和首页内容 |
| `warehouse_management` | 仓库管理 | 仓库管理页面 - 查看和管理库存信息 |
| `full_access` | 全部权限 | 所有管理功能 - 访问所有上述功能 |

## 功能特性

### 1. 权限分配
- **谁可以分配权限**：只有超级管理员（SuperAdmin）可以为普通管理员分配权限
- **如何分配**：在"管理员管理"页面中添加或编辑管理员时选择相应权限
- **权限生效**：权限设置后立即生效，管理员重新登录或刷新页面后即可看到变化

### 2. 导航栏自适应
- 管理员登录后，导航栏只显示其有权限访问的功能
- 没有权限的功能选项不会在导航栏中显示
- 提升用户体验，避免混淆

### 3. 权限验证
- **前端验证**：导航栏根据权限动态显示
- **后端验证**：即使直接访问URL，系统也会验证权限
- **访问拒绝**：无权限访问会显示友好的"权限不足"页面

### 4. 超级管理员特权
- 超级管理员不受权限限制
- 可以访问所有功能包括管理员管理
- 负责整个系统的权限分配

## 使用流程

### 超级管理员操作步骤

#### 1. 添加新管理员并分配权限

1. 以超级管理员身份登录系统
2. 点击"管理员管理"进入管理页面
3. 点击"添加管理员"按钮
4. 填写管理员信息：
   - 用户名：管理员登录用户名
   - 密码：初始密码
   - 姓名：管理员真实姓名
   - **权限**：从下拉菜单选择合适的权限
   - 激活状态：默认勾选
5. 点击"保存"完成添加

#### 2. 修改现有管理员权限

1. 在"管理员管理"页面找到目标管理员
2. 点击"编辑"按钮
3. 在权限下拉菜单中选择新的权限
4. 点击"保存"应用更改

#### 3. 查看管理员权限

- 在管理员列表中，"权限"列显示每个管理员的当前权限
- 可以使用搜索功能快速查找特定管理员

### 普通管理员使用

#### 登录后的体验

1. 登录系统后，导航栏只显示有权限的功能
2. 尝试访问无权限的功能会看到提示页面
3. 如需更多权限，需联系超级管理员

#### 权限示例

**用户管理权限的管理员**：
- ✅ 可以访问"用户管理"
- ❌ 无法访问"回收员管理"
- ❌ 无法访问"反馈管理"
- ❌ 无法访问"首页页面管理"
- ❌ 无法访问"仓库管理"

**全部权限的管理员**：
- ✅ 可以访问"用户管理"
- ✅ 可以访问"回收员管理"
- ✅ 可以访问"反馈管理"
- ✅ 可以访问"首页页面管理"
- ✅ 可以访问"仓库管理"

## 技术实现

### 数据库字段

权限信息存储在 `Admins` 表的 `Character` 字段中：

```sql
-- Admins表结构（部分）
CREATE TABLE Admins (
    AdminID INT PRIMARY KEY IDENTITY(1,1),
    Username NVARCHAR(50) NOT NULL,
    PasswordHash NVARCHAR(255) NOT NULL,
    FullName NVARCHAR(100) NOT NULL,
    Character NVARCHAR(50) NULL,  -- 权限字段
    IsActive BIT NULL,
    CreatedDate DATETIME2 NULL,
    LastLoginDate DATETIME2 NULL
);
```

### 权限检查机制

系统在以下层面实现权限检查：

1. **控制器层**：使用 `[AdminPermission]` 特性标注需要权限的Action
2. **视图层**：导航栏使用 `AdminPermissions.HasPermission()` 方法检查权限
3. **业务逻辑层**：可选的额外权限验证

### 代码示例

**控制器中使用权限特性**：
```csharp
[AdminPermission(AdminPermissions.UserManagement)]
public ActionResult UserManagement()
{
    // 用户管理逻辑
}
```

**视图中检查权限**：
```cshtml
@if (recycling.Model.AdminPermissions.HasPermission(adminCharacter, recycling.Model.AdminPermissions.UserManagement))
{
    <li class="normal-nav">@Html.ActionLink("用户管理", "UserManagement", "Staff")</li>
}
```

## 数据库脚本

### 为现有管理员设置权限

如果系统中已有管理员但还没有设置权限，可以使用以下SQL脚本：

```sql
-- 查看所有管理员
SELECT AdminID, Username, FullName, Character FROM Admins;

-- 为特定管理员设置权限（根据实际情况修改AdminID）
UPDATE Admins SET Character = 'user_management' WHERE AdminID = 1;
UPDATE Admins SET Character = 'recycler_management' WHERE AdminID = 2;
UPDATE Admins SET Character = 'full_access' WHERE AdminID = 3;

-- 为所有未设置权限的管理员设置默认权限
UPDATE Admins SET Character = 'full_access' WHERE Character IS NULL;
```

详细脚本请参考：`Database/SetAdminPermissions.sql`

## 最佳实践

### 权限分配建议

1. **最小权限原则**：只分配管理员实际需要的权限
2. **定期审查**：定期检查管理员权限是否仍然合适
3. **职责分离**：不同职责的管理员分配不同权限
4. **备份管理员**：为关键功能设置备份管理员

### 安全建议

1. **超级管理员账号**：
   - 妥善保管超级管理员账号信息
   - 不要将超级管理员账号用于日常操作
   - 定期更换超级管理员密码

2. **普通管理员账号**：
   - 为每个实际工作人员创建独立账号
   - 人员离职时及时禁用或删除账号
   - 发现异常时立即修改密码

3. **权限审计**：
   - 记录权限变更历史（可考虑后续实现）
   - 定期导出管理员列表进行审计

## 常见问题

### Q1: 管理员看不到某个菜单项怎么办？
**A**: 这是正常现象，说明该管理员没有对应的权限。如需访问，请联系超级管理员分配权限。

### Q2: 如何让管理员拥有多个功能的权限？
**A**: 目前每个管理员只能分配一种权限。如果需要多个功能权限，可以选择"全部权限"。如果需要更细粒度的控制，可以考虑系统升级。

### Q3: 超级管理员可以修改自己的权限吗？
**A**: 超级管理员的权限不受 `Character` 字段控制，其角色由 `SuperAdmins` 表定义，拥有系统所有权限。

### Q4: 新添加的管理员必须设置权限吗？
**A**: 是的，从UI添加管理员时必须选择权限。如果通过数据库直接添加，建议手动设置 `Character` 字段。

### Q5: 权限更改后需要重新登录吗？
**A**: 不需要。权限检查是实时的，但为了看到导航栏的变化，建议刷新页面。

## 未来扩展

以下功能可以考虑在未来版本中实现：

1. **细粒度权限**：支持对单个操作的权限控制（如只能查看但不能编辑）
2. **权限组合**：允许管理员拥有多个权限的组合
3. **权限模板**：预定义常用权限组合作为模板
4. **审计日志**：记录所有权限分配和修改操作
5. **临时权限**：支持设置临时权限及自动到期
6. **权限委托**：允许高级管理员临时授予其他管理员权限

## 支持与反馈

如有任何问题或建议，请联系系统管理员或技术支持团队。

---

**文档版本**: 1.0  
**更新日期**: 2025-11-20  
**适用系统版本**: 全品类可回收物预约回收系统 v1.0+
