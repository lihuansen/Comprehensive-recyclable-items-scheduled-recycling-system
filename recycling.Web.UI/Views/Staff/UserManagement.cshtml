@{
    ViewBag.Title = "用户管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stats-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.3s;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .stats-number {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
    }

    .stats-label {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
    }

    .search-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .user-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .user-table table {
        margin-bottom: 0;
    }

    .user-table thead {
        background: #f8f9fa;
    }

    .user-table th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }

    .user-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-active {
        background-color: #28a745;
    }

    .badge-inactive {
        background-color: #6c757d;
    }

    .pagination-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="admin-header">
        <h2><i class="fas fa-users"></i> 用户管理</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">查看和管理系统中的所有用户</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row" id="statsCards">
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number" id="totalUsers">--</div>
                <div class="stats-label"><i class="fas fa-user"></i> 总用户数</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number" id="newUsersThisMonth">--</div>
                <div class="stats-label"><i class="fas fa-user-plus"></i> 本月新增</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number" id="activeUsers">--</div>
                <div class="stats-label"><i class="fas fa-user-check"></i> 活跃用户(30天内)</div>
            </div>
        </div>
    </div>

    <!-- Search Box -->
    <div class="search-box">
        <div class="row">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-addon"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名、邮箱或手机号...">
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary btn-block" onclick="searchUsers()">
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
        </div>
    </div>

    <!-- User Table -->
    <div class="user-table">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>用户ID</th>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>手机号</th>
                    <th>注册日期</th>
                    <th>最后登录</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr>
                    <td colspan="7" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <div class="row">
            <div class="col-md-6">
                <div id="paginationInfo"></div>
            </div>
            <div class="col-md-6 text-right">
                <ul class="pagination" id="pagination" style="margin: 0;"></ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var currentPage = 1;
        var pageSize = 20;
        var searchTerm = '';

        $(document).ready(function () {
            loadStatistics();
            loadUsers();

            // Enter key search
            $('#searchInput').keypress(function (e) {
                if (e.which == 13) {
                    searchUsers();
                }
            });
        });

        function loadStatistics() {
            $.ajax({
                url: '@Url.Action("GetUserStatistics", "Staff")',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        $('#totalUsers').text(response.data.TotalUsers);
                        $('#newUsersThisMonth').text(response.data.NewUsersThisMonth);
                        $('#activeUsers').text(response.data.ActiveUsers);
                    }
                },
                error: function () {
                    console.error('Failed to load statistics');
                }
            });
        }

        function loadUsers() {
            $.ajax({
                url: '@Url.Action("GetUsers", "Staff")',
                type: 'GET',
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    searchTerm: searchTerm
                },
                success: function (response) {
                    if (response.success) {
                        renderUsers(response.data);
                    } else {
                        alert('加载失败: ' + response.message);
                    }
                },
                error: function () {
                    alert('加载用户列表失败');
                }
            });
        }

        function renderUsers(data) {
            var tbody = $('#userTableBody');
            tbody.empty();

            if (data.Items.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center">没有找到用户</td></tr>');
                return;
            }

            data.Items.forEach(function (user) {
                var lastLogin = user.LastLoginDate ? formatDate(user.LastLoginDate) : '从未登录';
                var isActive = user.LastLoginDate && isWithinDays(user.LastLoginDate, 30);
                var statusBadge = isActive ?
                    '<span class="badge badge-active">活跃</span>' :
                    '<span class="badge badge-inactive">不活跃</span>';

                var row = `
                    <tr>
                        <td>${user.UserID}</td>
                        <td>${user.Username}</td>
                        <td>${user.Email}</td>
                        <td>${user.PhoneNumber}</td>
                        <td>${formatDate(user.RegistrationDate)}</td>
                        <td>${lastLogin}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                tbody.append(row);
            });

            // Update pagination
            renderPagination(data);
        }

        function renderPagination(data) {
            var pagination = $('#pagination');
            pagination.empty();

            $('#paginationInfo').html(`显示 ${(data.PageIndex - 1) * data.PageSize + 1} - ${Math.min(data.PageIndex * data.PageSize, data.TotalCount)} 条，共 ${data.TotalCount} 条`);

            if (data.TotalPages <= 1) return;

            // Previous
            pagination.append(`
                <li class="${data.PageIndex == 1 ? 'disabled' : ''}">
                    <a href="#" onclick="goToPage(${data.PageIndex - 1}); return false;">上一页</a>
                </li>
            `);

            // Page numbers
            var startPage = Math.max(1, data.PageIndex - 2);
            var endPage = Math.min(data.TotalPages, data.PageIndex + 2);

            for (var i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="${i == data.PageIndex ? 'active' : ''}">
                        <a href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `);
            }

            // Next
            pagination.append(`
                <li class="${data.PageIndex >= data.TotalPages ? 'disabled' : ''}">
                    <a href="#" onclick="goToPage(${data.PageIndex + 1}); return false;">下一页</a>
                </li>
            `);
        }

        function goToPage(page) {
            currentPage = page;
            loadUsers();
            window.scrollTo(0, 0);
        }

        function searchUsers() {
            searchTerm = $('#searchInput').val();
            currentPage = 1;
            loadUsers();
        }

        function formatDate(dateString) {
            if (!dateString) return '从未登录';
            var date = new Date(dateString);
            // Check if date is valid
            if (isNaN(date.getTime())) return '无效日期';
            return date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0');
        }

        function isWithinDays(dateString, days) {
            if (!dateString) return false;
            var date = new Date(dateString);
            // Check if date is valid
            if (isNaN(date.getTime())) return false;
            var now = new Date();
            var diff = now - date; // difference in milliseconds
            var daysDiff = diff / (1000 * 60 * 60 * 24);
            return daysDiff >= 0 && daysDiff <= days;
        }
    </script>
}
