@model recycling.Model.StaffLoginViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="login-container">
    <h2 class="login-title">工作人员登录</h2>

    @using (Html.BeginForm("Login", "Staff", FormMethod.Post, new { @class = "staff-login-form active" }))
    {
        @Html.AntiForgeryToken()

        if (ViewData.ModelState[""] != null && ViewData.ModelState[""].Errors.Count > 0)
        {
            <div class="validation-summary-errors">
                @Html.ValidationSummary()
            </div>
        }

        <!-- 角色选择 -->
        <div class="form-group">
            @Html.LabelFor(m => m.StaffRole)
            @Html.DropDownListFor(m => m.StaffRole, new List<SelectListItem>
            {
                new SelectListItem { Value = "recycler", Text = "回收员" },
                new SelectListItem { Value = "admin", Text = "管理员" },
                new SelectListItem { Value = "superadmin", Text = "超级管理员" }
            }, "请选择角色", new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.StaffRole)
        </div>

        <!-- 用户名 -->
        <div class="form-group">
            @Html.LabelFor(m => m.Username)
            @Html.TextBoxFor(m => m.Username, new { @class = "form-control", placeholder = "请输入账号" })
            @Html.ValidationMessageFor(m => m.Username)
        </div>

        <!-- 密码 -->
        <div class="form-group password-group">
            @Html.LabelFor(m => m.Password)
            <div class="password-input-container">
                @Html.PasswordFor(m => m.Password, new { @class = "form-control password-input", placeholder = "请输入密码" })
                <button type="button" class="toggle-password" id="togglePassword">👁️</button>
            </div>
            @Html.ValidationMessageFor(m => m.Password)
        </div>

        <!-- 验证码 -->
        <div class="form-group">
            @Html.LabelFor(m => m.Captcha)
            <div class="captcha-container">
                @Html.TextBoxFor(m => m.Captcha, new { @class = "form-control captcha-input", placeholder = "请输入验证码" })
                <div class="captcha-image" id="captchaImage">
                    @Model.GeneratedCaptcha
                </div>
            </div>
            @Html.ValidationMessageFor(m => m.Captcha)
            @Html.HiddenFor(m => m.GeneratedCaptcha) <!-- 确保隐藏字段正确绑定 -->
        </div>

        <!-- 登录按钮 -->
        <div class="login-buttons">
            <button type="submit" class="btn btn-login">登录</button>
            <button type="reset" class="btn btn-cancel">取消</button>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 密码显示/隐藏切换（与用户登录页保持一致）
        document.getElementById('togglePassword').addEventListener('click', function () {
            const passwordInput = document.querySelector('.password-input');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? '👁️' : '👁️‍🗨️';
        });

        // 验证码刷新逻辑（修正：刷新时重新生成验证码并更新隐藏字段）
        document.getElementById('captchaImage').addEventListener('click', function () {
            // 发起请求获取新验证码（与用户登录页逻辑一致，避免直接刷新页面导致表单数据丢失）
            fetch('@Url.Action("RefreshCaptcha", "Staff")')
                .then(response => response.text())
                .then(newCaptcha => {
                    document.getElementById('captchaImage').textContent = newCaptcha;
                    // 更新隐藏字段的GeneratedCaptcha值
                    document.querySelector('input[name="GeneratedCaptcha"]').value = newCaptcha;
                })
                .catch(error => console.error('验证码刷新失败:', error));
        });
    </script>
}