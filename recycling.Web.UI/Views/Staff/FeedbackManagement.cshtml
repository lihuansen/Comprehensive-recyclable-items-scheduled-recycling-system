@{
    ViewBag.Title = "反馈管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<style>
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .filter-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-group {
        display: inline-block;
        margin-right: 20px;
    }

    .filter-group label {
        font-weight: 600;
        margin-right: 10px;
        color: #495057;
    }

    .filter-group select {
        padding: 8px 15px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background: white;
    }

    .feedback-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .feedback-table table {
        margin-bottom: 0;
    }

    .feedback-table thead {
        background: #f8f9fa;
    }

    .feedback-table th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 15px;
    }

    .feedback-table td {
        padding: 15px;
        vertical-align: middle;
    }

    .feedback-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-pending {
        background-color: #ffc107;
        color: #000;
    }

    .badge-completed {
        background-color: #28a745;
    }

    .btn-view {
        background: #667eea;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        margin-right: 5px;
    }

    .btn-view:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn-reply {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-reply:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #667eea;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
    }

    .checkbox-group input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .checkbox-group label {
        font-weight: 600;
        color: #495057;
        margin: 0;
        cursor: pointer;
    }

    .checkbox-group label.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: none;
        border-radius: 10px;
        width: 80%;
        max-width: 700px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }

    .modal-body {
        padding: 25px;
    }

    .modal-footer {
        padding: 15px 25px;
        border-top: 1px solid #e9ecef;
        text-align: right;
    }

    .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.8;
    }

    .close:hover {
        opacity: 1;
    }

    .detail-group {
        margin-bottom: 20px;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .detail-content {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #667eea;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-control, .form-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .btn-update {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }

    .btn-update:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="admin-header">
        <h2><i class="fas fa-comment-dots"></i> 反馈管理</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">查看和管理用户提交的反馈</p>
    </div>

    <!-- Filter Box -->
    <div class="filter-box">
        <div class="filter-group">
            <label><i class="fas fa-filter"></i> 状态筛选：</label>
            <select id="statusFilter" onchange="loadFeedbacks()">
                <option value="">全部状态</option>
                <option value="反馈中">反馈中</option>
                <option value="已完成">已完成</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-tags"></i> 类型筛选：</label>
            <select id="typeFilter" onchange="loadFeedbacks()">
                <option value="">全部类型</option>
                <option value="问题反馈">问题反馈</option>
                <option value="功能建议">功能建议</option>
                <option value="投诉举报">投诉举报</option>
                <option value="其他">其他</option>
            </select>
        </div>

        <button onclick="loadFeedbacks()" class="btn-view" style="float: right;">
            <i class="fas fa-sync-alt"></i> 刷新
        </button>
    </div>

    <!-- Feedback Table -->
    <div class="feedback-table">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户ID</th>
                    <th>反馈类型</th>
                    <th>主题</th>
                    <th>状态</th>
                    <th>提交时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="feedbackTableBody">
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>加载中...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 详情模态框 -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3><i class="fas fa-info-circle"></i> 反馈详情</h3>
        </div>
        <div class="modal-body">
            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-user"></i> 用户ID</div>
                <div class="detail-content" id="detailUserId"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-tags"></i> 反馈类型</div>
                <div class="detail-content" id="detailType"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-heading"></i> 主题</div>
                <div class="detail-content" id="detailSubject"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-align-left"></i> 详细描述</div>
                <div class="detail-content" id="detailDescription"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-envelope"></i> 联系邮箱</div>
                <div class="detail-content" id="detailEmail"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-clock"></i> 提交时间</div>
                <div class="detail-content" id="detailCreatedDate"></div>
            </div>

            <div class="detail-group" id="adminReplyDisplay" style="display: none;">
                <div class="detail-label"><i class="fas fa-reply"></i> 管理员回复</div>
                <div class="detail-content" id="detailAdminReply"></div>
            </div>

            <hr style="margin: 25px 0;">

            <div class="form-group">
                <label class="detail-label"><i class="fas fa-info-circle"></i> 状态</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="resolvedCheckbox" onchange="handleResolvedChange()">
                    <label for="resolvedCheckbox" id="resolvedLabel">标记为已解决</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-update" onclick="updateFeedbackStatus()">
                <i class="fas fa-save"></i> 保存状态
            </button>
            <button class="btn-cancel" onclick="closeModal()">
                <i class="fas fa-times"></i> 取消
            </button>
        </div>
    </div>
</div>

<!-- 回复模态框 -->
<div id="replyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeReplyModal()">&times;</span>
            <h3><i class="fas fa-reply"></i> 回复反馈</h3>
        </div>
        <div class="modal-body">
            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-heading"></i> 反馈主题</div>
                <div class="detail-content" id="replySubject"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label"><i class="fas fa-align-left"></i> 反馈描述</div>
                <div class="detail-content" id="replyDescription"></div>
            </div>

            <div class="form-group">
                <label class="detail-label"><i class="fas fa-reply"></i> 管理员回复</label>
                <textarea id="replyContent" class="form-textarea" placeholder="输入您的回复..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-update" onclick="submitReply()">
                <i class="fas fa-paper-plane"></i> 发送回复
            </button>
            <button class="btn-cancel" onclick="closeReplyModal()">
                <i class="fas fa-times"></i> 取消
            </button>
        </div>
    </div>
</div>

@section scripts {
<script>
    var currentFeedbackId = null;
    var replyFeedbackId = null;

    $(document).ready(function() {
        loadFeedbacks();
    });

    function loadFeedbacks() {
        var status = $('#statusFilter').val();
        var feedbackType = $('#typeFilter').val();

        $.ajax({
            url: '@Url.Action("GetAllFeedbacks", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                status: status,
                feedbackType: feedbackType
            },
            success: function(response) {
                if (response.success) {
                    displayFeedbacks(response.feedbacks);
                } else {
                    $('#feedbackTableBody').html('<tr><td colspan="7" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>' + (response.message || '加载失败') + '</p></td></tr>');
                }
            },
            error: function() {
                $('#feedbackTableBody').html('<tr><td colspan="7" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>网络错误，请稍后重试</p></td></tr>');
            }
        });
    }

    function displayFeedbacks(feedbacks) {
        if (!feedbacks || feedbacks.length === 0) {
            $('#feedbackTableBody').html('<tr><td colspan="7" class="empty-state"><i class="fas fa-inbox"></i><p>暂无反馈记录</p></td></tr>');
            return;
        }

        var html = '';
        feedbacks.forEach(function(feedback) {
            var statusBadge = feedback.Status === '已完成' ? 'badge-completed' : 'badge-pending';
            var createdDate = new Date(feedback.CreatedDate).toLocaleString('zh-CN');

            html += '<tr>';
            html += '<td>' + feedback.FeedbackID + '</td>';
            html += '<td>' + feedback.UserID + '</td>';
            html += '<td>' + feedback.FeedbackType + '</td>';
            html += '<td>' + (feedback.Subject.length > 30 ? feedback.Subject.substring(0, 30) + '...' : feedback.Subject) + '</td>';
            html += '<td><span class="badge ' + statusBadge + '">' + feedback.Status + '</span></td>';
            html += '<td>' + createdDate + '</td>';
            html += '<td>';
            html += '<button class="btn-view" onclick="viewFeedback(' + feedback.FeedbackID + ')"><i class="fas fa-eye"></i> 查看</button>';
            html += '<button class="btn-reply" onclick="replyFeedback(' + feedback.FeedbackID + ')"><i class="fas fa-reply"></i> 回复</button>';
            html += '</td>';
            html += '</tr>';
        });

        $('#feedbackTableBody').html(html);
    }

    function viewFeedback(feedbackId) {
        var status = $('#statusFilter').val();
        var feedbackType = $('#typeFilter').val();

        $.ajax({
            url: '@Url.Action("GetAllFeedbacks", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                status: status,
                feedbackType: feedbackType
            },
            success: function(response) {
                if (response.success) {
                    var feedback = response.feedbacks.find(f => f.FeedbackID === feedbackId);
                    if (feedback) {
                        currentFeedbackId = feedbackId;
                        $('#detailUserId').text(feedback.UserID);
                        $('#detailType').text(feedback.FeedbackType);
                        $('#detailSubject').text(feedback.Subject);
                        $('#detailDescription').text(feedback.Description);
                        $('#detailEmail').text(feedback.ContactEmail || '未提供');
                        $('#detailCreatedDate').text(new Date(feedback.CreatedDate).toLocaleString('zh-CN'));
                        
                        // Display admin reply if exists
                        if (feedback.AdminReply) {
                            $('#detailAdminReply').text(feedback.AdminReply);
                            $('#adminReplyDisplay').show();
                        } else {
                            $('#adminReplyDisplay').hide();
                        }
                        
                        // Set checkbox based on status
                        var isResolved = feedback.Status === '已完成';
                        $('#resolvedCheckbox').prop('checked', isResolved);
                        
                        // Disable checkbox if already resolved
                        if (isResolved) {
                            $('#resolvedCheckbox').prop('disabled', true);
                            $('#resolvedLabel').addClass('disabled').text('已解决（不可更改）');
                        } else {
                            $('#resolvedCheckbox').prop('disabled', false);
                            $('#resolvedLabel').removeClass('disabled').text('标记为已解决');
                        }
                        
                        $('#detailModal').fadeIn();
                    }
                }
            }
        });
    }

    function closeModal() {
        $('#detailModal').fadeOut();
        currentFeedbackId = null;
    }

    function handleResolvedChange() {
        // This function is called when checkbox changes
        // No action needed as we handle it in updateFeedbackStatus
    }

    function updateFeedbackStatus() {
        if (!currentFeedbackId) {
            alert('无效的反馈ID');
            return;
        }

        var isResolved = $('#resolvedCheckbox').prop('checked');
        var status = isResolved ? '已完成' : '反馈中';

        $.ajax({
            url: '@Url.Action("UpdateFeedbackStatus", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                feedbackId: currentFeedbackId,
                status: status,
                adminReply: '' // No reply in this modal
            },
            success: function(response) {
                if (response.success) {
                    alert('状态更新成功');
                    closeModal();
                    loadFeedbacks();
                } else {
                    alert(response.message || '更新失败');
                }
            },
            error: function() {
                alert('网络错误，请稍后重试');
            }
        });
    }

    function replyFeedback(feedbackId) {
        var status = $('#statusFilter').val();
        var feedbackType = $('#typeFilter').val();

        $.ajax({
            url: '@Url.Action("GetAllFeedbacks", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                status: status,
                feedbackType: feedbackType
            },
            success: function(response) {
                if (response.success) {
                    var feedback = response.feedbacks.find(f => f.FeedbackID === feedbackId);
                    if (feedback) {
                        replyFeedbackId = feedbackId;
                        $('#replySubject').text(feedback.Subject);
                        $('#replyDescription').text(feedback.Description);
                        $('#replyContent').val(feedback.AdminReply || '');
                        $('#replyModal').fadeIn();
                    }
                }
            }
        });
    }

    function closeReplyModal() {
        $('#replyModal').fadeOut();
        replyFeedbackId = null;
        $('#replyContent').val('');
    }

    function submitReply() {
        if (!replyFeedbackId) {
            alert('无效的反馈ID');
            return;
        }

        var replyContent = $('#replyContent').val();
        
        if (!replyContent || replyContent.trim() === '') {
            alert('请输入回复内容');
            return;
        }

        $.ajax({
            url: '@Url.Action("UpdateFeedbackStatus", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                feedbackId: replyFeedbackId,
                status: '', // Empty means don't change status
                adminReply: replyContent
            },
            success: function(response) {
                if (response.success) {
                    alert('回复成功');
                    closeReplyModal();
                    loadFeedbacks();
                } else {
                    alert(response.message || '回复失败');
                }
            },
            error: function() {
                alert('网络错误，请稍后重试');
            }
        });
    }

    // 点击模态框外部关闭
    window.onclick = function(event) {
        if (event.target == document.getElementById('detailModal')) {
            closeModal();
        }
        if (event.target == document.getElementById('replyModal')) {
            closeReplyModal();
        }
    }
</script>
}

