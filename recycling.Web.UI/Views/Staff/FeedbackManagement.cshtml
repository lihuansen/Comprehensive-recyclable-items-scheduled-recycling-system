@{
    ViewBag.Title = "反馈管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .feedback-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
    }

    .feedback-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .feedback-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .btn-header-action {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid white;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-header-action:hover {
        background: white;
        color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
    }

    .feedback-body {
        background: white;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 30px;
    }

    .filter-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .filter-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-label {
        font-weight: 600;
        color: #2c3e50;
        margin-right: 10px;
    }

    .filter-select, .filter-input {
        padding: 8px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .filter-select:focus, .filter-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn-filter {
        padding: 8px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .feedback-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .feedback-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .feedback-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .feedback-table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.3s;
    }

    .feedback-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .feedback-table td {
        padding: 15px;
    }

    .badge-type {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-type.问题反馈 {
        background: #ffeaa7;
        color: #d63031;
    }

    .badge-type.功能建议 {
        background: #dfe6e9;
        color: #2d3436;
    }

    .badge-type.投诉举报 {
        background: #fab1a0;
        color: #e17055;
    }

    .badge-type.其他 {
        background: #74b9ff;
        color: #0984e3;
    }

    .badge-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-status.反馈中 {
        background: #74b9ff;
        color: #0984e3;
    }

    .badge-status.已完成 {
        background: #55efc4;
        color: #00b894;
    }

    .btn-action {
        padding: 6px 12px;
        margin-right: 5px;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-view {
        background: #667eea;
        color: white;
    }

    .btn-view:hover {
        background: #5568d3;
    }

    .btn-reply {
        background: #00b894;
        color: white;
    }

    .btn-reply:hover {
        background: #00a085;
    }

    .btn-contact {
        background: #f59e0b;
        color: white;
    }

    .btn-contact:hover {
        background: #d97706;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #ddd;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 30px;
        gap: 10px;
    }

    .pagination button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .pagination button:hover:not(:disabled) {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination span {
        color: #666;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 80%;
        max-width: 800px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .modal-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
    }

    .modal-close:hover {
        opacity: 0.7;
    }

    .modal-body {
        padding: 30px;
    }

    .detail-group {
        margin-bottom: 20px;
    }

    .detail-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }

    .detail-value {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        color: #666;
    }

    .reply-form {
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn-submit-reply {
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-submit-reply:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
</style>

<div class="feedback-container">
    <div class="feedback-header">
        <h2><i class="fas fa-clipboard-list"></i> 反馈管理</h2>
        <div class="header-actions">
            <a href="@Url.Action("UserContactManagement", "Staff")" class="btn-header-action">
                <i class="fas fa-comments"></i> 用户联系
            </a>
        </div>
    </div>

    <div class="feedback-body">
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">筛选：</span>
                <select id="filterType" class="filter-select">
                    <option value="">全部类型</option>
                    <option value="问题反馈">问题反馈</option>
                    <option value="功能建议">功能建议</option>
                    <option value="投诉举报">投诉举报</option>
                    <option value="其他">其他</option>
                </select>
                <select id="filterStatus" class="filter-select">
                    <option value="">全部状态</option>
                    <option value="反馈中">反馈中</option>
                    <option value="已完成">已完成</option>
                </select>
                <input type="text" id="searchKeyword" class="filter-input" placeholder="搜索关键词...">
                <button class="btn-filter" onclick="loadFeedbacks()">
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
        </div>

        <table class="feedback-table">
            <thead>
                <tr>
                    <th>反馈ID</th>
                    <th>用户</th>
                    <th>类型</th>
                    <th>主题</th>
                    <th>状态</th>
                    <th>提交时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="feedbackTableBody">
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>加载中...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>反馈详情</h3>
            <button class="modal-close" onclick="closeDetailModal()">&times;</button>
        </div>
        <div class="modal-body" id="detailModalBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>回复反馈</h3>
            <button class="modal-close" onclick="closeReplyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="replyFeedbackInfo"></div>
            <form class="reply-form" id="replyForm">
                <input type="hidden" id="replyFeedbackId">
                <div class="form-group">
                    <label class="form-label">处理状态</label>
                    <select id="replyStatus" class="form-control">
                        <option value="反馈中">反馈中</option>
                        <option value="已完成">已完成</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">管理员回复</label>
                    <textarea id="replyContent" class="form-control" rows="6" placeholder="请输入回复内容..."></textarea>
                </div>
                <button type="submit" class="btn-submit-reply">
                    <i class="fas fa-paper-plane"></i> 提交回复
                </button>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function formatTime(iso) {
            if (!iso) return '';
            try { return new Date(iso).toLocaleString(); } catch (e) { return iso; }
        }

        function loadFeedbacks() {
            const filterType = document.getElementById('filterType').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const searchKeyword = document.getElementById('searchKeyword').value;

            fetch('@Url.Action("GetAllFeedbacks", "Staff")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    feedbackType: filterType,
                    status: filterStatus,
                    searchKeyword: searchKeyword,
                    page: currentPage,
                    pageSize: pageSize
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    displayFeedbacks(data.feedbacks);
                    totalPages = data.totalPages;
                    updatePagination();
                } else {
                    document.getElementById('feedbackTableBody').innerHTML = 
                        '<tr><td colspan="7"><div class="empty-state"><p>加载失败</p></div></td></tr>';
                }
            })
            .catch(err => {
                console.error('加载反馈出错', err);
                document.getElementById('feedbackTableBody').innerHTML = 
                    '<tr><td colspan="7"><div class="empty-state"><p>加载失败</p></div></td></tr>';
            });
        }

        function displayFeedbacks(feedbacks) {
            const tbody = document.getElementById('feedbackTableBody');
            
            if (!feedbacks || feedbacks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-inbox"></i><p>暂无反馈记录</p></div></td></tr>';
                return;
            }

            let html = '';
            feedbacks.forEach(function(feedback) {
                html += '<tr>' +
                    '<td>' + feedback.FeedbackID + '</td>' +
                    '<td>用户 #' + feedback.UserID + '</td>' +
                    '<td><span class="badge-type ' + escapeHtml(feedback.FeedbackType) + '">' + escapeHtml(feedback.FeedbackType) + '</span></td>' +
                    '<td>' + escapeHtml(feedback.Subject) + '</td>' +
                    '<td><span class="badge-status ' + escapeHtml(feedback.Status) + '">' + escapeHtml(feedback.Status) + '</span></td>' +
                    '<td>' + formatTime(feedback.CreatedDate) + '</td>' +
                    '<td>' +
                    '<button class="btn-action btn-view" onclick="viewDetail(' + feedback.FeedbackID + ')"><i class="fas fa-eye"></i> 查看</button>' +
                    '<button class="btn-action btn-reply" onclick="showReplyModal(' + feedback.FeedbackID + ')"><i class="fas fa-reply"></i> 回复</button>' +
                    '<button class="btn-action btn-contact" onclick="contactUser(' + feedback.UserID + ')"><i class="fas fa-comments"></i> 联系用户</button>' +
                    '</td>' +
                    '</tr>';
            });

            tbody.innerHTML = html;
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            let html = '';

            html += '<button onclick="goToPage(' + (currentPage - 1) + ')" ' + (currentPage <= 1 ? 'disabled' : '') + '>' +
                '<i class="fas fa-chevron-left"></i> 上一页</button>';
            
            html += '<span>第 ' + currentPage + ' / ' + totalPages + ' 页</span>';
            
            html += '<button onclick="goToPage(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages ? 'disabled' : '') + '>' +
                '下一页 <i class="fas fa-chevron-right"></i></button>';

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadFeedbacks();
        }

        function viewDetail(feedbackId) {
            fetch('@Url.Action("GetFeedbackDetail", "Staff")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feedbackId: feedbackId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.feedback) {
                    const feedback = data.feedback;
                    let html = '';
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">反馈ID</div>' +
                        '<div class="detail-value">' + feedback.FeedbackID + '</div>' +
                        '</div>';
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">用户ID</div>' +
                        '<div class="detail-value">用户 #' + feedback.UserID + '</div>' +
                        '</div>';
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">反馈类型</div>' +
                        '<div class="detail-value"><span class="badge-type ' + escapeHtml(feedback.FeedbackType) + '">' + escapeHtml(feedback.FeedbackType) + '</span></div>' +
                        '</div>';
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">反馈主题</div>' +
                        '<div class="detail-value">' + escapeHtml(feedback.Subject) + '</div>' +
                        '</div>';
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">详细描述</div>' +
                        '<div class="detail-value">' + escapeHtml(feedback.Description) + '</div>' +
                        '</div>';
                    
                    if (feedback.ContactEmail) {
                        html += '<div class="detail-group">' +
                            '<div class="detail-label">联系邮箱</div>' +
                            '<div class="detail-value">' + escapeHtml(feedback.ContactEmail) + '</div>' +
                            '</div>';
                    }
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">当前状态</div>' +
                        '<div class="detail-value"><span class="badge-status ' + escapeHtml(feedback.Status) + '">' + escapeHtml(feedback.Status) + '</span></div>' +
                        '</div>';
                    
                    if (feedback.AdminReply) {
                        html += '<div class="detail-group">' +
                            '<div class="detail-label">管理员回复</div>' +
                            '<div class="detail-value">' + escapeHtml(feedback.AdminReply) + '</div>' +
                            '</div>';
                    }
                    
                    html += '<div class="detail-group">' +
                        '<div class="detail-label">提交时间</div>' +
                        '<div class="detail-value">' + formatTime(feedback.CreatedDate) + '</div>' +
                        '</div>';
                    
                    if (feedback.UpdatedDate) {
                        html += '<div class="detail-group">' +
                            '<div class="detail-label">更新时间</div>' +
                            '<div class="detail-value">' + formatTime(feedback.UpdatedDate) + '</div>' +
                            '</div>';
                    }

                    document.getElementById('detailModalBody').innerHTML = html;
                    document.getElementById('detailModal').style.display = 'block';
                } else {
                    alert('加载详情失败');
                }
            })
            .catch(err => {
                console.error('加载详情出错', err);
                alert('加载详情失败');
            });
        }

        function showReplyModal(feedbackId) {
            fetch('@Url.Action("GetFeedbackDetail", "Staff")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feedbackId: feedbackId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.feedback) {
                    const feedback = data.feedback;
                    document.getElementById('replyFeedbackId').value = feedback.FeedbackID;
                    document.getElementById('replyStatus').value = feedback.Status;
                    document.getElementById('replyContent').value = feedback.AdminReply || '';
                    
                    let infoHtml = '<div class="detail-group">' +
                        '<div class="detail-label">反馈主题</div>' +
                        '<div class="detail-value">' + escapeHtml(feedback.Subject) + '</div>' +
                        '</div>' +
                        '<div class="detail-group">' +
                        '<div class="detail-label">详细描述</div>' +
                        '<div class="detail-value">' + escapeHtml(feedback.Description) + '</div>' +
                        '</div>';
                    
                    document.getElementById('replyFeedbackInfo').innerHTML = infoHtml;
                    document.getElementById('replyModal').style.display = 'block';
                } else {
                    alert('加载反馈信息失败');
                }
            })
            .catch(err => {
                console.error('加载反馈信息出错', err);
                alert('加载反馈信息失败');
            });
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function closeReplyModal() {
            document.getElementById('replyModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailModal')) {
                closeDetailModal();
            }
            if (event.target == document.getElementById('replyModal')) {
                closeReplyModal();
            }
        }

        // Reply form submission
        document.getElementById('replyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const feedbackId = document.getElementById('replyFeedbackId').value;
            const status = document.getElementById('replyStatus').value;
            const reply = document.getElementById('replyContent').value.trim();

            if (!reply) {
                alert('请输入回复内容');
                return;
            }

            fetch('@Url.Action("UpdateFeedbackStatus", "Staff")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    feedbackId: parseInt(feedbackId),
                    status: status,
                    adminReply: reply
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('回复成功');
                    closeReplyModal();
                    loadFeedbacks();
                } else {
                    alert(data.message || '回复失败');
                }
            })
            .catch(err => {
                console.error('回复出错', err);
                alert('回复失败');
            });
        });

        // Contact user - initiate chat conversation
        function contactUser(userId) {
            if (!userId) {
                alert('无效的用户ID');
                return;
            }
            
            if (!confirm('确定要与用户 #' + userId + ' 开启对话吗？')) {
                return;
            }

            fetch('@Url.Action("InitiateContactFromFeedback", "Staff")', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ userId: userId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Redirect to UserContactManagement with the conversation
                    window.location.href = '@Url.Action("UserContactManagement", "Staff")' + '?userId=' + userId;
                } else {
                    alert(data.message || '开启对话失败');
                }
            })
            .catch(err => {
                console.error('开启对话出错', err);
                alert('开启对话失败');
            });
        }

        // Load feedbacks on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFeedbacks();
        });
    </script>
}
