@{
    ViewBag.Title = "日志管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<style>
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stats-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.3s;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .stats-number {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
    }

    .stats-label {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
    }

    .filter-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-group {
        display: inline-block;
        margin-right: 15px;
        margin-bottom: 10px;
    }

    .filter-group label {
        font-weight: 600;
        margin-right: 8px;
        color: #495057;
    }

    .filter-group select, .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background: white;
    }

    .log-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .log-table table {
        margin-bottom: 0;
    }

    .log-table thead {
        background: #f8f9fa;
    }

    .log-table th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 12px 15px;
    }

    .log-table td {
        padding: 12px 15px;
        vertical-align: middle;
    }

    .log-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-module {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-user { background-color: #17a2b8; color: white; }
    .badge-recycler { background-color: #28a745; color: white; }
    .badge-feedback { background-color: #ffc107; color: #000; }
    .badge-homepage { background-color: #6f42c1; color: white; }
    .badge-warehouse { background-color: #fd7e14; color: white; }
    .badge-admin { background-color: #e83e8c; color: white; }

    .badge-operation {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }

    .badge-view { background-color: #e9ecef; color: #495057; }
    .badge-create { background-color: #d4edda; color: #155724; }
    .badge-update { background-color: #fff3cd; color: #856404; }
    .badge-delete { background-color: #f8d7da; color: #721c24; }
    .badge-export { background-color: #cce5ff; color: #004085; }
    .badge-reply { background-color: #d1ecf1; color: #0c5460; }
    .badge-search { background-color: #e2e3e5; color: #383d41; }

    .badge-success { background-color: #28a745; color: white; }
    .badge-failed { background-color: #dc3545; color: white; }

    .btn-filter {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-filter:hover {
        background: #5568d3;
    }

    .btn-reset {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
    }

    .btn-reset:hover {
        background: #5a6268;
    }

    .btn-export {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        float: right;
    }

    .btn-export:hover {
        background: #218838;
    }

    .pagination-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="admin-header">
        <h2><i class="fas fa-history"></i> 日志管理</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">查看管理员操作日志记录</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row" id="statsCards">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="totalLogs">--</div>
                <div class="stats-label"><i class="fas fa-list"></i> 总日志数</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="todayLogs">--</div>
                <div class="stats-label"><i class="fas fa-calendar-day"></i> 今日操作</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="weekLogs">--</div>
                <div class="stats-label"><i class="fas fa-calendar-week"></i> 本周操作</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="moduleCount">7</div>
                <div class="stats-label"><i class="fas fa-cubes"></i> 监控模块</div>
            </div>
        </div>
    </div>

    <!-- Filter Box -->
    <div class="filter-box">
        <div class="filter-group">
            <label><i class="fas fa-cubes"></i> 模块：</label>
            <select id="moduleFilter">
                <option value="">全部模块</option>
                <option value="UserManagement">用户管理</option>
                <option value="RecyclerManagement">回收员管理</option>
                <option value="FeedbackManagement">反馈管理</option>
                <option value="HomepageManagement">首页页面管理</option>
                <option value="LogManagement">日志管理</option>
                <option value="WarehouseManagement">仓库管理</option>
                <option value="AdminManagement">管理员管理</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-cogs"></i> 操作类型：</label>
            <select id="operationTypeFilter">
                <option value="">全部操作</option>
                <option value="View">查看</option>
                <option value="Create">新增</option>
                <option value="Update">更新</option>
                <option value="Delete">删除</option>
                <option value="Export">导出</option>
                <option value="Reply">回复</option>
                <option value="Search">搜索</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-calendar"></i> 开始日期：</label>
            <input type="date" id="startDate" />
        </div>

        <div class="filter-group">
            <label><i class="fas fa-calendar"></i> 结束日期：</label>
            <input type="date" id="endDate" />
        </div>

        <div class="filter-group">
            <label><i class="fas fa-search"></i> 搜索：</label>
            <input type="text" id="searchInput" placeholder="管理员/描述/目标..." />
        </div>

        <br style="clear: both;" />
        <button class="btn-filter" onclick="loadLogs()"><i class="fas fa-filter"></i> 筛选</button>
        <button class="btn-reset" onclick="resetFilters()"><i class="fas fa-undo"></i> 重置</button>
        <button class="btn-export" onclick="exportLogs()"><i class="fas fa-download"></i> 导出日志</button>
    </div>

    <!-- Log Table -->
    <div class="log-table">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>操作时间</th>
                    <th>管理员</th>
                    <th>模块</th>
                    <th>操作类型</th>
                    <th>操作描述</th>
                    <th>目标</th>
                    <th>结果</th>
                    <th>IP地址</th>
                </tr>
            </thead>
            <tbody id="logTableBody">
                <tr>
                    <td colspan="9" class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>加载中...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <div class="row">
            <div class="col-md-6">
                <div id="paginationInfo"></div>
            </div>
            <div class="col-md-6 text-right">
                <ul class="pagination" id="pagination" style="margin: 0;"></ul>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
    var currentPage = 1;
    var pageSize = 20;

    $(document).ready(function() {
        loadStatistics();
        loadLogs();

        // Enter key search
        $('#searchInput').keypress(function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                loadLogs();
            }
        });
    });

    function loadStatistics() {
        $.ajax({
            url: '@Url.Action("GetLogStatistics", "Staff")',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#totalLogs').text(response.data.TotalLogs);
                    $('#todayLogs').text(response.data.TodayLogs);
                    $('#weekLogs').text(response.data.WeekLogs);
                }
            },
            error: function() {
                console.error('Failed to load statistics');
            }
        });
    }

    function loadLogs() {
        var module = $('#moduleFilter').val();
        var operationType = $('#operationTypeFilter').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var searchTerm = $('#searchInput').val();

        $.ajax({
            url: '@Url.Action("GetOperationLogs", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                page: currentPage,
                pageSize: pageSize,
                module: module,
                operationType: operationType,
                startDate: startDate,
                endDate: endDate,
                searchTerm: searchTerm
            },
            success: function(response) {
                if (response.success) {
                    displayLogs(response.data);
                } else {
                    $('#logTableBody').html('<tr><td colspan="9" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>' + (response.message || '加载失败') + '</p></td></tr>');
                }
            },
            error: function() {
                $('#logTableBody').html('<tr><td colspan="9" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>网络错误，请稍后重试</p></td></tr>');
            }
        });
    }

    function displayLogs(data) {
        if (!data.Items || data.Items.length === 0) {
            $('#logTableBody').html('<tr><td colspan="9" class="empty-state"><i class="fas fa-inbox"></i><p>暂无日志记录</p></td></tr>');
            $('#paginationInfo').html('');
            $('#pagination').empty();
            return;
        }

        var html = '';
        data.Items.forEach(function(log) {
            var moduleBadge = getModuleBadge(log.Module);
            var operationBadge = getOperationBadge(log.OperationType);
            var resultBadge;
            if (log.Result === 'Success') {
                resultBadge = '<span class="badge badge-success">成功</span>';
            } else if (log.Result === 'Failed') {
                resultBadge = '<span class="badge badge-failed">失败</span>';
            } else {
                resultBadge = '<span class="badge" style="background-color:#6c757d;color:white;">' + (log.Result || '-') + '</span>';
            }
            var operationTime = new Date(log.OperationTime).toLocaleString('zh-CN');

            html += '<tr>';
            html += '<td>' + log.LogID + '</td>';
            html += '<td>' + operationTime + '</td>';
            html += '<td>' + (log.AdminUsername || '-') + '</td>';
            html += '<td>' + moduleBadge + '</td>';
            html += '<td>' + operationBadge + '</td>';
            html += '<td class="description-cell" title="' + escapeHtml(log.Description || '') + '">' + (log.Description || '-') + '</td>';
            html += '<td>' + (log.TargetName || (log.TargetID ? 'ID: ' + log.TargetID : '-')) + '</td>';
            html += '<td>' + resultBadge + '</td>';
            html += '<td>' + (log.IPAddress || '-') + '</td>';
            html += '</tr>';
        });

        $('#logTableBody').html(html);
        renderPagination(data);
    }

    function getModuleBadge(module) {
        var displayName = '';
        var badgeClass = '';

        switch(module) {
            case 'UserManagement':
                displayName = '用户管理';
                badgeClass = 'badge-user';
                break;
            case 'RecyclerManagement':
                displayName = '回收员管理';
                badgeClass = 'badge-recycler';
                break;
            case 'FeedbackManagement':
                displayName = '反馈管理';
                badgeClass = 'badge-feedback';
                break;
            case 'HomepageManagement':
                displayName = '首页页面管理';
                badgeClass = 'badge-homepage';
                break;
            case 'LogManagement':
                displayName = '日志管理';
                badgeClass = 'badge-user';
                break;
            case 'WarehouseManagement':
                displayName = '仓库管理';
                badgeClass = 'badge-warehouse';
                break;
            case 'AdminManagement':
                displayName = '管理员管理';
                badgeClass = 'badge-admin';
                break;
            default:
                displayName = module;
                badgeClass = '';
        }

        return '<span class="badge-module ' + badgeClass + '">' + displayName + '</span>';
    }

    function getOperationBadge(operationType) {
        var displayName = '';
        var badgeClass = '';

        switch(operationType) {
            case 'View':
                displayName = '查看';
                badgeClass = 'badge-view';
                break;
            case 'Create':
                displayName = '新增';
                badgeClass = 'badge-create';
                break;
            case 'Update':
                displayName = '更新';
                badgeClass = 'badge-update';
                break;
            case 'Delete':
                displayName = '删除';
                badgeClass = 'badge-delete';
                break;
            case 'Export':
                displayName = '导出';
                badgeClass = 'badge-export';
                break;
            case 'Reply':
                displayName = '回复';
                badgeClass = 'badge-reply';
                break;
            case 'Search':
                displayName = '搜索';
                badgeClass = 'badge-search';
                break;
            default:
                displayName = operationType;
                badgeClass = '';
        }

        return '<span class="badge-operation ' + badgeClass + '">' + displayName + '</span>';
    }

    function renderPagination(data) {
        var pagination = $('#pagination');
        pagination.empty();

        $('#paginationInfo').html('显示 ' + ((data.PageIndex - 1) * data.PageSize + 1) + ' - ' + Math.min(data.PageIndex * data.PageSize, data.TotalCount) + ' 条，共 ' + data.TotalCount + ' 条');

        if (data.TotalPages <= 1) return;

        // Previous
        pagination.append('<li class="' + (data.PageIndex == 1 ? 'disabled' : '') + '"><a href="#" onclick="goToPage(' + (data.PageIndex - 1) + '); return false;">上一页</a></li>');

        // Page numbers
        var startPage = Math.max(1, data.PageIndex - 2);
        var endPage = Math.min(data.TotalPages, data.PageIndex + 2);

        for (var i = startPage; i <= endPage; i++) {
            pagination.append('<li class="' + (i == data.PageIndex ? 'active' : '') + '"><a href="#" onclick="goToPage(' + i + '); return false;">' + i + '</a></li>');
        }

        // Next
        pagination.append('<li class="' + (data.PageIndex >= data.TotalPages ? 'disabled' : '') + '"><a href="#" onclick="goToPage(' + (data.PageIndex + 1) + '); return false;">下一页</a></li>');
    }

    function goToPage(page) {
        currentPage = page;
        loadLogs();
        window.scrollTo(0, 0);
    }

    function resetFilters() {
        $('#moduleFilter').val('');
        $('#operationTypeFilter').val('');
        $('#startDate').val('');
        $('#endDate').val('');
        $('#searchInput').val('');
        currentPage = 1;
        loadLogs();
    }

    function exportLogs() {
        var module = $('#moduleFilter').val();
        var operationType = $('#operationTypeFilter').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var searchTerm = $('#searchInput').val();

        var url = '@Url.Action("ExportOperationLogs", "Staff")';
        var params = [];

        if (module) params.push('module=' + encodeURIComponent(module));
        if (operationType) params.push('operationType=' + encodeURIComponent(operationType));
        if (startDate) params.push('startDate=' + encodeURIComponent(startDate));
        if (endDate) params.push('endDate=' + encodeURIComponent(endDate));
        if (searchTerm) params.push('searchTerm=' + encodeURIComponent(searchTerm));

        if (params.length > 0) {
            url += '?' + params.join('&');
        }

        window.location.href = url;
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }
</script>
}
