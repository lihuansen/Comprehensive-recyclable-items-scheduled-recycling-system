@{
    ViewBag.Title = "运输人员管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .stats-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; transition: transform 0.3s; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .stats-number { font-size: 32px; font-weight: bold; color: #667eea; }
    .stats-label { color: #666; font-size: 14px; margin-top: 5px; }
    .search-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .data-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .data-table table { margin-bottom: 0; }
    .data-table thead { background: #f8f9fa; }
    .data-table th { border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; }
    .data-table tbody tr:hover { background-color: #f8f9fa; }
    .badge-active { background-color: #28a745; }
    .badge-inactive { background-color: #6c757d; }
    .badge-available { background-color: #17a2b8; }
    .badge-unavailable { background-color: #ffc107; }
    .btn-action { margin: 0 2px; }
    .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
</style>

<div class="container-fluid">
    <div class="admin-header">
        <h2><i class="fas fa-truck-moving"></i> 运输人员管理</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">管理运输人员账号、查看运输人员信息</p>
    </div>

    <!-- 统计卡片 -->
    <div class="row" id="statsCards">
        <div class="col-md-4">
            <div class="stats-card text-center">
                <div class="stats-number" id="totalTransporters">--</div>
                <div class="stats-label"><i class="fas fa-users"></i> 总运输人员数</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <div class="stats-number" id="activeTransporters">--</div>
                <div class="stats-label"><i class="fas fa-user-check"></i> 激活运输人员</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <div class="stats-number" id="availableTransporters">--</div>
                <div class="stats-label"><i class="fas fa-user-clock"></i> 可接单</div>
            </div>
        </div>
    </div>

    <!-- 操作按钮行 -->
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-md-12">
            <button class="btn btn-success" onclick="showAddModal()">
                <i class="fas fa-plus"></i> 添加运输人员
            </button>
        </div>
    </div>

    <div class="search-box">
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名、姓名、手机号或区域...">
            </div>
            <div class="col-md-3">
                <select class="form-control" id="statusFilter">
                    <option value="">全部状态</option>
                    <option value="true">激活</option>
                    <option value="false">禁用</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-block" onclick="searchTransporters()">
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-info btn-block" onclick="exportTransporters()">
                    <i class="fas fa-download"></i> 导出数据
                </button>
            </div>
        </div>
    </div>

    <div class="data-table">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>区域</th>
                    <th>评分</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="8" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container" style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
        <div class="row">
            <div class="col-md-6"><div id="paginationInfo"></div></div>
            <div class="col-md-6 text-right"><ul class="pagination" id="pagination" style="margin: 0;"></ul></div>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="transporterModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="modalTitle">添加运输人员</h4>
            </div>
            <div class="modal-body">
                <form id="transporterForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="transporterId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>用户名 *</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" id="passwordGroup">
                                <label>密码 *</label>
                                <input type="password" class="form-control" id="password">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>姓名</label>
                                <input type="text" class="form-control" id="fullName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>手机号 *</label>
                                <input type="text" class="form-control" id="phoneNumber" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>身份证号</label>
                                <input type="text" class="form-control" id="idNumber">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>驾驶证号</label>
                                <input type="text" class="form-control" id="licenseNumber">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>区域 *</label>
                                <select class="form-control" id="region" required>
                                    <option value="">请选择区域</option>
                                    <option value="广东省深圳市罗湖区清水河街道">广东省深圳市罗湖区清水河街道</option>
                                    <option value="广东省深圳市罗湖区东门街道">广东省深圳市罗湖区东门街道</option>
                                    <option value="广东省深圳市罗湖区南湖街道">广东省深圳市罗湖区南湖街道</option>
                                    <option value="广东省深圳市罗湖区桂园街道">广东省深圳市罗湖区桂园街道</option>
                                    <option value="广东省深圳市罗湖区黄贝街道">广东省深圳市罗湖区黄贝街道</option>
                                    <option value="广东省深圳市罗湖区东湖街道">广东省深圳市罗湖区东湖街道</option>
                                    <option value="广东省深圳市罗湖区翠竹街道">广东省深圳市罗湖区翠竹街道</option>
                                    <option value="广东省深圳市罗湖区莲塘街道">广东省深圳市罗湖区莲塘街道</option>
                                    <option value="广东省深圳市罗湖区东晓街道">广东省深圳市罗湖区东晓街道</option>
                                    <option value="广东省深圳市罗湖区笋岗街道">广东省深圳市罗湖区笋岗街道</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>当前状态</label>
                                <select class="form-control" id="currentStatus">
                                    <option value="空闲">空闲</option>
                                    <option value="运输中">运输中</option>
                                    <option value="休息">休息</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" style="margin-top: 25px;">
                                <label><input type="checkbox" id="available" checked> 可接单</label>
                                &nbsp;&nbsp;&nbsp;
                                <label><input type="checkbox" id="isActive" checked> 激活状态</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveTransporter()">保存</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
var currentPage = 1, pageSize = 20, searchTerm = '', statusFilter = null;
var transporterCache = {}; // Cache for transporter data

// Helper function to escape HTML and prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

$(document).ready(function () {
    loadStatistics();
    loadTransporters();
});

function loadStatistics() {
    $.ajax({
        url: '@Url.Action("GetTransporterStatistics", "Staff")',
        type: 'GET',
        success: function (response) {
            if (response.success) {
                $('#totalTransporters').text(response.data.TotalTransporters);
                $('#activeTransporters').text(response.data.ActiveTransporters);
                $('#availableTransporters').text(response.data.AvailableTransporters);
            }
        }
    });
}

function loadTransporters() {
    $.ajax({
        url: '@Url.Action("GetTransporters", "Staff")',
        type: 'GET',
        data: { page: currentPage, pageSize: pageSize, searchTerm: searchTerm, isActive: statusFilter },
        success: function (response) {
            if (response.success) renderTransporters(response.data);
            else alert('加载失败: ' + response.message);
        }
    });
}

function renderTransporters(data) {
    var tbody = $('#tableBody');
    tbody.empty();
    if (data.Items.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center">没有找到运输人员</td></tr>');
        return;
    }
    data.Items.forEach(function (t) {
        var row = '<tr>' +
            '<td>' + t.TransporterID + '</td>' +
            '<td>' + escapeHtml(t.Username) + '</td>' +
            '<td>' + escapeHtml(t.FullName || '-') + '</td>' +
            '<td>' + escapeHtml(t.PhoneNumber) + '</td>' +
            '<td>' + escapeHtml(t.Region) + '</td>' +
            '<td>' + (t.Rating ? t.Rating.toFixed(1) : '0.0') + ' ⭐</td>' +
            '<td>' +
                '<span class="badge ' + (t.IsActive ? 'badge-active' : 'badge-inactive') + '">' + (t.IsActive ? '激活' : '禁用') + '</span> ' +
                '<span class="badge ' + (t.Available ? 'badge-available' : 'badge-unavailable') + '">' + (t.Available ? '可接单' : '不可接单') + '</span>' +
            '</td>' +
            '<td>' +
                '<button class="btn btn-xs btn-info btn-action" data-transporter-id="' + t.TransporterID + '" onclick="editTransporterById(this)"><i class="fas fa-edit"></i> 编辑</button> ' +
                '<button class="btn btn-xs btn-danger btn-action" onclick="deleteTransporter(' + t.TransporterID + ')"><i class="fas fa-trash"></i> 删除</button>' +
            '</td>' +
        '</tr>';
        // Store full transporter object for later retrieval
        transporterCache[t.TransporterID] = t;
        tbody.append(row);
    });
    renderPagination(data);
}

function renderPagination(data) {
    var pagination = $('#pagination');
    pagination.empty();
    $('#paginationInfo').html('显示 ' + ((data.PageIndex - 1) * data.PageSize + 1) + ' - ' + Math.min(data.PageIndex * data.PageSize, data.TotalCount) + ' 条，共 ' + data.TotalCount + ' 条');
    if (data.TotalPages <= 1) return;
    pagination.append('<li class="' + (data.PageIndex == 1 ? 'disabled' : '') + '"><a href="#" onclick="goToPage(' + (data.PageIndex - 1) + '); return false;">上一页</a></li>');
    var startPage = Math.max(1, data.PageIndex - 2), endPage = Math.min(data.TotalPages, data.PageIndex + 2);
    for (var i = startPage; i <= endPage; i++) {
        pagination.append('<li class="' + (i == data.PageIndex ? 'active' : '') + '"><a href="#" onclick="goToPage(' + i + '); return false;">' + i + '</a></li>');
    }
    pagination.append('<li class="' + (data.PageIndex >= data.TotalPages ? 'disabled' : '') + '"><a href="#" onclick="goToPage(' + (data.PageIndex + 1) + '); return false;">下一页</a></li>');
}

function goToPage(page) { currentPage = page; loadTransporters(); }
function searchTransporters() { searchTerm = $('#searchInput').val(); statusFilter = $('#statusFilter').val() || null; currentPage = 1; loadTransporters(); }

function showAddModal() {
    $('#modalTitle').text('添加运输人员');
    $('#transporterForm')[0].reset();
    $('#transporterId').val('');
    $('#passwordGroup').show();
    $('#transporterModal').modal('show');
}

function editTransporterById(btn) {
    var id = $(btn).data('transporter-id');
    var transporter = transporterCache[id];
    if (transporter) {
        editTransporter(transporter);
    }
}

function editTransporter(transporter) {
    $('#modalTitle').text('编辑运输人员');
    $('#transporterId').val(transporter.TransporterID);
    $('#username').val(transporter.Username);
    $('#fullName').val(transporter.FullName);
    $('#phoneNumber').val(transporter.PhoneNumber);
    $('#idNumber').val(transporter.IDNumber);
    $('#licenseNumber').val(transporter.LicenseNumber);
    $('#region').val(transporter.Region);
    $('#currentStatus').val(transporter.CurrentStatus);
    $('#available').prop('checked', transporter.Available);
    $('#isActive').prop('checked', transporter.IsActive);
    $('#passwordGroup').hide();
    $('#transporterModal').modal('show');
}

function saveTransporter() {
    var id = $('#transporterId').val();
    var data = {
        TransporterID: id || 0,
        Username: $('#username').val(),
        PhoneNumber: $('#phoneNumber').val(),
        FullName: $('#fullName').val(),
        IDNumber: $('#idNumber').val(),
        LicenseNumber: $('#licenseNumber').val(),
        Region: $('#region').val(),
        CurrentStatus: $('#currentStatus').val(),
        Available: $('#available').is(':checked'),
        IsActive: $('#isActive').is(':checked')
    };
    
    // Only include password when adding (not editing)
    if (!id) {
        data.password = $('#password').val();
    }
    
    data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
    
    $.ajax({
        url: id ? '@Url.Action("UpdateTransporter", "Staff")' : '@Url.Action("AddTransporter", "Staff")',
        type: 'POST',
        data: data,
        success: function (response) {
            alert(response.message);
            if (response.success) {
                $('#transporterModal').modal('hide');
                loadTransporters();
                loadStatistics();
            }
        }
    });
}

function deleteTransporter(id) {
    if (!confirm('确定要删除此运输人员吗？')) return;
    $.ajax({
        url: '@Url.Action("DeleteTransporter", "Staff")',
        type: 'POST',
        data: { 
            transporterId: id,
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        },
        success: function (response) {
            alert(response.message);
            if (response.success) {
                loadTransporters();
                loadStatistics();
            }
        }
    });
}

function exportTransporters() {
    var url = '@Url.Action("ExportTransporters", "Staff")';
    var params = [];
    
    if (searchTerm) {
        params.push('searchTerm=' + encodeURIComponent(searchTerm));
    }
    if (statusFilter !== null) {
        params.push('isActive=' + statusFilter);
    }
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    window.location.href = url;
}
</script>
}
