@{
    ViewBag.Title = "订单管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .admin-header { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .stats-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; transition: transform 0.3s; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .stats-number { font-size: 32px; font-weight: bold; color: #43e97b; }
    .stats-label { color: #666; font-size: 14px; margin-top: 5px; }
    .search-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .order-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .order-table table { margin-bottom: 0; }
    .order-table thead { background: #f8f9fa; }
    .order-table th { border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; }
    .order-table tbody tr:hover { background-color: #f8f9fa; }
    .badge-pending { background-color: #ffc107; }
    .badge-in-progress { background-color: #17a2b8; }
    .badge-completed { background-color: #28a745; }
    .badge-cancelled { background-color: #dc3545; }
    .modal-header { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
</style>

<div class="container-fluid">
    <div class="admin-header">
        <h2><i class="fas fa-clipboard-list"></i> 订单管理</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">查看和管理所有回收订单</p>
    </div>

    <div class="row" id="statsCards">
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="totalOrders">--</div>
                <div class="stats-label"><i class="fas fa-file-alt"></i> 总订单数</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="completedOrders">--</div>
                <div class="stats-label"><i class="fas fa-check-circle"></i> 已完成</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="pendingOrders">--</div>
                <div class="stats-label"><i class="fas fa-clock"></i> 待接单</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="inProgressOrders">--</div>
                <div class="stats-label"><i class="fas fa-spinner"></i> 进行中</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="ordersThisMonth">--</div>
                <div class="stats-label"><i class="fas fa-calendar-alt"></i> 本月订单</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="totalWeight">--</div>
                <div class="stats-label"><i class="fas fa-weight"></i> 总重量(kg)</div>
            </div>
        </div>
    </div>

    <div class="search-box">
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名、回收员、联系人...">
            </div>
            <div class="col-md-3">
                <select class="form-control" id="statusFilter">
                    <option value="">全部状态</option>
                    <option value="待接单">待接单</option>
                    <option value="进行中">进行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-block" onclick="searchOrders()">
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-success btn-block" onclick="exportOrders()">
                    <i class="fas fa-file-excel"></i> 导出Excel
                </button>
            </div>
        </div>
    </div>

    <div class="order-table">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>订单ID</th>
                    <th>类型</th>
                    <th>用户</th>
                    <th>回收员</th>
                    <th>预约日期</th>
                    <th>重量(kg)</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
                <tr>
                    <td colspan="8" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container" style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
        <div class="row">
            <div class="col-md-6"><div id="paginationInfo"></div></div>
            <div class="col-md-6 text-right"><ul class="pagination" id="pagination" style="margin: 0;"></ul></div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">订单详情</h4>
            </div>
            <div class="modal-body" id="orderDetailContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
var currentPage = 1, pageSize = 20, searchTerm = '', statusFilter = '';

$(document).ready(function () {
    loadStatistics();
    loadOrders();
});

function loadStatistics() {
    $.ajax({
        url: '@Url.Action("GetOrderStatistics", "Staff")',
        type: 'GET',
        success: function (response) {
            if (response.success) {
                $('#totalOrders').text(response.data.TotalOrders);
                $('#completedOrders').text(response.data.CompletedOrders);
                $('#pendingOrders').text(response.data.PendingOrders);
                $('#inProgressOrders').text(response.data.InProgressOrders);
                $('#ordersThisMonth').text(response.data.OrdersThisMonth);
                $('#totalWeight').text(parseFloat(response.data.TotalWeightCollected).toFixed(1));
            }
        }
    });
}

function loadOrders() {
    $.ajax({
        url: '@Url.Action("GetOrders", "Staff")',
        type: 'GET',
        data: { page: currentPage, pageSize: pageSize, status: statusFilter, searchTerm: searchTerm },
        success: function (response) {
            if (response.success) renderOrders(response.data);
            else alert('加载失败: ' + response.message);
        }
    });
}

function renderOrders(data) {
    var tbody = $('#orderTableBody');
    tbody.empty();
    if (data.Items.length === 0) {
        tbody.append('<tr><td colspan="8" class="text-center">没有找到订单</td></tr>');
        return;
    }
    data.Items.forEach(function (order) {
        var statusBadge = '';
        if (order.Status === '待接单') statusBadge = '<span class="badge badge-pending">待接单</span>';
        else if (order.Status === '进行中') statusBadge = '<span class="badge badge-in-progress">进行中</span>';
        else if (order.Status === '已完成') statusBadge = '<span class="badge badge-completed">已完成</span>';
        else if (order.Status === '已取消') statusBadge = '<span class="badge badge-cancelled">已取消</span>';
        else statusBadge = '<span class="badge badge-default">' + order.Status + '</span>';

        var row = `<tr>
            <td>${order.AppointmentID}</td>
            <td>${order.AppointmentType}</td>
            <td>${order.UserUsername}</td>
            <td>${order.RecyclerFullName || order.RecyclerUsername || '未分配'}</td>
            <td>${formatDate(order.AppointmentDate)}</td>
            <td>${order.EstimatedWeight}</td>
            <td>${statusBadge}</td>
            <td><button class="btn btn-xs btn-info" onclick='showOrderDetail(${JSON.stringify(order)})'><i class="fas fa-eye"></i> 详情</button></td>
        </tr>`;
        tbody.append(row);
    });
    renderPagination(data);
}

function showOrderDetail(order) {
    var content = `
        <div class="row">
            <div class="col-md-6">
                <h4><i class="fas fa-info-circle"></i> 订单信息</h4>
                <table class="table table-bordered">
                    <tr><td><strong>订单ID:</strong></td><td>${order.AppointmentID}</td></tr>
                    <tr><td><strong>类型:</strong></td><td>${order.AppointmentType}</td></tr>
                    <tr><td><strong>日期:</strong></td><td>${formatDate(order.AppointmentDate)}</td></tr>
                    <tr><td><strong>时间段:</strong></td><td>${order.TimeSlot}</td></tr>
                    <tr><td><strong>预估重量:</strong></td><td>${order.EstimatedWeight} kg</td></tr>
                    <tr><td><strong>预估价格:</strong></td><td>${order.EstimatedPrice || '未估价'} 元</td></tr>
                    <tr><td><strong>紧急:</strong></td><td>${order.IsUrgent ? '是' : '否'}</td></tr>
                    <tr><td><strong>状态:</strong></td><td>${order.Status}</td></tr>
                    <tr><td><strong>创建时间:</strong></td><td>${formatDateTime(order.CreatedDate)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h4><i class="fas fa-user"></i> 用户信息</h4>
                <table class="table table-bordered">
                    <tr><td><strong>用户ID:</strong></td><td>${order.UserID}</td></tr>
                    <tr><td><strong>用户名:</strong></td><td>${order.UserUsername}</td></tr>
                    <tr><td><strong>邮箱:</strong></td><td>${order.UserEmail}</td></tr>
                    <tr><td><strong>电话:</strong></td><td>${order.UserPhone}</td></tr>
                </table>
                <h4><i class="fas fa-truck"></i> 回收员信息</h4>
                <table class="table table-bordered">
                    <tr><td><strong>回收员ID:</strong></td><td>${order.RecyclerID || '未分配'}</td></tr>
                    <tr><td><strong>用户名:</strong></td><td>${order.RecyclerUsername || '未分配'}</td></tr>
                    <tr><td><strong>姓名:</strong></td><td>${order.RecyclerFullName || '未分配'}</td></tr>
                    <tr><td><strong>电话:</strong></td><td>${order.RecyclerPhone || '未分配'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h4><i class="fas fa-map-marker-alt"></i> 地址信息</h4>
                <table class="table table-bordered">
                    <tr><td><strong>地址:</strong></td><td>${order.Address}</td></tr>
                    <tr><td><strong>联系人:</strong></td><td>${order.ContactName}</td></tr>
                    <tr><td><strong>联系电话:</strong></td><td>${order.ContactPhone}</td></tr>
                </table>
            </div>
        </div>
    `;
    $('#orderDetailContent').html(content);
    $('#orderDetailModal').modal('show');
}

function renderPagination(data) {
    var pagination = $('#pagination');
    pagination.empty();
    $('#paginationInfo').html(`显示 ${(data.PageNumber - 1) * data.PageSize + 1} - ${Math.min(data.PageNumber * data.PageSize, data.TotalCount)} 条，共 ${data.TotalCount} 条`);
    if (data.TotalPages <= 1) return;
    pagination.append(`<li class="${data.PageNumber == 1 ? 'disabled' : ''}"><a href="#" onclick="goToPage(${data.PageNumber - 1}); return false;">上一页</a></li>`);
    var startPage = Math.max(1, data.PageNumber - 2), endPage = Math.min(data.TotalPages, data.PageNumber + 2);
    for (var i = startPage; i <= endPage; i++) {
        pagination.append(`<li class="${i == data.PageNumber ? 'active' : ''}"><a href="#" onclick="goToPage(${i}); return false;">${i}</a></li>`);
    }
    pagination.append(`<li class="${data.PageNumber >= data.TotalPages ? 'disabled' : ''}"><a href="#" onclick="goToPage(${data.PageNumber + 1}); return false;">下一页</a></li>`);
}

function goToPage(page) { currentPage = page; loadOrders(); window.scrollTo(0, 0); }
function searchOrders() { searchTerm = $('#searchInput').val(); statusFilter = $('#statusFilter').val(); currentPage = 1; loadOrders(); }
function exportOrders() { alert('导出功能开发中...'); }

function formatDate(dateString) {
    var date = new Date(dateString);
    return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
}

function formatDateTime(dateString) {
    var date = new Date(dateString);
    return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0') + ' ' +
           String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
}
</script>
}
