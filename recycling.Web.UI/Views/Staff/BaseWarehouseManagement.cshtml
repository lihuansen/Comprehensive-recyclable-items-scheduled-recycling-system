@model recycling.Model.BaseWarehouseManagementViewModel
@{
    ViewBag.Title = "仓库管理";
    Layout = "~/Views/Shared/_SortingCenterWorkerLayout.cshtml";
}

@Html.AntiForgeryToken()

<style>
    .warehouse-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .page-title i {
        margin-right: 15px;
        color: #27ae60;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .section-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
    }

    .btn-primary {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #229954;
    }

    .btn-secondary {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #2980b9;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #27ae60;
    }

    .receipts-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .receipts-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        font-size: 14px;
    }

    .receipts-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #555;
        font-size: 14px;
    }

    .receipts-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-completed {
        background: #d4edda;
        color: #155724;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #bdc3c7;
    }

    .loading-spinner {
        text-align: center;
        padding: 30px;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #27ae60;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .transit-orders-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .transit-order-item {
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .transit-order-item:hover {
        border-color: #27ae60;
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
    }

    .transit-order-item.selected {
        border-color: #27ae60;
        background: #f0f8f4;
    }

    .order-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .order-number {
        font-weight: bold;
        color: #2c3e50;
    }

    .order-weight {
        color: #27ae60;
        font-weight: 600;
    }

    .order-details {
        font-size: 13px;
        color: #7f8c8d;
    }

    @@media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="warehouse-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-box-open"></i>
            仓库管理
        </h1>
    </div>

    <div class="content-grid">
        <!-- 左侧：创建入库单 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">创建入库单</h2>
                <button class="btn-secondary" onclick="refreshTransitOrders()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="transitOrdersLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="transitOrdersList" class="transit-orders-list">
                @if (Model != null && Model.CompletedTransportOrders != null && Model.CompletedTransportOrders.Any())
                {
                    foreach (var order in Model.CompletedTransportOrders)
                    {
                        <div class="transit-order-item" 
                             data-order-id="@order.TransportOrderID" 
                             data-order-number="@order.OrderNumber" 
                             data-estimated-weight="@order.EstimatedWeight" 
                             data-item-categories="@(order.ItemCategories ?? "")" 
                             data-recycler-name="@(order.RecyclerName ?? "")"
                             data-transporter-name="@(order.TransporterName ?? "")"
                             data-pickup-date="@(order.PickupDate?.ToString("yyyy-MM-dd HH:mm") ?? "")"
                             onclick="selectOrder(this)">
                            <div class="order-info">
                                <span class="order-number">@order.OrderNumber</span>
                                <span class="order-weight">@order.EstimatedWeight.ToString("F2") kg</span>
                            </div>
                            <div class="order-details">
                                回收员：@(order.RecyclerName ?? "-") | 运输人员：@(order.TransporterName ?? "-")
                            </div>
                            @if (order.PickupDate.HasValue)
                            {
                                <div style="font-size: 12px; color: #777; margin-top: 5px;">
                                    取货时间：@order.PickupDate.Value.ToString("yyyy-MM-dd HH:mm")
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无可入库的运输单</p>
                    </div>
                }
            </div>

            <div id="receiptForm" style="display: none;">
                <form id="createReceiptForm">
                    <input type="hidden" id="selectedTransportOrderId" />
                    
                    <div class="form-group">
                        <label class="form-label">运输单号</label>
                        <input type="text" class="form-control" id="orderNumberDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">回收员</label>
                        <input type="text" class="form-control" id="recyclerNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">运输人员</label>
                        <input type="text" class="form-control" id="transporterNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">取货时间</label>
                        <input type="text" class="form-control" id="pickupDateDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">预估重量（kg）</label>
                        <input type="text" class="form-control" id="estimatedWeightDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">实际入库重量（kg）<span style="color: red;">*</span></label>
                        <input type="number" class="form-control" id="totalWeight" step="0.01" required 
                               placeholder="请输入实际称重后的重量" />
                        <small style="color: #666;">提示：可以修改为实际称重重量</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">物品类别明细</label>
                        <div id="categoriesPreview" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 50px;">
                            <small style="color: #666;">从运输单自动获取</small>
                        </div>
                        <textarea class="form-control" id="itemCategories" rows="4" 
                                  placeholder='JSON格式：[{"categoryKey":"paper","categoryName":"纸类","weight":20.5,"price":41.0}]'></textarea>
                        <small style="color: #666;">提示：系统已自动填充，如需调整请修改上方JSON数据</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">入库备注</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="如：物品完好无损、包装完整等"></textarea>
                    </div>

                    <div style="text-align: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <button type="button" class="btn-primary" onclick="createReceipt()">
                            <i class="fas fa-plus-circle"></i> 创建入库单
                        </button>
                        <button type="button" class="btn-secondary" onclick="cancelSelection()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右侧：入库单列表 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">入库记录</h2>
                <button class="btn-secondary" onclick="loadWarehouseReceipts()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="receiptsLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="receiptsTableContainer">
                @if (Model != null && Model.WarehouseReceipts != null && Model.WarehouseReceipts.Any())
                {
                    <table class="receipts-table" id="receiptsTable">
                        <thead>
                            <tr>
                                <th>入库单号</th>
                                <th>运输单号</th>
                                <th>回收员</th>
                                <th>重量(kg)</th>
                                <th>入库时间</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsTableBody">
                            @foreach (var receipt in Model.WarehouseReceipts)
                            {
                                <tr>
                                    <td>@receipt.ReceiptNumber</td>
                                    <td>@(receipt.TransportOrderNumber ?? "-")</td>
                                    <td>@(receipt.RecyclerName ?? "-")</td>
                                    <td>@receipt.TotalWeight.ToString("F2")</td>
                                    <td>@receipt.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td><span class="status-badge status-completed">@receipt.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div id="receiptsEmptyState" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无入库记录</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    var selectedOrderId = null;

    // 注意：页面加载时数据已通过服务器端渲染直接显示，无需自动调用 AJAX
    // Note: Data is rendered server-side on page load, no need to call AJAX automatically
    // 
    // 下面的 AJAX 函数仅在用户手动点击"刷新"按钮时调用
    // The AJAX functions below are only called when user clicks the "Refresh" buttons

    // 加载已完成的运输单（仅用于手动刷新）
    // Load completed transport orders (only for manual refresh)
    function loadCompletedTransportOrders() {
        $('#transitOrdersLoading').show();
        $('#transitOrdersList').hide().html('');

        $.ajax({
            url: '@Url.Action("GetCompletedTransportOrders", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayTransitOrders(response.data);
                } else {
                    $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p></div>').show();
                }
            },
            error: function () {
                $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>加载失败</p></div>').show();
            },
            complete: function () {
                $('#transitOrdersLoading').hide();
            }
        });
    }

    // 显示运输单列表
    function displayTransitOrders(orders) {
        if (orders && orders.length > 0) {
            var html = '';
            orders.forEach(function (order) {
                html += '<div class="transit-order-item" data-order-id="' + order.TransportOrderID + '" ' +
                    'data-order-number="' + order.OrderNumber + '" ' +
                    'data-estimated-weight="' + order.EstimatedWeight + '" ' +
                    'data-item-categories="' + (order.ItemCategories || '') + '" ' +
                    'data-recycler-name="' + (order.RecyclerName || '') + '" ' +
                    'data-transporter-name="' + (order.TransporterName || '') + '" ' +
                    'data-pickup-date="' + (order.PickupDate || '') + '" ' +
                    'onclick="selectOrder(this)">' +
                    '<div class="order-info">' +
                    '<span class="order-number">' + order.OrderNumber + '</span>' +
                    '<span class="order-weight">' + order.EstimatedWeight.toFixed(2) + ' kg</span>' +
                    '</div>' +
                    '<div class="order-details">' +
                    '回收员：' + (order.RecyclerName || '-') + ' | ' +
                    '运输人员：' + (order.TransporterName || '-') +
                    '</div>';
                
                if (order.PickupDate) {
                    html += '<div style="font-size: 12px; color: #777; margin-top: 5px;">取货时间：' + order.PickupDate + '</div>';
                }
                
                html += '</div>';
            });
            $('#transitOrdersList').html(html).show();
        } else {
            $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无可入库的运输单</p></div>').show();
        }
    }

    // 选择运输单
    function selectOrder(element) {
        // 检查是否已创建入库单
        var orderId = $(element).data('order-id');
        
        $.ajax({
            url: '@Url.Action("CheckWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    if (response.hasReceipt) {
                        alert('该运输单已创建入库单');
                        return;
                    }
                    
                    // 未创建入库单，可以继续
                    $('.transit-order-item').removeClass('selected');
                    $(element).addClass('selected');

                    selectedOrderId = orderId;
                    
                    // 填充表单数据（自动从运输单获取）
                    $('#selectedTransportOrderId').val(orderId);
                    $('#orderNumberDisplay').val($(element).data('order-number'));
                    $('#recyclerNameDisplay').val($(element).data('recycler-name') || '未知');
                    $('#transporterNameDisplay').val($(element).data('transporter-name') || '未知');
                    $('#pickupDateDisplay').val($(element).data('pickup-date') || '未记录');
                    
                    var estimatedWeight = $(element).data('estimated-weight');
                    $('#estimatedWeightDisplay').val(estimatedWeight);
                    $('#totalWeight').val(estimatedWeight); // 默认使用预估重量，可修改
                    
                    var itemCategories = $(element).data('item-categories') || '';
                    $('#itemCategories').val(itemCategories);
                    
                    // 解析并显示类别预览
                    displayCategoriesPreview(itemCategories);

                    $('#transitOrdersList').hide();
                    $('#receiptForm').show();
                } else {
                    alert('检查失败：' + response.message);
                }
            },
            error: function () {
                alert('网络错误');
            }
        });
    }

    // 显示物品类别预览
    function displayCategoriesPreview(categoriesJson) {
        var preview = $('#categoriesPreview');
        
        if (!categoriesJson || categoriesJson.trim() === '') {
            preview.html('<small style="color: #999;">无类别信息</small>');
            return;
        }
        
        try {
            var categories = JSON.parse(categoriesJson);
            if (!Array.isArray(categories) || categories.length === 0) {
                preview.html('<small style="color: #999;">无类别信息</small>');
                return;
            }
            
            var html = '<div style="font-size: 13px;">';
            var totalWeight = 0;
            
            categories.forEach(function(cat, index) {
                var weight = parseFloat(cat.weight || 0);
                totalWeight += weight;
                
                html += '<div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0;">';
                html += '<strong>' + (cat.categoryName || '未知类别') + '</strong>: ';
                html += weight.toFixed(2) + ' kg';
                
                if (cat.price) {
                    html += ' (价值: ¥' + parseFloat(cat.price).toFixed(2) + ')';
                }
                html += '</div>';
            });
            
            html += '<div style="padding: 8px 0; font-weight: bold; color: #27ae60;">总重量: ' + totalWeight.toFixed(2) + ' kg</div>';
            html += '</div>';
            
            preview.html(html);
        } catch (e) {
            preview.html('<small style="color: #e74c3c;">类别数据格式错误</small>');
        }
    }

    // 取消选择
    function cancelSelection() {
        selectedOrderId = null;
        $('#receiptForm').hide();
        $('#transitOrdersList').show();
        $('.transit-order-item').removeClass('selected');
        $('#createReceiptForm')[0].reset();
        $('#categoriesPreview').html('<small style="color: #666;">从运输单自动获取</small>');
    }

    // 创建入库单
    function createReceipt() {
        var orderId = $('#selectedTransportOrderId').val();
        var weight = $('#totalWeight').val();
        var categories = $('#itemCategories').val();
        var notes = $('#notes').val();

        if (!orderId || !weight || weight <= 0) {
            alert('请填写完整信息');
            return;
        }

        $.ajax({
            url: '@Url.Action("CreateWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                totalWeight: weight,
                itemCategories: categories,
                notes: notes,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    alert('入库成功！入库单号：' + response.receiptNumber);
                    cancelSelection();
                    loadCompletedTransportOrders();
                    loadWarehouseReceipts();
                } else {
                    alert('入库失败：' + response.message);
                }
            },
            error: function () {
                alert('网络错误，请稍后重试');
            }
        });
    }

    // 加载入库记录（仅用于手动刷新）
    // Load warehouse receipts (only for manual refresh)
    function loadWarehouseReceipts() {
        $('#receiptsLoading').show();
        $('#receiptsTableContainer').hide();
        $('#receiptsTable').hide();
        $('#receiptsEmptyState').hide();

        $.ajax({
            url: '@Url.Action("GetWarehouseReceipts", "Staff")',
            type: 'POST',
            data: {
                page: 1,
                pageSize: 50,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayReceipts(response.data);
                } else {
                    $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p>').show();
                    $('#receiptsTableContainer').show();
                }
            },
            error: function () {
                $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>加载失败</p>').show();
                $('#receiptsTableContainer').show();
            },
            complete: function () {
                $('#receiptsLoading').hide();
            }
        });
    }

    // 显示入库记录
    function displayReceipts(receipts) {
        if (receipts && receipts.length > 0) {
            var tbody = $('#receiptsTableBody');
            tbody.empty();

            receipts.forEach(function (receipt) {
                var row = '<tr>' +
                    '<td>' + receipt.ReceiptNumber + '</td>' +
                    '<td>' + (receipt.TransportOrderNumber || '-') + '</td>' +
                    '<td>' + (receipt.RecyclerName || '-') + '</td>' +
                    '<td>' + receipt.TotalWeight.toFixed(2) + '</td>' +
                    '<td>' + formatDateTime(receipt.CreatedDate) + '</td>' +
                    '<td><span class="status-badge status-completed">' + receipt.Status + '</span></td>' +
                    '</tr>';
                tbody.append(row);
            });

            $('#receiptsTableContainer').show();
            $('#receiptsTable').show();
        } else {
            $('#receiptsTableContainer').show();
            $('#receiptsEmptyState').show();
        }
    }

    // 刷新运输单
    function refreshTransitOrders() {
        loadCompletedTransportOrders();
    }

    // 格式化日期时间
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        return date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0');
    }
</script>
