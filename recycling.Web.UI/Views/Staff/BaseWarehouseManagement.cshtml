@model recycling.Model.BaseWarehouseManagementViewModel
@{
    ViewBag.Title = "仓库管理";
    Layout = "~/Views/Shared/_SortingCenterWorkerLayout.cshtml";
}

@Html.AntiForgeryToken()

<style>
    .warehouse-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .page-title i {
        margin-right: 15px;
        color: #27ae60;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .section-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
    }

    .btn-primary {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #229954;
    }

    .btn-secondary {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #2980b9;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #27ae60;
    }

    .receipts-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .receipts-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        font-size: 14px;
    }

    .receipts-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #555;
        font-size: 14px;
    }

    .receipts-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-completed {
        background: #d4edda;
        color: #155724;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #bdc3c7;
    }

    .loading-spinner {
        text-align: center;
        padding: 30px;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #27ae60;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .transit-orders-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .transit-order-item {
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .transit-order-item:hover {
        border-color: #27ae60;
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
    }

    .transit-order-item.selected {
        border-color: #27ae60;
        background: #f0f8f4;
    }

    .order-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .order-number {
        font-weight: bold;
        color: #2c3e50;
    }

    .order-weight {
        color: #27ae60;
        font-weight: 600;
    }

    .order-details {
        font-size: 13px;
        color: #7f8c8d;
    }

    @@media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="warehouse-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-box-open"></i>
            仓库管理
        </h1>
    </div>

    <div class="content-grid">
        <!-- 左侧：创建入库单 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">创建入库单</h2>
                <button class="btn-secondary" onclick="refreshTransitOrders()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="transitOrdersLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="transitOrdersList" class="transit-orders-list">
                @if (Model != null && Model.CompletedTransportOrders != null && Model.CompletedTransportOrders.Any())
                {
                    foreach (var order in Model.CompletedTransportOrders)
                    {
                        <div class="transit-order-item" 
                             data-order-id="@order.TransportOrderID" 
                             data-order-number="@order.OrderNumber" 
                             data-estimated-weight="@order.EstimatedWeight" 
                             data-item-categories="@(order.ItemCategories ?? "")" 
                             data-recycler-name="@(order.RecyclerName ?? "")"
                             data-transporter-name="@(order.TransporterName ?? "")"
                             data-pickup-date="@(order.PickupDate?.ToString("yyyy-MM-dd HH:mm") ?? "")"
                             onclick="selectOrder(this)">
                            <div class="order-info">
                                <span class="order-number">@order.OrderNumber</span>
                                <span class="order-weight">@order.EstimatedWeight.ToString("F2") kg</span>
                            </div>
                            <div class="order-details">
                                回收员：@(order.RecyclerName ?? "-") | 运输人员：@(order.TransporterName ?? "-")
                            </div>
                            @if (order.PickupDate.HasValue)
                            {
                                <div style="font-size: 12px; color: #777; margin-top: 5px;">
                                    取货时间：@order.PickupDate.Value.ToString("yyyy-MM-dd HH:mm")
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无可入库的运输单</p>
                    </div>
                }
            </div>

            <div id="receiptForm" style="display: none;">
                <form id="createReceiptForm">
                    <input type="hidden" id="selectedTransportOrderId" />
                    
                    <div class="form-group">
                        <label class="form-label">运输单号</label>
                        <input type="text" class="form-control" id="orderNumberDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">回收员</label>
                        <input type="text" class="form-control" id="recyclerNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">运输人员</label>
                        <input type="text" class="form-control" id="transporterNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">取货时间</label>
                        <input type="text" class="form-control" id="pickupDateDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">预估重量（kg）</label>
                        <input type="text" class="form-control" id="estimatedWeightDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">实际入库重量（kg）<span style="color: red;">*</span></label>
                        <input type="number" class="form-control" id="totalWeight" step="0.01" required 
                               placeholder="请输入实际称重后的重量" />
                        <small style="color: #666;">提示：可以修改为实际称重重量</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">物品类别明细</label>
                        <div id="categoriesPreview" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 50px;">
                            <small style="color: #666;">从运输单自动获取</small>
                        </div>
                        <textarea class="form-control" id="itemCategories" rows="4" 
                                  placeholder='JSON格式：[{"categoryKey":"paper","categoryName":"纸类","weight":20.5,"price":41.0}]'></textarea>
                        <small style="color: #666;">提示：系统已自动填充，如需调整请修改上方JSON数据</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">入库备注</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="如：物品完好无损、包装完整等"></textarea>
                    </div>

                    <div style="text-align: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <button type="button" class="btn-primary" onclick="createReceipt()">
                            <i class="fas fa-plus-circle"></i> 创建入库单
                        </button>
                        <button type="button" class="btn-secondary" onclick="cancelSelection()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右侧：入库单列表 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">入库记录</h2>
                <button class="btn-secondary" onclick="loadWarehouseReceipts()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="receiptsLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="receiptsTableContainer">
                @if (Model != null && Model.WarehouseReceipts != null && Model.WarehouseReceipts.Any())
                {
                    <table class="receipts-table" id="receiptsTable">
                        <thead>
                            <tr>
                                <th>入库单号</th>
                                <th>运输单号</th>
                                <th>回收员</th>
                                <th>重量(kg)</th>
                                <th>入库时间</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsTableBody">
                            @foreach (var receipt in Model.WarehouseReceipts)
                            {
                                <tr>
                                    <td>@receipt.ReceiptNumber</td>
                                    <td>@(receipt.TransportOrderNumber ?? "-")</td>
                                    <td>@(receipt.RecyclerName ?? "-")</td>
                                    <td>@receipt.TotalWeight.ToString("F2")</td>
                                    <td>@receipt.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td><span class="status-badge status-completed">@receipt.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div id="receiptsEmptyState" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无入库记录</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- 库存信息显示区域 - Inventory Information Display Area -->
    <div class="section-card" style="margin-top: 25px;">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-warehouse"></i> 当前库存信息
            </h2>
            <button class="btn-secondary" onclick="loadInventorySummary()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
        </div>

        <div id="inventoryLoading" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>

        <!-- 库存汇总卡片 - Server-side rendered -->
        <div id="inventorySummaryCards" class="inventory-summary-grid">
            @if (Model != null && Model.InventorySummary != null && Model.InventorySummary.Any())
            {
                foreach (var item in Model.InventorySummary)
                {
                    var categoryKey = item.CategoryKey ?? "";
                    var categoryName = item.CategoryName ?? "";
                    var totalWeight = item.TotalWeight;
                    var totalPrice = item.TotalPrice;
                    
                    // 使用 HTML 编码防止 XSS
                    var encodedCategoryKey = Html.AttributeEncode(categoryKey);
                    var encodedCategoryName = Html.AttributeEncode(categoryName);
                    
                    <div class="inventory-card" 
                         data-category="@encodedCategoryKey"
                         data-category-name="@encodedCategoryName">
                        <div class="inventory-card-icon">
                            <i class="fas"></i>
                        </div>
                        <div class="inventory-card-category">@Html.Encode(categoryName)</div>
                        <div class="inventory-card-weight">@totalWeight.ToString("F1") kg</div>
                        <div class="inventory-card-price">价值: ¥@totalPrice.ToString("F2")</div>
                    </div>
                }
            }
        </div>

        <!-- 空状态提示 - 用于初始加载和AJAX刷新 -->
        <div id="inventoryEmptyState" class="empty-state" style="@(Model != null && Model.InventorySummary != null && Model.InventorySummary.Any() ? "display: none;" : "")">
            <i class="fas fa-box-open"></i>
            <p>暂无库存数据</p>
        </div>

        <!-- 库存明细表格 -->
        <div id="inventoryDetailSection" style="display: none; margin-top: 25px;">
            <div class="section-header" style="border-top: 2px solid #f0f0f0; padding-top: 20px;">
                <h3 class="section-title" style="font-size: 18px;">
                    <i class="fas fa-list"></i> 库存明细 <span id="inventoryDetailTitle"></span>
                </h3>
                <button class="btn-secondary" onclick="showAllInventoryDetails()" style="font-size: 14px; padding: 8px 16px;">
                    <i class="fas fa-refresh"></i> 显示全部
                </button>
            </div>

            <table class="receipts-table" id="inventoryDetailTable">
                <thead>
                    <tr>
                        <th>入库单号</th>
                        <th>品类</th>
                        <th>重量(kg)</th>
                        <th>价值(元)</th>
                        <th>回收员</th>
                        <th>入库时间</th>
                    </tr>
                </thead>
                <tbody id="inventoryDetailTableBody">
                </tbody>
            </table>

            <!-- 分页 -->
            <div id="inventoryPaginationContainer" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div id="inventoryPaginationInfo" style="color: #666;"></div>
                <div id="inventoryPagination" class="pagination-controls">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .inventory-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .inventory-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .inventory-card.active {
        box-shadow: 0 0 0 3px #27ae60;
    }

    .inventory-card-icon {
        font-size: 32px;
        margin-bottom: 10px;
    }

    .inventory-card-category {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .inventory-card-weight {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .inventory-card-price {
        font-size: 14px;
        opacity: 0.9;
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
    }

    .pagination-controls button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-controls button.active {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
    }

    .badge-inventory {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-glass { background: #e3f2fd; color: #1976d2; }
    .badge-metal { background: #eceff1; color: #546e7a; }
    .badge-plastic { background: #ffebee; color: #c62828; }
    .badge-paper { background: #fff3e0; color: #e65100; }
    .badge-fabric { background: #f3e5f5; color: #7b1fa2; }
    .badge-unknown { background: #f5f5f5; color: #666; }

    .empty-details-message {
        text-align: center;
        padding: 30px;
        color: #999;
    }
    .badge-plastic { background: #ffebee; color: #c62828; }
    .badge-paper { background: #fff3e0; color: #e65100; }
    .badge-fabric { background: #f3e5f5; color: #7b1fa2; }
</style>

<script>
    var selectedOrderId = null;
    
    // 常量定义 - Constants for fallback text
    var FALLBACK_TEXT = {
        UNKNOWN_RECYCLER: '未知',
        UNKNOWN_TRANSPORTER: '未知',
        NO_PICKUP_DATE: '未记录',
        UNKNOWN_CATEGORY: '未知类别'
    };

    // 注意：页面加载时数据已通过服务器端渲染直接显示，无需自动调用 AJAX
    // Note: Data is rendered server-side on page load, no need to call AJAX automatically
    // 
    // 下面的 AJAX 函数仅在用户手动点击"刷新"按钮时调用
    // The AJAX functions below are only called when user clicks the "Refresh" buttons

    // 加载已完成的运输单（仅用于手动刷新）
    // Load completed transport orders (only for manual refresh)
    function loadCompletedTransportOrders() {
        $('#transitOrdersLoading').show();
        $('#transitOrdersList').hide().html('');

        $.ajax({
            url: '@Url.Action("GetCompletedTransportOrders", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayTransitOrders(response.data);
                } else {
                    $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p></div>').show();
                }
            },
            error: function () {
                $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>加载失败</p></div>').show();
            },
            complete: function () {
                $('#transitOrdersLoading').hide();
            }
        });
    }

    // 显示运输单列表
    function displayTransitOrders(orders) {
        if (orders && orders.length > 0) {
            var html = '';
            orders.forEach(function (order) {
                html += '<div class="transit-order-item" data-order-id="' + order.TransportOrderID + '" ' +
                    'data-order-number="' + order.OrderNumber + '" ' +
                    'data-estimated-weight="' + order.EstimatedWeight + '" ' +
                    'data-item-categories="' + (order.ItemCategories || '') + '" ' +
                    'data-recycler-name="' + (order.RecyclerName || '') + '" ' +
                    'data-transporter-name="' + (order.TransporterName || '') + '" ' +
                    'data-pickup-date="' + (order.PickupDate || '') + '" ' +
                    'onclick="selectOrder(this)">' +
                    '<div class="order-info">' +
                    '<span class="order-number">' + order.OrderNumber + '</span>' +
                    '<span class="order-weight">' + order.EstimatedWeight.toFixed(2) + ' kg</span>' +
                    '</div>' +
                    '<div class="order-details">' +
                    '回收员：' + (order.RecyclerName || '-') + ' | ' +
                    '运输人员：' + (order.TransporterName || '-') +
                    '</div>';
                
                if (order.PickupDate) {
                    html += '<div style="font-size: 12px; color: #777; margin-top: 5px;">取货时间：' + order.PickupDate + '</div>';
                }
                
                html += '</div>';
            });
            $('#transitOrdersList').html(html).show();
        } else {
            $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无可入库的运输单</p></div>').show();
        }
    }

    // 选择运输单
    function selectOrder(element) {
        // 检查是否已创建入库单
        var orderId = $(element).data('order-id');
        
        $.ajax({
            url: '@Url.Action("CheckWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    if (response.hasReceipt) {
                        alert('该运输单已创建入库单');
                        return;
                    }
                    
                    // 未创建入库单，可以继续
                    $('.transit-order-item').removeClass('selected');
                    $(element).addClass('selected');

                    selectedOrderId = orderId;
                    
                    // 填充表单数据（自动从运输单获取）
                    $('#selectedTransportOrderId').val(orderId);
                    $('#orderNumberDisplay').val($(element).data('order-number'));
                    $('#recyclerNameDisplay').val($(element).data('recycler-name') || FALLBACK_TEXT.UNKNOWN_RECYCLER);
                    $('#transporterNameDisplay').val($(element).data('transporter-name') || FALLBACK_TEXT.UNKNOWN_TRANSPORTER);
                    $('#pickupDateDisplay').val($(element).data('pickup-date') || FALLBACK_TEXT.NO_PICKUP_DATE);
                    
                    var estimatedWeight = $(element).data('estimated-weight');
                    $('#estimatedWeightDisplay').val(estimatedWeight);
                    $('#totalWeight').val(estimatedWeight); // 默认使用预估重量，可修改
                    
                    var itemCategories = $(element).data('item-categories') || '';
                    $('#itemCategories').val(itemCategories);
                    
                    // 解析并显示类别预览
                    displayCategoriesPreview(itemCategories);

                    $('#transitOrdersList').hide();
                    $('#receiptForm').show();
                } else {
                    alert('检查失败：' + response.message);
                }
            },
            error: function () {
                alert('网络错误');
            }
        });
    }

    // 显示物品类别预览
    function displayCategoriesPreview(categoriesJson) {
        var preview = $('#categoriesPreview');
        
        if (!categoriesJson || categoriesJson.trim() === '') {
            preview.html('<small style="color: #999;">无类别信息</small>');
            return;
        }
        
        try {
            var categories = JSON.parse(categoriesJson);
            if (!Array.isArray(categories) || categories.length === 0) {
                preview.html('<small style="color: #999;">无类别信息</small>');
                return;
            }
            
            var totalWeight = 0;
            var rows = [];
            
            categories.forEach(function(cat, index) {
                var weight = parseFloat(cat.weight || 0);
                totalWeight += weight;
                
                // Escape HTML to prevent XSS
                var categoryName = $('<div>').text(cat.categoryName || FALLBACK_TEXT.UNKNOWN_CATEGORY).html();
                var priceText = '';
                
                if (cat.price) {
                    priceText = ' (价值: ¥' + parseFloat(cat.price).toFixed(2) + ')';
                }
                
                rows.push(
                    '<div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0;">' +
                    '<strong>' + categoryName + '</strong>: ' +
                    weight.toFixed(2) + ' kg' + priceText +
                    '</div>'
                );
            });
            
            rows.push('<div style="padding: 8px 0; font-weight: bold; color: #27ae60;">总重量: ' + totalWeight.toFixed(2) + ' kg</div>');
            
            preview.html('<div style="font-size: 13px;">' + rows.join('') + '</div>');
        } catch (e) {
            preview.html('<small style="color: #e74c3c;">类别数据格式错误，请检查JSON格式是否正确</small>');
            console.error('解析类别数据失败:', e);
        }
    }

    // 取消选择
    function cancelSelection() {
        selectedOrderId = null;
        $('#receiptForm').hide();
        $('#transitOrdersList').show();
        $('.transit-order-item').removeClass('selected');
        $('#createReceiptForm')[0].reset();
        $('#categoriesPreview').html('<small style="color: #666;">从运输单自动获取</small>');
    }

    // 创建入库单
    function createReceipt() {
        var orderId = $('#selectedTransportOrderId').val();
        var weight = $('#totalWeight').val();
        var categories = $('#itemCategories').val();
        var notes = $('#notes').val();

        if (!orderId || !weight || weight <= 0) {
            alert('请填写完整信息');
            return;
        }

        $.ajax({
            url: '@Url.Action("CreateWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                totalWeight: weight,
                itemCategories: categories,
                notes: notes,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    alert('入库成功！入库单号：' + response.receiptNumber);
                    cancelSelection();
                    loadCompletedTransportOrders();
                    loadWarehouseReceipts();
                } else {
                    alert('入库失败：' + response.message);
                }
            },
            error: function () {
                alert('网络错误，请稍后重试');
            }
        });
    }

    // 加载入库记录（仅用于手动刷新）
    // Load warehouse receipts (only for manual refresh)
    function loadWarehouseReceipts() {
        $('#receiptsLoading').show();
        $('#receiptsTableContainer').hide();
        $('#receiptsTable').hide();
        $('#receiptsEmptyState').hide();

        $.ajax({
            url: '@Url.Action("GetWarehouseReceipts", "Staff")',
            type: 'POST',
            data: {
                page: 1,
                pageSize: 50,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayReceipts(response.data);
                } else {
                    $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p>').show();
                    $('#receiptsTableContainer').show();
                }
            },
            error: function () {
                $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>加载失败</p>').show();
                $('#receiptsTableContainer').show();
            },
            complete: function () {
                $('#receiptsLoading').hide();
            }
        });
    }

    // 显示入库记录
    function displayReceipts(receipts) {
        if (receipts && receipts.length > 0) {
            var tbody = $('#receiptsTableBody');
            tbody.empty();

            receipts.forEach(function (receipt) {
                var row = '<tr>' +
                    '<td>' + receipt.ReceiptNumber + '</td>' +
                    '<td>' + (receipt.TransportOrderNumber || '-') + '</td>' +
                    '<td>' + (receipt.RecyclerName || '-') + '</td>' +
                    '<td>' + receipt.TotalWeight.toFixed(2) + '</td>' +
                    '<td>' + formatDateTime(receipt.CreatedDate) + '</td>' +
                    '<td><span class="status-badge status-completed">' + receipt.Status + '</span></td>' +
                    '</tr>';
                tbody.append(row);
            });

            $('#receiptsTableContainer').show();
            $('#receiptsTable').show();
        } else {
            $('#receiptsTableContainer').show();
            $('#receiptsEmptyState').show();
        }
    }

    // 刷新运输单
    function refreshTransitOrders() {
        loadCompletedTransportOrders();
    }

    // 格式化日期时间
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        return date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0');
    }

    // ==================== 库存管理功能 ====================
    // Inventory Management Functions

    // 封装库存管理相关变量和函数 - Encapsulate inventory management variables and functions
    var InventoryManager = {
        currentPage: 1,
        pageSize: 20,
        currentCategoryKey: null,
        
        // 类别图标映射
        categoryIcons: {
            'glass': 'fa-wine-glass',
            'metal': 'fa-screwdriver-wrench',
            'plastic': 'fa-bottle-water',
            'paper': 'fa-file-lines',
            'fabric': 'fa-shirt'
        },

        // 类别颜色映射
        categoryColors: {
            'glass': '#3498db',
            'metal': '#95a5a6',
            'plastic': '#e74c3c',
            'paper': '#f39c12',
            'fabric': '#9b59b6'
        },

        // 显示错误消息
        showError: function(message) {
            var errorDiv = $('#inventoryEmptyState');
            errorDiv.html('<i class="fas fa-exclamation-circle"></i><p style="color: #e74c3c;">' + escapeHtml(message) + '</p>').show();
            setTimeout(function() {
                errorDiv.hide();
            }, 5000);
        },

        // 调整颜色亮度（简化版本）
        adjustColor: function(color, percent) {
            var num = parseInt(color.replace('#', ''), 16);
            var amt = Math.round(2.55 * percent);
            var R = Math.max(0, Math.min(255, (num >> 16) + amt));
            var G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
            var B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + ((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1);
        },

        // 验证类别键是否有效（严格的白名单验证）
        isValidCategoryKey: function(categoryKey) {
            if (!categoryKey || typeof categoryKey !== 'string') return false;
            // 严格的白名单：只允许预定义的类别键
            return this.categoryIcons.hasOwnProperty(categoryKey);
        },

        // 安全地转义 jQuery 选择器（使用更全面的转义）
        escapeSelector: function(selector) {
            if (!selector) return '';
            // 使用 CSS.escape 如果可用，否则使用手动转义
            if (window.CSS && window.CSS.escape) {
                return window.CSS.escape(selector);
            }
            // 回退到手动转义特殊字符
            return selector.replace(/[!"#$%&'()*+,.\/:;<=>?@@[\\\]^`{|}~]/g, '\\$&');
        },

        // 显示错误消息（使用安全的DOM创建）
        showError: function(message) {
            var errorDiv = $('#inventoryEmptyState');
            errorDiv.empty();
            var icon = $('<i>').addClass('fas fa-exclamation-circle');
            var text = $('<p>').css('color', '#e74c3c').text(message);
            errorDiv.append(icon).append(text).show();
            setTimeout(function() {
                errorDiv.hide();
            }, 5000);
        },

        // 获取已验证的 badge class 名称
        getBadgeClass: function(categoryKey) {
            if (!this.isValidCategoryKey(categoryKey)) return 'badge-unknown';
            return 'badge-' + categoryKey;
        }
    };

    // 加载库存汇总
    function loadInventorySummary() {
        $('#inventoryLoading').show();
        $('#inventorySummaryCards').hide();
        $('#inventoryEmptyState').hide();
        $('#inventoryDetailSection').hide();

        $.ajax({
            url: '@Url.Action("GetBaseWarehouseInventorySummary", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success && response.data && response.data.length > 0) {
                    displayInventorySummary(response.data);
                    // 自动加载明细
                    loadInventoryDetail();
                } else {
                    $('#inventoryEmptyState').show();
                }
            },
            error: function () {
                $('#inventoryEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>加载库存失败</p>').show();
            },
            complete: function () {
                $('#inventoryLoading').hide();
            }
        });
    }

    // 显示库存汇总卡片
    function displayInventorySummary(summaryData) {
        var container = $('#inventorySummaryCards');
        container.empty();

        summaryData.forEach(function (item) {
            // 验证并清理类别键
            if (!InventoryManager.isValidCategoryKey(item.categoryKey)) {
                console.warn('Invalid category key:', item.categoryKey);
                return; // 跳过无效的类别
            }

            var icon = InventoryManager.categoryIcons[item.categoryKey] || 'fa-box';
            var color = InventoryManager.categoryColors[item.categoryKey] || '#3498db';
            
            // 清理类别键用于 data 属性
            var safeCategoryKey = escapeHtml(item.categoryKey);
            var safeCategoryName = escapeHtml(item.categoryName);

            var card = $('<div>')
                .addClass('inventory-card')
                .attr('data-category', safeCategoryKey)
                .attr('data-category-name', safeCategoryName)
                .css('background', 'linear-gradient(135deg, ' + color + ' 0%, ' + InventoryManager.adjustColor(color, -20) + ' 100%)');
            
            // Safely create card content with validated icon class
            var iconDiv = $('<div>').addClass('inventory-card-icon').append($('<i>').addClass('fas ' + icon));
            var categoryDiv = $('<div>').addClass('inventory-card-category').text(item.categoryName);
            var weightDiv = $('<div>').addClass('inventory-card-weight').text(item.totalWeight.toFixed(1) + ' kg');
            var priceDiv = $('<div>').addClass('inventory-card-price').text('价值: ¥' + item.totalPrice.toFixed(2));
            
            card.append(iconDiv).append(categoryDiv).append(weightDiv).append(priceDiv);
            // 注意：不再使用内联 onclick，而是使用事件委托（见 document.ready）
            // Note: No longer using inline onclick, using event delegation instead (see document.ready)

            container.append(card);
        });

        container.show();
    }

    // 按类别筛选库存
    function filterInventoryByCategory(categoryKey, categoryName) {
        // 验证类别键
        if (!InventoryManager.isValidCategoryKey(categoryKey)) {
            console.error('Invalid category key:', categoryKey);
            return;
        }

        $('.inventory-card').removeClass('active');
        // 使用安全的选择器
        var safeSelector = '[data-category="' + InventoryManager.escapeSelector(categoryKey) + '"]';
        $('.inventory-card' + safeSelector).addClass('active');

        $('#inventoryDetailTitle').text(' - ' + categoryName);
        InventoryManager.currentCategoryKey = categoryKey;
        InventoryManager.currentPage = 1;
        loadInventoryDetail();
    }

    // 显示全部库存明细
    function showAllInventoryDetails() {
        $('.inventory-card').removeClass('active');
        $('#inventoryDetailTitle').text('');
        InventoryManager.currentCategoryKey = null;
        InventoryManager.currentPage = 1;
        loadInventoryDetail();
    }

    // 加载库存明细
    function loadInventoryDetail() {
        $('#inventoryDetailSection').show();

        $.ajax({
            url: '@Url.Action("GetBaseWarehouseInventoryDetail", "Staff")',
            type: 'POST',
            data: {
                page: InventoryManager.currentPage,
                pageSize: InventoryManager.pageSize,
                categoryKey: InventoryManager.currentCategoryKey,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayInventoryDetail(response.data);
                } else {
                    InventoryManager.showError('加载库存明细失败: ' + response.message);
                }
            },
            error: function () {
                InventoryManager.showError('加载库存明细失败，请稍后重试');
            }
        });
    }

    // 显示库存明细
    function displayInventoryDetail(data) {
        var tbody = $('#inventoryDetailTableBody');
        tbody.empty();

        if (!data.Items || data.Items.length === 0) {
            var emptyRow = $('<tr>').append(
                $('<td>').attr('colspan', '6').addClass('empty-details-message').text('暂无明细数据')
            );
            tbody.append(emptyRow);
            $('#inventoryPaginationContainer').hide();
            return;
        }

        data.Items.forEach(function (item) {
            // 使用安全的 badge class 获取方法
            var badgeClass = InventoryManager.getBadgeClass(item.CategoryKey);
            var price = item.Price != null ? '¥' + item.Price.toFixed(2) : '-';
            var createdDate = formatDateTime(item.CreatedDate);

            var row = $('<tr>');
            row.append($('<td>').html('<strong>' + escapeHtml(item.OrderNumber) + '</strong>'));
            row.append($('<td>').html('<span class="badge-inventory ' + badgeClass + '">' + escapeHtml(item.CategoryName) + '</span>'));
            row.append($('<td>').text(item.Weight.toFixed(2)));
            row.append($('<td>').text(price));
            row.append($('<td>').text(item.RecyclerName || '-'));
            row.append($('<td>').text(createdDate));

            tbody.append(row);
        });

        displayInventoryPagination(data);
        $('#inventoryPaginationContainer').show();
    }

    // 显示分页控件
    function displayInventoryPagination(data) {
        var totalPages = Math.ceil(data.TotalCount / data.PageSize);
        var startItem = (data.PageIndex - 1) * data.PageSize + 1;
        var endItem = Math.min(data.PageIndex * data.PageSize, data.TotalCount);

        $('#inventoryPaginationInfo').text('显示 ' + startItem + ' - ' + endItem + ' 条，共 ' + data.TotalCount + ' 条');

        var pagination = $('#inventoryPagination');
        pagination.empty();

        if (totalPages <= 1) return;

        // 上一页
        var prevBtn = $('<button>')
            .text('上一页')
            .prop('disabled', data.PageIndex === 1)
            .on('click', function () {
                if (data.PageIndex > 1) {
                    InventoryManager.currentPage = data.PageIndex - 1;
                    loadInventoryDetail();
                }
            });
        pagination.append(prevBtn);

        // 页码按钮
        var startPage = Math.max(1, data.PageIndex - 2);
        var endPage = Math.min(totalPages, data.PageIndex + 2);

        for (var i = startPage; i <= endPage; i++) {
            (function (pageNum) {
                var pageBtn = $('<button>')
                    .text(pageNum)
                    .toggleClass('active', pageNum === data.PageIndex)
                    .on('click', function () {
                        InventoryManager.currentPage = pageNum;
                        loadInventoryDetail();
                    });
                pagination.append(pageBtn);
            })(i);
        }

        // 下一页
        var nextBtn = $('<button>')
            .text('下一页')
            .prop('disabled', data.PageIndex >= totalPages)
            .on('click', function () {
                if (data.PageIndex < totalPages) {
                    InventoryManager.currentPage = data.PageIndex + 1;
                    loadInventoryDetail();
                }
            });
        pagination.append(nextBtn);
    }

    // HTML转义函数（防止XSS）
    function escapeHtml(text) {
        if (!text) return '';
        return $('<div>').text(text).html();
    }

    // 页面加载时初始化库存卡片样式（服务器端已渲染数据）
    // Initialize inventory card styles on page load (data already rendered server-side)
    $(document).ready(function () {
        // 为服务器端渲染的库存卡片应用图标和颜色
        // Apply icons and colors to server-side rendered inventory cards
        $('.inventory-card').each(function() {
            var card = $(this);
            var categoryKey = card.data('category');
            
            if (categoryKey && InventoryManager.isValidCategoryKey(categoryKey)) {
                var icon = InventoryManager.categoryIcons[categoryKey] || 'fa-box';
                var color = InventoryManager.categoryColors[categoryKey] || '#3498db';
                
                // 设置图标
                card.find('.inventory-card-icon i').addClass(icon);
                
                // 设置背景渐变色
                var gradientColor = InventoryManager.adjustColor(color, -20);
                card.css('background', 'linear-gradient(135deg, ' + color + ' 0%, ' + gradientColor + ' 100%)');
            }
        });
        
        // 使用事件委托为库存卡片添加点击处理
        // Use event delegation for inventory card click handling
        $(document).on('click', '.inventory-card', function() {
            var card = $(this);
            var categoryKey = card.data('category');
            var categoryName = card.data('category-name');
            
            if (categoryKey && categoryName) {
                filterInventoryByCategory(categoryKey, categoryName);
            }
        });
        
        // 注意：不再自动调用 loadInventorySummary()，因为数据已通过服务器端渲染
        // Note: No longer calling loadInventorySummary() automatically as data is server-side rendered
        // 刷新按钮仍然可以调用 AJAX 更新数据
        // Refresh button can still call AJAX to update data
    });
</script>
