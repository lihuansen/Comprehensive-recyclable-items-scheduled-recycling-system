@model recycling.Model.BaseWarehouseManagementViewModel
@{
    ViewBag.Title = "仓库管理";
    Layout = "~/Views/Shared/_SortingCenterWorkerLayout.cshtml";
}

@Html.AntiForgeryToken()

<style>
    .warehouse-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .page-title i {
        margin-right: 15px;
        color: #27ae60;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .section-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
    }

    .btn-primary {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #229954;
    }

    .btn-secondary {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #2980b9;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #27ae60;
    }

    .receipts-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .receipts-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        font-size: 14px;
    }

    .receipts-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #555;
        font-size: 14px;
    }

    .receipts-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-completed {
        background: #d4edda;
        color: #155724;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .btn-warehouse {
        background: #27ae60;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
    }

    .btn-warehouse:hover {
        background: #229954;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .btn-warehouse i {
        margin-right: 5px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #bdc3c7;
    }

    .loading-spinner {
        text-align: center;
        padding: 30px;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #27ae60;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .transit-orders-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .transit-order-item {
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .transit-order-item:hover {
        border-color: #27ae60;
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
    }

    .transit-order-item.selected {
        border-color: #27ae60;
        background: #f0f8f4;
    }

    .order-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .order-number {
        font-weight: bold;
        color: #2c3e50;
    }

    .order-weight {
        color: #27ae60;
        font-weight: 600;
    }

    .order-details {
        font-size: 13px;
        color: #7f8c8d;
    }

    @@media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="warehouse-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-box-open"></i>
            仓库管理
        </h1>
    </div>

    <div class="content-grid">
        <!-- 左侧：创建入库单 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">创建入库单</h2>
                <button class="btn-secondary" onclick="refreshTransitOrders()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="transitOrdersLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="transitOrdersList" class="transit-orders-list">
                @if (Model != null && Model.CompletedTransportOrders != null && Model.CompletedTransportOrders.Any())
                {
                    foreach (var order in Model.CompletedTransportOrders)
                    {
                        <div class="transit-order-item" 
                             data-order-id="@order.TransportOrderID" 
                             data-order-number="@order.OrderNumber" 
                             data-estimated-weight="@order.EstimatedWeight" 
                             data-recycler-name="@(order.RecyclerName ?? "")"
                             data-transporter-name="@(order.TransporterName ?? "")"
                             onclick="selectOrder(this)">
                            <div class="order-info">
                                <span class="order-number">@order.OrderNumber</span>
                                <span class="order-weight">@order.EstimatedWeight.ToString("F2") kg</span>
                            </div>
                            <div class="order-details">
                                回收员：@(order.RecyclerName ?? "-") | 运输人员：@(order.TransporterName ?? "-")
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无可入库的运输单</p>
                    </div>
                }
            </div>

            <div id="receiptForm" style="display: none;">
                <form id="createReceiptForm">
                    <input type="hidden" id="selectedTransportOrderId" />
                    
                    <div class="form-group">
                        <label class="form-label">运输单号</label>
                        <input type="text" class="form-control" id="orderNumberDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">回收员</label>
                        <input type="text" class="form-control" id="recyclerNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">运输人员</label>
                        <input type="text" class="form-control" id="transporterNameDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">预估重量（kg）</label>
                        <input type="text" class="form-control" id="estimatedWeightDisplay" readonly style="background-color: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">实际入库重量（kg）<span style="color: red;">*</span></label>
                        <input type="number" class="form-control" id="totalWeight" step="0.01" required 
                               placeholder="请输入实际称重后的重量" />
                        <small style="color: #666;">提示：可以修改为实际称重重量</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">物品类别明细<span style="color: red;">*</span></label>
                        <input type="hidden" id="itemCategories" />
                        <div id="categoriesTable" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #ddd;">
                                        <th style="padding: 8px; text-align: left; font-weight: 600; color: #2c3e50;">品类名称</th>
                                        <th style="padding: 8px; text-align: right; font-weight: 600; color: #2c3e50;">重量（kg）</th>
                                        <th style="padding: 8px; text-align: right; font-weight: 600; color: #2c3e50;">价值（元）</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody">
                                    <tr>
                                        <td colspan="3" style="padding: 20px; text-align: center; color: #999;">
                                            <i class="fas fa-info-circle"></i> 选择运输单后将自动显示
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot id="categoriesTableFooter" style="display: none;">
                                    <tr style="border-top: 2px solid #27ae60; font-weight: bold;">
                                        <td style="padding: 10px; color: #27ae60;">总计</td>
                                        <td id="totalWeightDisplay" style="padding: 10px; text-align: right; color: #27ae60;">0.00</td>
                                        <td id="totalPriceDisplay" style="padding: 10px; text-align: right; color: #27ae60;">¥0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <small style="color: #666; display: block; margin-top: 8px;">
                            <i class="fas fa-lock"></i> 物品类别从运输单自动获取，不可修改
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">入库备注</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="如：物品完好无损、包装完整等"></textarea>
                    </div>

                    <div style="text-align: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <button type="button" class="btn-primary" onclick="createReceipt()">
                            <i class="fas fa-plus-circle"></i> 创建入库单
                        </button>
                        <button type="button" class="btn-secondary" onclick="cancelSelection()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右侧：入库单列表 -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">入库单</h2>
                <button class="btn-secondary" onclick="loadWarehouseReceipts()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="receiptsLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div id="receiptsTableContainer">
                @{
                    var hasReceipts = Model != null && Model.WarehouseReceipts != null && Model.WarehouseReceipts.Any();
                }
                <table class="receipts-table" id="receiptsTable" style="@(hasReceipts ? "" : "display: none;")">
                    <thead>
                        <tr>
                            <th>入库单号</th>
                            <th>运输单号</th>
                            <th>回收员</th>
                            <th>重量(kg)</th>
                            <th>入库时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="receiptsTableBody">
                        @if (hasReceipts)
                        {
                            foreach (var receipt in Model.WarehouseReceipts)
                            {
                                <tr data-receipt-id="@receipt.ReceiptID">
                                    <td>@receipt.ReceiptNumber</td>
                                    <td>@(receipt.TransportOrderNumber ?? "-")</td>
                                    <td>@(receipt.RecyclerName ?? "-")</td>
                                    <td>@receipt.TotalWeight.ToString("F2")</td>
                                    <td>@receipt.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td><span class="status-badge @(receipt.Status == "待入库" ? "status-pending" : "status-completed")">@receipt.Status</span></td>
                                    <td>
                                        @if (receipt.Status == "待入库")
                                        {
                                            <button class="btn-warehouse" onclick="processWarehouse(@receipt.ReceiptID)">
                                                <i class="fas fa-warehouse"></i> 入库
                                            </button>
                                        }
                                        else
                                        {
                                            <span style="color: #999;">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                <div id="receiptsEmptyState" class="empty-state" style="@(hasReceipts ? "display: none;" : "")">
                    <i class="fas fa-inbox"></i>
                    <p>暂无入库单</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 库存信息显示区域 - Inventory Information Display Area -->
    <div class="section-card" style="margin-top: 25px;">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-warehouse"></i> 当前库存信息
            </h2>
            <button class="btn-secondary" onclick="loadInventorySummary()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
        </div>

        <div id="inventoryLoading" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>

        <!-- 库存汇总卡片 - Server-side rendered -->
        <div id="inventorySummaryCards" class="inventory-summary-grid">
            @if (Model != null && Model.InventorySummary != null && Model.InventorySummary.Any())
            {
                foreach (var item in Model.InventorySummary)
                {
                    var categoryKey = item.CategoryKey ?? "";
                    var categoryName = item.CategoryName ?? "";
                    var totalWeight = item.TotalWeight;
                    var totalPrice = item.TotalPrice;
                    
                    // 使用 HTML 编码防止 XSS
                    var encodedCategoryKey = Html.AttributeEncode(categoryKey);
                    var encodedCategoryName = Html.AttributeEncode(categoryName);
                    
                    <div class="inventory-card" 
                         data-category="@encodedCategoryKey"
                         data-category-name="@encodedCategoryName">
                        <div class="inventory-card-icon">
                            <i class="fas"></i>
                        </div>
                        <div class="inventory-card-category">@Html.Encode(categoryName)</div>
                        <div class="inventory-card-weight">@totalWeight.ToString("F1") kg</div>
                        <div class="inventory-card-price">价值: ¥@totalPrice.ToString("F2")</div>
                    </div>
                }
            }
        </div>

        <!-- 空状态提示 - 用于初始加载和AJAX刷新 -->
        <div id="inventoryEmptyState" class="empty-state" style="@(Model != null && Model.InventorySummary != null && Model.InventorySummary.Any() ? "display: none;" : "")">
            <i class="fas fa-box-open"></i>
            <p>暂无库存数据</p>
        </div>
    </div>

    <!-- 库存明细表格 - 独立的板块 -->
    <!-- Inventory Details Table - Independent Section -->
    <div class="section-card" style="margin-top: 25px;">
        <div id="inventoryDetailSection">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> 库存明细 <span id="inventoryDetailTitle"></span>
                </h2>
                <button class="btn-secondary" onclick="loadInventoryDetail()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <div id="inventoryDetailLoading" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <table class="receipts-table" id="inventoryDetailTable">
                <thead>
                    <tr>
                        <th>入库单号</th>
                        <th>品类</th>
                        <th>重量(kg)</th>
                        <th>价值(元)</th>
                        <th>回收员</th>
                        <th>入库时间</th>
                    </tr>
                </thead>
                <tbody id="inventoryDetailTableBody">
                    <!-- 初始加载提示 -->
                    <tr id="inventoryDetailInitialRow">
                        <td colspan="6" class="empty-details-message">
                            <i class="fas fa-spinner fa-spin"></i> 正在加载库存明细...
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- 分页 -->
            <div id="inventoryPaginationContainer" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div id="inventoryPaginationInfo" style="color: #666;"></div>
                <div id="inventoryPagination" class="pagination-controls">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .inventory-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .inventory-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .inventory-card.active {
        box-shadow: 0 0 0 3px #27ae60;
    }

    .inventory-card-icon {
        font-size: 32px;
        margin-bottom: 10px;
    }

    .inventory-card-category {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .inventory-card-weight {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .inventory-card-price {
        font-size: 14px;
        opacity: 0.9;
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
    }

    .pagination-controls button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-controls button.active {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
    }

    .badge-inventory {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-glass { background: #e3f2fd; color: #1976d2; }
    .badge-metal { background: #eceff1; color: #546e7a; }
    .badge-plastic { background: #ffebee; color: #c62828; }
    .badge-paper { background: #fff3e0; color: #e65100; }
    .badge-fabric { background: #f3e5f5; color: #7b1fa2; }
    .badge-unknown { background: #f5f5f5; color: #666; }

    .empty-details-message {
        text-align: center;
        padding: 30px;
        color: #999;
    }
    .badge-plastic { background: #ffebee; color: #c62828; }
    .badge-paper { background: #fff3e0; color: #e65100; }
    .badge-fabric { background: #f3e5f5; color: #7b1fa2; }
</style>

<script>
    var selectedOrderId = null;
    
    /**
     * 运输单数据缓存
     * Cache for transport order data to avoid storing JSON in HTML attributes
     * 
     * @@type {Object.<number, Object>}
     * @@description Stores complete transport order data indexed by TransportOrderID.
     *              This cache is populated on page load and refreshed via AJAX.
     *              Avoids HTML attribute encoding issues with JSON data.
     * 
     * @@example
     * transportOrdersCache[123] = {
     *     TransportOrderID: 123,
     *     OrderNumber: "TO20260119001",
     *     EstimatedWeight: 35.8,
     *     ItemCategories: '[{"categoryKey":"paper",...}]',
     *     RecyclerName: "张三",
     *     TransporterName: "李四"
     * }
     * 
     * @@lifecycle 
     * - Initialized on page load from Model data
     * - Updated when AJAX loads new transport orders
     * - Cleared and repopulated when refresh button is clicked
     */
    var transportOrdersCache = {};
    
    // 常量定义 - Constants for fallback text
    var FALLBACK_TEXT = {
        UNKNOWN_RECYCLER: '未知',
        UNKNOWN_TRANSPORTER: '未知',
        UNKNOWN_CATEGORY: '未知类别'
    };

    // 辅助函数：从AJAX错误响应中提取错误信息
    // Helper function: Extract error message from AJAX error response
    function extractErrorMessage(xhr) {
        var errorMsg = '网络错误，请稍后重试';
        if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMsg = xhr.responseJSON.message;
        } else if (xhr.responseText) {
            try {
                var response = JSON.parse(xhr.responseText);
                if (response.message) {
                    errorMsg = response.message;
                }
            } catch (e) {
                // 保持默认错误消息
            }
        }
        return errorMsg;
    }

    // 注意：页面加载时通过 AJAX 自动获取最新实时数据
    // Note: Data is automatically loaded via AJAX on page load for real-time display
    // 
    // 下面的 AJAX 函数在页面加载时自动调用，也可在用户点击"刷新"按钮时手动调用
    // The AJAX functions below are called automatically on page load and when user clicks "Refresh" buttons

    // 加载已完成的运输单（自动加载+手动刷新）
    // Load completed transport orders (auto-load + manual refresh)
    function loadCompletedTransportOrders() {
        $('#transitOrdersLoading').show();
        $('#transitOrdersList').hide().html('');

        $.ajax({
            url: '@Url.Action("GetCompletedTransportOrders", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayTransitOrders(response.data);
                } else {
                    $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p></div>').show();
                }
            },
            error: function () {
                $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>加载失败</p></div>').show();
            },
            complete: function () {
                $('#transitOrdersLoading').hide();
            }
        });
    }

    // 显示运输单列表
    function displayTransitOrders(orders) {
        if (orders && orders.length > 0) {
            var html = '';
            // 使用for循环优化性能（比forEach快）
            for (var i = 0; i < orders.length; i++) {
                var order = orders[i];
                
                // 合并更新缓存：新数据覆盖现有条目，避免清空导致的竞态条件
                // Merge into cache: new data overwrites existing entries, avoiding race condition from clearing
                transportOrdersCache[order.TransportOrderID] = order;
                
                html += '<div class="transit-order-item" data-order-id="' + order.TransportOrderID + '" ' +
                    'data-order-number="' + order.OrderNumber + '" ' +
                    'data-estimated-weight="' + order.EstimatedWeight + '" ' +
                    'data-recycler-name="' + (order.RecyclerName || '') + '" ' +
                    'data-transporter-name="' + (order.TransporterName || '') + '" ' +
                    'onclick="selectOrder(this)">' +
                    '<div class="order-info">' +
                    '<span class="order-number">' + order.OrderNumber + '</span>' +
                    '<span class="order-weight">' + order.EstimatedWeight.toFixed(2) + ' kg</span>' +
                    '</div>' +
                    '<div class="order-details">' +
                    '回收员：' + (order.RecyclerName || '-') + ' | ' +
                    '运输人员：' + (order.TransporterName || '-') +
                    '</div>';
                
                html += '</div>';
            }
            $('#transitOrdersList').html(html).show();
        } else {
            $('#transitOrdersList').html('<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无可入库的运输单</p></div>').show();
        }
    }

    // 选择运输单
    function selectOrder(element) {
        // 检查是否已创建入库单
        var orderId = $(element).data('order-id');
        
        $.ajax({
            url: '@Url.Action("CheckWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    if (response.hasReceipt) {
                        alert('该运输单已创建入库单');
                        return;
                    }
                    
                    // 从缓存中获取完整的订单数据
                    var orderData = transportOrdersCache[orderId];
                    if (!orderData) {
                        alert('无法获取运输单数据，请刷新页面后重试');
                        return;
                    }
                    
                    // 未创建入库单，可以继续
                    $('.transit-order-item').removeClass('selected');
                    $(element).addClass('selected');

                    selectedOrderId = orderId;
                    
                    // 填充表单数据（自动从运输单获取）
                    $('#selectedTransportOrderId').val(orderId);
                    $('#orderNumberDisplay').val(orderData.OrderNumber || '');
                    $('#recyclerNameDisplay').val(orderData.RecyclerName || FALLBACK_TEXT.UNKNOWN_RECYCLER);
                    $('#transporterNameDisplay').val(orderData.TransporterName || FALLBACK_TEXT.UNKNOWN_TRANSPORTER);
                    
                    var estimatedWeight = orderData.EstimatedWeight || 0;
                    $('#estimatedWeightDisplay').val(estimatedWeight);
                    $('#totalWeight').val(estimatedWeight); // 默认使用预估重量，可修改
                    
                    // 从缓存中获取ItemCategories（避免HTML属性编码问题）
                    var itemCategories = orderData.ItemCategories || '';
                    $('#itemCategories').val(itemCategories);
                    
                    // 解析并显示类别预览
                    displayCategoriesPreview(itemCategories);

                    $('#transitOrdersList').hide();
                    $('#receiptForm').show();
                } else {
                    alert('检查失败：' + response.message);
                }
            },
            error: function () {
                alert('网络错误');
            }
        });
    }

    // 显示物品类别表格
    function displayCategoriesPreview(categoriesJson) {
        var tableBody = $('#categoriesTableBody');
        var tableFooter = $('#categoriesTableFooter');
        
        // 清空表格
        tableBody.empty();
        
        if (!categoriesJson || categoriesJson.trim() === '') {
            tableBody.html(
                '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">' +
                '<i class="fas fa-info-circle"></i> 无类别信息</td></tr>'
            );
            tableFooter.hide();
            return;
        }
        
        try {
            var categories = JSON.parse(categoriesJson);
            if (!Array.isArray(categories) || categories.length === 0) {
                tableBody.html(
                    '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">' +
                    '<i class="fas fa-info-circle"></i> 无类别信息</td></tr>'
                );
                tableFooter.hide();
                return;
            }
            
            var totalWeight = 0;
            var totalPrice = 0;
            
            // 为每个类别创建一行
            categories.forEach(function(cat, index) {
                var weight = parseFloat(cat.weight || 0);
                var price = parseFloat(cat.price || 0);
                
                totalWeight += weight;
                totalPrice += price;
                
                // Escape HTML to prevent XSS
                var categoryName = $('<div>').text(cat.categoryName || FALLBACK_TEXT.UNKNOWN_CATEGORY).html();
                
                var row = '<tr style="border-bottom: 1px solid #e0e0e0;">' +
                    '<td style="padding: 10px; color: #2c3e50;"><i class="fas fa-box" style="margin-right: 5px; color: #27ae60;"></i>' + categoryName + '</td>' +
                    '<td style="padding: 10px; text-align: right; color: #555; font-weight: 500;">' + weight.toFixed(2) + '</td>' +
                    '<td style="padding: 10px; text-align: right; color: #555; font-weight: 500;">¥' + price.toFixed(2) + '</td>' +
                    '</tr>';
                
                tableBody.append(row);
            });
            
            // 显示总计
            $('#totalWeightDisplay').text(totalWeight.toFixed(2));
            $('#totalPriceDisplay').text('¥' + totalPrice.toFixed(2));
            tableFooter.show();
            
        } catch (e) {
            tableBody.html(
                '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #e74c3c;">' +
                '<i class="fas fa-exclamation-triangle"></i> 类别数据格式错误</td></tr>'
            );
            tableFooter.hide();
            console.error('解析类别数据失败:', e);
        }
    }

    // 取消选择
    function cancelSelection() {
        selectedOrderId = null;
        $('#receiptForm').hide();
        $('#transitOrdersList').show();
        $('.transit-order-item').removeClass('selected');
        $('#createReceiptForm')[0].reset();
        
        // 重置品类表格
        $('#categoriesTableBody').html(
            '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">' +
            '<i class="fas fa-info-circle"></i> 选择运输单后将自动显示</td></tr>'
        );
        $('#categoriesTableFooter').hide();
    }

    // 创建入库单
    function createReceipt() {
        var orderId = $('#selectedTransportOrderId').val();
        var weight = $('#totalWeight').val();
        var categories = $('#itemCategories').val();
        var notes = $('#notes').val();

        // 验证必填项
        if (!orderId || !weight || weight <= 0) {
            alert('请填写完整信息：运输单和重量为必填项');
            return;
        }

        // 验证品类数据
        if (!categories || categories.trim() === '') {
            alert('品类数据不能为空，请确保选择的运输单包含品类信息');
            return;
        }

        // 验证品类数据是否为有效的JSON
        try {
            var categoriesData = JSON.parse(categories);
            if (!Array.isArray(categoriesData) || categoriesData.length === 0) {
                alert('品类数据无效，请重新选择运输单');
                return;
            }
        } catch (e) {
            alert('品类数据格式错误，请重新选择运输单');
            return;
        }

        $.ajax({
            url: '@Url.Action("CreateWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                transportOrderId: orderId,
                totalWeight: weight,
                itemCategories: categories,
                notes: notes,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    alert('入库单创建成功！\n\n入库单号：' + response.receiptNumber + '\n\n提示：请在入库单列表中点击"入库"按钮完成入库操作。');
                    cancelSelection();
                    loadCompletedTransportOrders();
                    loadWarehouseReceipts();
                } else {
                    alert('创建失败：' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('创建入库单失败：' + extractErrorMessage(xhr));
            }
        });
    }

    // 处理入库单入库
    function processWarehouse(receiptId) {
        if (!confirm('确认要将该入库单入库吗？入库后将写入库存记录。')) {
            return;
        }

        $.ajax({
            url: '@Url.Action("ProcessWarehouseReceipt", "Staff")',
            type: 'POST',
            data: {
                receiptId: receiptId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    alert('入库成功！库存已更新。');
                    loadWarehouseReceipts();
                    loadInventorySummary(); // 刷新库存信息
                } else {
                    alert('入库失败：' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('入库失败：' + extractErrorMessage(xhr));
                console.error('入库错误详情:', error, xhr.responseText);
            }
        });
    }

    // 加载入库记录（自动加载+手动刷新）
    // Load warehouse receipts (auto-load + manual refresh)
    function loadWarehouseReceipts() {
        $('#receiptsLoading').show();
        $('#receiptsTableContainer').hide();
        $('#receiptsTable').hide();
        $('#receiptsEmptyState').hide();

        $.ajax({
            url: '@Url.Action("GetWarehouseReceipts", "Staff")',
            type: 'POST',
            data: {
                page: 1,
                pageSize: 50,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayReceipts(response.data);
                } else {
                    $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>' + response.message + '</p>').show();
                    $('#receiptsTableContainer').show();
                }
            },
            error: function () {
                $('#receiptsEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>加载失败</p>').show();
                $('#receiptsTableContainer').show();
            },
            complete: function () {
                $('#receiptsLoading').hide();
            }
        });
    }

    // 显示入库单
    function displayReceipts(receipts) {
        if (receipts && receipts.length > 0) {
            var tbody = $('#receiptsTableBody');
            tbody.empty();

            receipts.forEach(function (receipt) {
                var statusClass = receipt.Status === '待入库' ? 'status-pending' : 'status-completed';
                var actionButton = '';
                
                if (receipt.Status === '待入库') {
                    actionButton = '<button class="btn-warehouse" onclick="processWarehouse(' + receipt.ReceiptID + ')"><i class="fas fa-warehouse"></i> 入库</button>';
                } else {
                    actionButton = '<span style="color: #999;">-</span>';
                }

                var row = '<tr data-receipt-id="' + receipt.ReceiptID + '">' +
                    '<td>' + receipt.ReceiptNumber + '</td>' +
                    '<td>' + (receipt.TransportOrderNumber || '-') + '</td>' +
                    '<td>' + (receipt.RecyclerName || '-') + '</td>' +
                    '<td>' + receipt.TotalWeight.toFixed(2) + '</td>' +
                    '<td>' + formatDateTime(receipt.CreatedDate) + '</td>' +
                    '<td><span class="status-badge ' + statusClass + '">' + receipt.Status + '</span></td>' +
                    '<td>' + actionButton + '</td>' +
                    '</tr>';
                tbody.append(row);
            });

            $('#receiptsEmptyState').hide();
            $('#receiptsTableContainer').show();
            $('#receiptsTable').show();
        } else {
            $('#receiptsTable').hide();
            $('#receiptsTableContainer').show();
            $('#receiptsEmptyState').show();
        }
    }

    // 刷新运输单
    function refreshTransitOrders() {
        loadCompletedTransportOrders();
    }

    // 格式化日期时间
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        return date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0');
    }

    // ==================== 库存管理功能 ====================
    // Inventory Management Functions

    // 封装库存管理相关变量和函数 - Encapsulate inventory management variables and functions
    var InventoryManager = {
        currentPage: 1,
        pageSize: 20,
        currentCategoryKey: null,
        
        // 类别图标映射
        categoryIcons: {
            'glass': 'fa-wine-glass',
            'metal': 'fa-screwdriver-wrench',
            'plastic': 'fa-bottle-water',
            'paper': 'fa-file-lines',
            'fabric': 'fa-shirt'
        },

        // 类别颜色映射
        categoryColors: {
            'glass': '#3498db',
            'metal': '#95a5a6',
            'plastic': '#e74c3c',
            'paper': '#f39c12',
            'fabric': '#9b59b6'
        },

        // 显示错误消息
        showError: function(message) {
            var errorDiv = $('#inventoryEmptyState');
            errorDiv.html('<i class="fas fa-exclamation-circle"></i><p style="color: #e74c3c;">' + escapeHtml(message) + '</p>').show();
            setTimeout(function() {
                errorDiv.hide();
            }, 5000);
        },

        // 调整颜色亮度（简化版本）
        adjustColor: function(color, percent) {
            var num = parseInt(color.replace('#', ''), 16);
            var amt = Math.round(2.55 * percent);
            var R = Math.max(0, Math.min(255, (num >> 16) + amt));
            var G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
            var B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + ((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1);
        },

        // 验证类别键是否有效（严格的白名单验证）
        isValidCategoryKey: function(categoryKey) {
            if (!categoryKey || typeof categoryKey !== 'string') return false;
            // 严格的白名单：只允许预定义的类别键
            return this.categoryIcons.hasOwnProperty(categoryKey);
        },

        // 安全地转义 jQuery 选择器（使用更全面的转义）
        escapeSelector: function(selector) {
            if (!selector) return '';
            // 使用 CSS.escape 如果可用，否则使用手动转义
            if (window.CSS && window.CSS.escape) {
                return window.CSS.escape(selector);
            }
            // 回退到手动转义特殊字符
            return selector.replace(/[!"#$%&'()*+,.\/:;<=>?@@[\\\]^`{|}~]/g, '\\$&');
        },

        // 显示错误消息（使用安全的DOM创建）
        showError: function(message) {
            var errorDiv = $('#inventoryEmptyState');
            errorDiv.empty();
            var icon = $('<i>').addClass('fas fa-exclamation-circle');
            var text = $('<p>').css('color', '#e74c3c').text(message);
            errorDiv.append(icon).append(text).show();
            setTimeout(function() {
                errorDiv.hide();
            }, 5000);
        },

        // 获取已验证的 badge class 名称
        getBadgeClass: function(categoryKey) {
            if (!this.isValidCategoryKey(categoryKey)) return 'badge-unknown';
            return 'badge-' + categoryKey;
        }
    };

    // 加载库存汇总
    function loadInventorySummary() {
        $('#inventoryLoading').show();
        $('#inventorySummaryCards').hide();
        $('#inventoryEmptyState').hide();

        $.ajax({
            url: '@Url.Action("GetBaseWarehouseInventorySummary", "Staff")',
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success && response.data && response.data.length > 0) {
                    displayInventorySummary(response.data);
                } else {
                    $('#inventoryEmptyState').show();
                }
            },
            error: function () {
                $('#inventoryEmptyState').html('<i class="fas fa-exclamation-circle"></i><p>加载库存失败</p>').show();
            },
            complete: function () {
                $('#inventoryLoading').hide();
            }
        });
    }

    // 显示库存汇总卡片
    function displayInventorySummary(summaryData) {
        var container = $('#inventorySummaryCards');
        container.empty();

        summaryData.forEach(function (item) {
            // 验证并清理类别键
            if (!InventoryManager.isValidCategoryKey(item.categoryKey)) {
                console.warn('Invalid category key:', item.categoryKey);
                return; // 跳过无效的类别
            }

            var icon = InventoryManager.categoryIcons[item.categoryKey] || 'fa-box';
            var color = InventoryManager.categoryColors[item.categoryKey] || '#3498db';
            
            // 清理类别键用于 data 属性
            var safeCategoryKey = escapeHtml(item.categoryKey);
            var safeCategoryName = escapeHtml(item.categoryName);

            var card = $('<div>')
                .addClass('inventory-card')
                .attr('data-category', safeCategoryKey)
                .attr('data-category-name', safeCategoryName)
                .css('background', 'linear-gradient(135deg, ' + color + ' 0%, ' + InventoryManager.adjustColor(color, -20) + ' 100%)');
            
            // Safely create card content with validated icon class
            var iconDiv = $('<div>').addClass('inventory-card-icon').append($('<i>').addClass('fas ' + icon));
            var categoryDiv = $('<div>').addClass('inventory-card-category').text(item.categoryName);
            var weightDiv = $('<div>').addClass('inventory-card-weight').text(item.totalWeight.toFixed(1) + ' kg');
            var priceDiv = $('<div>').addClass('inventory-card-price').text('价值: ¥' + item.totalPrice.toFixed(2));
            
            card.append(iconDiv).append(categoryDiv).append(weightDiv).append(priceDiv);
            // 注意：不再使用内联 onclick，而是使用事件委托（见 document.ready）
            // Note: No longer using inline onclick, using event delegation instead (see document.ready)

            container.append(card);
        });

        container.show();
    }

    // 按类别筛选库存
    function filterInventoryByCategory(categoryKey, categoryName) {
        // 验证类别键
        if (!InventoryManager.isValidCategoryKey(categoryKey)) {
            console.error('Invalid category key:', categoryKey);
            return;
        }

        $('.inventory-card').removeClass('active');
        // 使用安全的选择器
        var safeSelector = '[data-category="' + InventoryManager.escapeSelector(categoryKey) + '"]';
        $('.inventory-card' + safeSelector).addClass('active');

        $('#inventoryDetailTitle').text(' - ' + categoryName);
        InventoryManager.currentCategoryKey = categoryKey;
        InventoryManager.currentPage = 1;
        loadInventoryDetail();
    }

    // 显示全部库存明细
    function showAllInventoryDetails() {
        $('.inventory-card').removeClass('active');
        $('#inventoryDetailTitle').text('');
        InventoryManager.currentCategoryKey = null;
        InventoryManager.currentPage = 1;
        loadInventoryDetail();
    }

    // 加载库存明细
    function loadInventoryDetail() {
        // 显示加载状态
        $('#inventoryDetailLoading').show();
        $('#inventoryDetailTable').hide();
        $('#inventoryPaginationContainer').hide();

        $.ajax({
            url: '@Url.Action("GetBaseWarehouseInventoryDetail", "Staff")',
            type: 'POST',
            data: {
                page: InventoryManager.currentPage,
                pageSize: InventoryManager.pageSize,
                categoryKey: InventoryManager.currentCategoryKey,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    displayInventoryDetail(response.data);
                } else {
                    showInventoryDetailError('加载库存明细失败: ' + response.message);
                }
            },
            error: function () {
                showInventoryDetailError('加载库存明细失败，请稍后重试');
            },
            complete: function () {
                $('#inventoryDetailLoading').hide();
                $('#inventoryDetailTable').show();
            }
        });
    }

    // 显示库存明细错误信息
    function showInventoryDetailError(message) {
        var tbody = $('#inventoryDetailTableBody');
        tbody.empty();
        var errorRow = $('<tr>').append(
            $('<td>').attr('colspan', '6').addClass('empty-details-message').html(
                '<i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i> ' + escapeHtml(message)
            )
        );
        tbody.append(errorRow);
        $('#inventoryPaginationContainer').hide();
    }

    // 显示库存明细
    function displayInventoryDetail(data) {
        var tbody = $('#inventoryDetailTableBody');
        tbody.empty();

        if (!data.Items || data.Items.length === 0) {
            var emptyRow = $('<tr>').append(
                $('<td>').attr('colspan', '6').addClass('empty-details-message').text('暂无明细数据')
            );
            tbody.append(emptyRow);
            $('#inventoryPaginationContainer').hide();
            return;
        }

        data.Items.forEach(function (item) {
            // 使用安全的 badge class 获取方法
            var badgeClass = InventoryManager.getBadgeClass(item.CategoryKey);
            var price = item.Price != null ? '¥' + item.Price.toFixed(2) : '-';
            var createdDate = formatDateTime(item.CreatedDate);

            var row = $('<tr>');
            row.append($('<td>').html('<strong>' + escapeHtml(item.OrderNumber) + '</strong>'));
            row.append($('<td>').html('<span class="badge-inventory ' + badgeClass + '">' + escapeHtml(item.CategoryName) + '</span>'));
            row.append($('<td>').text(item.Weight.toFixed(2)));
            row.append($('<td>').text(price));
            row.append($('<td>').text(item.RecyclerName || '-'));
            row.append($('<td>').text(createdDate));

            tbody.append(row);
        });

        displayInventoryPagination(data);
        $('#inventoryPaginationContainer').show();
    }

    // 显示分页控件
    function displayInventoryPagination(data) {
        var totalPages = Math.ceil(data.TotalCount / data.PageSize);
        var startItem = (data.PageIndex - 1) * data.PageSize + 1;
        var endItem = Math.min(data.PageIndex * data.PageSize, data.TotalCount);

        $('#inventoryPaginationInfo').text('显示 ' + startItem + ' - ' + endItem + ' 条，共 ' + data.TotalCount + ' 条');

        var pagination = $('#inventoryPagination');
        pagination.empty();

        if (totalPages <= 1) return;

        // 上一页
        var prevBtn = $('<button>')
            .text('上一页')
            .prop('disabled', data.PageIndex === 1)
            .on('click', function () {
                if (data.PageIndex > 1) {
                    InventoryManager.currentPage = data.PageIndex - 1;
                    loadInventoryDetail();
                }
            });
        pagination.append(prevBtn);

        // 页码按钮
        var startPage = Math.max(1, data.PageIndex - 2);
        var endPage = Math.min(totalPages, data.PageIndex + 2);

        for (var i = startPage; i <= endPage; i++) {
            (function (pageNum) {
                var pageBtn = $('<button>')
                    .text(pageNum)
                    .toggleClass('active', pageNum === data.PageIndex)
                    .on('click', function () {
                        InventoryManager.currentPage = pageNum;
                        loadInventoryDetail();
                    });
                pagination.append(pageBtn);
            })(i);
        }

        // 下一页
        var nextBtn = $('<button>')
            .text('下一页')
            .prop('disabled', data.PageIndex >= totalPages)
            .on('click', function () {
                if (data.PageIndex < totalPages) {
                    InventoryManager.currentPage = data.PageIndex + 1;
                    loadInventoryDetail();
                }
            });
        pagination.append(nextBtn);
    }

    // HTML转义函数（防止XSS）
    function escapeHtml(text) {
        if (!text) return '';
        return $('<div>').text(text).html();
    }

    // 页面加载时自动加载所有实时数据
    // Automatically load all real-time data on page load
    $(document).ready(function () {
        // 初始化缓存：将服务器端渲染的订单数据加载到缓存中
        // Initialize cache: Load server-side rendered order data into cache
        // Note: Data is validated and sanitized at the server level (BLL/DAL) before being passed to the view
        // Json.Encode() provides additional XSS protection by properly escaping special characters
        @if (Model != null && Model.CompletedTransportOrders != null && Model.CompletedTransportOrders.Any())
        {
            <text>
            var initialOrders = [
                @{
                    var ordersList = Model.CompletedTransportOrders.ToList();
                    for (int i = 0; i < ordersList.Count; i++)
                    {
                        var order = ordersList[i];
                        var isLast = (i == ordersList.Count - 1);
                        <text>{
                        TransportOrderID: @order.TransportOrderID,
                        OrderNumber: '@Html.Raw(Json.Encode(order.OrderNumber))',
                        EstimatedWeight: @order.EstimatedWeight,
                        ItemCategories: '@Html.Raw(Json.Encode(order.ItemCategories ?? ""))',
                        RecyclerName: '@Html.Raw(Json.Encode(order.RecyclerName ?? ""))',
                        TransporterName: '@Html.Raw(Json.Encode(order.TransporterName ?? ""))'
                    }@(isLast ? "" : ",")</text>
                    }
                }
            ];
            // 填充缓存（批量操作优化）
            // Populate cache in bulk (performance optimized)
            if (initialOrders.length > 0) {
                for (var i = 0; i < initialOrders.length; i++) {
                    var order = initialOrders[i];
                    transportOrdersCache[order.TransportOrderID] = order;
                }
            }
            </text>
        }
        
        // 使用事件委托为库存卡片添加点击处理
        // Use event delegation for inventory card click handling
        $(document).on('click', '.inventory-card', function() {
            var card = $(this);
            var categoryKey = card.data('category');
            var categoryName = card.data('category-name');
            
            if (categoryKey && categoryName) {
                filterInventoryByCategory(categoryKey, categoryName);
            }
        });
        
        // 为服务器端渲染的库存卡片应用颜色和图标（立即显示正确颜色）
        // Apply colors and icons to server-side rendered inventory cards (show correct colors immediately)
        applyInventoryCardStyles();
        
        // 自动加载所有实时数据（与点击刷新按钮效果一致）
        // Automatically load all real-time data (same effect as clicking refresh buttons)
        loadCompletedTransportOrders();  // 加载待入库运输单
        loadWarehouseReceipts();         // 加载入库记录
        loadInventorySummary();          // 加载库存汇总（刷新实时数据）
        loadInventoryDetail();           // 加载库存明细（独立板块）
    });
    
    // 为服务器端渲染的库存卡片应用颜色和图标
    // Apply colors and icons to server-side rendered inventory cards on page load
    function applyInventoryCardStyles() {
        $('.inventory-card').each(function() {
            var card = $(this);
            var categoryKey = card.data('category');
            
            if (categoryKey && InventoryManager.isValidCategoryKey(categoryKey)) {
                var icon = InventoryManager.categoryIcons[categoryKey] || 'fa-box';
                var color = InventoryManager.categoryColors[categoryKey] || '#3498db';
                
                // 应用渐变背景色 - Apply gradient background color
                card.css('background', 'linear-gradient(135deg, ' + color + ' 0%, ' + InventoryManager.adjustColor(color, -20) + ' 100%)');
                
                // 应用图标 - Apply icon
                var iconElement = card.find('.inventory-card-icon i');
                if (iconElement.length > 0) {
                    iconElement.removeClass().addClass('fas ' + icon);
                }
            }
        });
    }
</script>
