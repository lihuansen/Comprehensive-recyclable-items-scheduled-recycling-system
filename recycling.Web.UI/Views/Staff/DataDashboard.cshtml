@{
    ViewBag.Title = "数据看板";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-header {
        margin-bottom: 30px;
        text-align: center;
    }

    .dashboard-header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
    }

    .dashboard-header p {
        color: #666;
        font-size: 14px;
    }

    .stats-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        flex: 1;
        min-width: 200px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .stat-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .stat-icon {
        font-size: 36px;
        margin-bottom: 10px;
        opacity: 0.9;
    }

    .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .stat-change {
        font-size: 12px;
        margin-top: 10px;
        padding: 3px 8px;
        border-radius: 10px;
        display: inline-block;
    }

    .stat-change.up {
        background: rgba(255,255,255,0.3);
    }

    .stat-change.down {
        background: rgba(255,255,255,0.3);
    }

    .chart-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .data-table-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .data-table-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .data-table-card h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 10px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table th {
        font-weight: 600;
        color: #666;
        font-size: 13px;
    }

    .data-table tr:hover {
        background: #f9f9f9;
    }

    .data-table .rank {
        width: 40px;
        text-align: center;
    }

    .data-table .rank-badge {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
    }

    .data-table .rank-badge.gold {
        background: #ffd700;
        color: #333;
    }

    .data-table .rank-badge.silver {
        background: #c0c0c0;
        color: #333;
    }

    .data-table .rank-badge.bronze {
        background: #cd7f32;
        color: white;
    }

    .data-table .rank-badge.normal {
        background: #e0e0e0;
        color: #666;
    }

    .rating-stars {
        color: #ffc107;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.pending {
        background: #fff3e0;
        color: #ef6c00;
    }

    .status-badge.processing {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-badge.completed {
        background: #e8f5e9;
        color: #388e3c;
    }

    .status-badge.cancelled {
        background: #ffebee;
        color: #c62828;
    }

    .summary-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .summary-icon.users {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .summary-icon.recyclers {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .summary-icon.orders {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .summary-icon.weight {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .summary-icon.revenue {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .summary-icon.feedback {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }

    .summary-content h4 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 24px;
        font-weight: bold;
    }

    .summary-content p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        cursor: pointer;
        font-size: 20px;
        transition: transform 0.3s;
    }

    .refresh-btn:hover {
        transform: scale(1.1);
    }

    .last-updated {
        text-align: center;
        color: #999;
        font-size: 12px;
        margin-top: 20px;
    }

    @@media (max-width: 768px) {
        .stats-row {
            flex-direction: column;
        }

        .stat-card {
            min-width: 100%;
        }

        .chart-section,
        .data-table-section,
        .summary-section {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }
    }
</style>

<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-chart-line"></i> 数据看板</h1>
        <p>系统运营数据实时监控与分析</p>
    </div>

    <!-- Key Metrics -->
    <div class="stats-row">
        <div class="stat-card primary">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">总用户数</div>
            <div class="stat-change up" id="newUsersThisMonth">本月新增: -</div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-recycle"></i></div>
            <div class="stat-value" id="totalRecyclers">-</div>
            <div class="stat-label">回收员总数</div>
            <div class="stat-change up" id="availableRecyclers">当前可接单: -</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
            <div class="stat-value" id="totalOrders">-</div>
            <div class="stat-label">总订单数</div>
            <div class="stat-change up" id="ordersThisMonth">本月订单: -</div>
        </div>
        <div class="stat-card info">
            <div class="stat-icon"><i class="fas fa-weight"></i></div>
            <div class="stat-value" id="totalWeight">-</div>
            <div class="stat-label">总回收重量(kg)</div>
            <div class="stat-change up" id="weightThisMonth">本月回收: -</div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
        <div class="summary-card">
            <div class="summary-icon users"><i class="fas fa-user-check"></i></div>
            <div class="summary-content">
                <h4 id="activeUsersThisWeek">-</h4>
                <p>本周活跃用户</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon recyclers"><i class="fas fa-star"></i></div>
            <div class="summary-content">
                <h4 id="avgRecyclerRating">-</h4>
                <p>回收员平均评分</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon orders"><i class="fas fa-clock"></i></div>
            <div class="summary-content">
                <h4 id="pendingOrders">-</h4>
                <p>待处理订单</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon weight"><i class="fas fa-running"></i></div>
            <div class="summary-content">
                <h4 id="inProgressOrders">-</h4>
                <p>进行中订单</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon revenue"><i class="fas fa-yen-sign"></i></div>
            <div class="summary-content">
                <h4 id="totalRevenue">-</h4>
                <p>总交易金额</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon feedback"><i class="fas fa-comment-dots"></i></div>
            <div class="summary-content">
                <h4 id="pendingFeedbacks">-</h4>
                <p>待处理反馈</p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-section">
        <div class="chart-card">
            <h3><i class="fas fa-chart-bar"></i> 近7天订单趋势</h3>
            <div class="chart-container">
                <canvas id="orderTrendChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3><i class="fas fa-chart-pie"></i> 订单状态分布</h3>
            <div class="chart-container">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3><i class="fas fa-chart-line"></i> 近6月订单趋势</h3>
            <div class="chart-container">
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3><i class="fas fa-tags"></i> 回收品类分布</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="data-table-section">
        <div class="data-table-card">
            <h3><i class="fas fa-trophy"></i> 回收员业绩排行</h3>
            <table class="data-table" id="topRecyclersTable">
                <thead>
                    <tr>
                        <th class="rank">排名</th>
                        <th>姓名</th>
                        <th>评分</th>
                        <th>完成订单</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="data-table-card">
            <h3><i class="fas fa-map-marker-alt"></i> 区域分布</h3>
            <table class="data-table" id="regionTable">
                <thead>
                    <tr>
                        <th class="rank">排名</th>
                        <th>区域</th>
                        <th>回收员数量</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="data-table-card">
            <h3><i class="fas fa-warehouse"></i> 库存统计</h3>
            <table class="data-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>品类</th>
                        <th>总重量(kg)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="2" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="data-table-card">
            <h3><i class="fas fa-info-circle"></i> 系统概览</h3>
            <table class="data-table" id="systemOverviewTable">
                <tbody>
                    <tr>
                        <td>管理员总数</td>
                        <td id="totalAdmins">-</td>
                    </tr>
                    <tr>
                        <td>激活管理员</td>
                        <td id="activeAdmins">-</td>
                    </tr>
                    <tr>
                        <td>总评价数</td>
                        <td id="totalReviews">-</td>
                    </tr>
                    <tr>
                        <td>平均评价分</td>
                        <td id="avgReviewRating">-</td>
                    </tr>
                    <tr>
                        <td>总反馈数</td>
                        <td id="totalFeedbacks">-</td>
                    </tr>
                    <tr>
                        <td>已处理反馈</td>
                        <td id="processedFeedbacks">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="last-updated">
        最后更新时间: <span id="lastUpdatedTime">-</span>
    </div>
</div>

<button class="refresh-btn" onclick="loadDashboardData()" title="刷新数据">
    <i class="fas fa-sync-alt"></i>
</button>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        var orderTrendChart, orderStatusChart, monthlyTrendChart, categoryChart;

        $(document).ready(function () {
            loadDashboardData();
        });

        function loadDashboardData() {
            $('#loadingOverlay').show();

            $.ajax({
                url: '@Url.Action("GetDashboardStatistics", "Staff")',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        updateDashboard(response.data);
                    } else {
                        // Show fallback values when API returns error
                        showFallbackDashboard();
                        console.error('加载数据失败: ' + response.message);
                    }
                },
                error: function () {
                    // Show fallback values on network error
                    showFallbackDashboard();
                    console.error('网络错误，请稍后重试');
                },
                complete: function () {
                    $('#loadingOverlay').hide();
                }
            });
        }

        function showFallbackDashboard() {
            // Set fallback values for key metrics
            $('#totalUsers').text('0');
            $('#newUsersThisMonth').text('本月新增: 0');
            $('#totalRecyclers').text('0');
            $('#availableRecyclers').text('当前可接单: 0');
            $('#totalOrders').text('0');
            $('#ordersThisMonth').text('本月订单: 0');
            $('#totalWeight').text('0');
            $('#weightThisMonth').text('本月回收: 0kg');

            // Set fallback values for summary cards
            $('#activeUsersThisWeek').text('0');
            $('#avgRecyclerRating').text('0.00');
            $('#pendingOrders').text('0');
            $('#inProgressOrders').text('0');
            $('#totalRevenue').text('¥0.00');
            $('#pendingFeedbacks').text('0');

            // Set fallback values for system overview
            $('#totalAdmins').text('0');
            $('#activeAdmins').text('0');
            $('#totalReviews').text('0');
            $('#avgReviewRating').text('0.00 分');
            $('#totalFeedbacks').text('0');
            $('#processedFeedbacks').text('0');

            // Update tables with no data message
            $('#topRecyclersTable tbody').html('<tr><td colspan="4" style="text-align:center;color:#999;">暂无数据</td></tr>');
            $('#regionTable tbody').html('<tr><td colspan="3" style="text-align:center;color:#999;">暂无数据</td></tr>');
            $('#inventoryTable tbody').html('<tr><td colspan="2" style="text-align:center;color:#999;">暂无数据</td></tr>');

            // Update last updated time
            $('#lastUpdatedTime').text(new Date().toLocaleString('zh-CN'));
        }

        function updateDashboard(data) {
            // Update key metrics
            $('#totalUsers').text(formatNumber(data.TotalUsers));
            $('#newUsersThisMonth').text('本月新增: ' + formatNumber(data.NewUsersThisMonth));
            $('#totalRecyclers').text(formatNumber(data.TotalRecyclers));
            $('#availableRecyclers').text('当前可接单: ' + formatNumber(data.AvailableRecyclers));
            $('#totalOrders').text(formatNumber(data.TotalOrders));
            $('#ordersThisMonth').text('本月订单: ' + formatNumber(data.OrdersThisMonth));
            $('#totalWeight').text(formatNumber(data.TotalWeightCollected, 1));
            $('#weightThisMonth').text('本月回收: ' + formatNumber(data.WeightThisMonth, 1) + 'kg');

            // Update summary cards
            $('#activeUsersThisWeek').text(formatNumber(data.ActiveUsersThisWeek));
            $('#avgRecyclerRating').text(parseFloat(data.AverageRecyclerRating).toFixed(2));
            $('#pendingOrders').text(formatNumber(data.PendingOrders));
            $('#inProgressOrders').text(formatNumber(data.InProgressOrders));
            $('#totalRevenue').text('¥' + formatNumber(data.TotalRevenue, 2));
            $('#pendingFeedbacks').text(formatNumber(data.PendingFeedbacks));

            // Update system overview
            $('#totalAdmins').text(formatNumber(data.TotalAdmins));
            $('#activeAdmins').text(formatNumber(data.ActiveAdmins));
            $('#totalReviews').text(formatNumber(data.TotalReviews));
            $('#avgReviewRating').text(parseFloat(data.AverageReviewRating).toFixed(2) + ' 分');
            $('#totalFeedbacks').text(formatNumber(data.TotalFeedbacks));
            $('#processedFeedbacks').text(formatNumber(data.ProcessedFeedbacks));

            // Update charts
            updateOrderTrendChart(data.OrderTrend);
            updateOrderStatusChart(data.OrderStatusDistribution);
            updateMonthlyTrendChart(data.MonthlyOrderTrend);
            updateCategoryChart(data.CategoryDistribution);

            // Update tables
            updateTopRecyclersTable(data.TopRecyclers);
            updateRegionTable(data.RegionDistribution);
            updateInventoryTable(data.InventoryStats);

            // Update last updated time
            $('#lastUpdatedTime').text(new Date().toLocaleString('zh-CN'));
        }

        function formatNumber(num, decimals) {
            if (num === null || num === undefined) return '0';
            decimals = decimals || 0;
            return parseFloat(num).toLocaleString('zh-CN', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function updateOrderTrendChart(data) {
            var ctx = document.getElementById('orderTrendChart').getContext('2d');

            if (orderTrendChart) {
                orderTrendChart.destroy();
            }

            var labels = data ? data.map(function (d) { return d.Date; }) : [];
            var values = data ? data.map(function (d) { return d.Count; }) : [];

            // Fill missing days with 0
            var today = new Date();
            var filledLabels = [];
            var filledValues = [];
            for (var i = 6; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                var dateStr = (date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0');
                filledLabels.push(dateStr);
                var idx = labels.indexOf(dateStr);
                filledValues.push(idx >= 0 ? values[idx] : 0);
            }

            orderTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filledLabels,
                    datasets: [{
                        label: '订单数',
                        data: filledValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateOrderStatusChart(data) {
            var ctx = document.getElementById('orderStatusChart').getContext('2d');

            if (orderStatusChart) {
                orderStatusChart.destroy();
            }

            var labels = data ? data.map(function (d) { return d.Status; }) : [];
            var values = data ? data.map(function (d) { return d.Count; }) : [];
            var colors = ['#667eea', '#38ef7d', '#f5576c', '#ffc107', '#17a2b8'];

            orderStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateMonthlyTrendChart(data) {
            var ctx = document.getElementById('monthlyTrendChart').getContext('2d');

            if (monthlyTrendChart) {
                monthlyTrendChart.destroy();
            }

            var labels = data ? data.map(function (d) { return d.Month; }) : [];
            var values = data ? data.map(function (d) { return d.Count; }) : [];

            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '订单数',
                        data: values,
                        fill: true,
                        backgroundColor: 'rgba(17, 153, 142, 0.2)',
                        borderColor: 'rgba(17, 153, 142, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(17, 153, 142, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateCategoryChart(data) {
            var ctx = document.getElementById('categoryChart').getContext('2d');

            if (categoryChart) {
                categoryChart.destroy();
            }

            var labels = data ? data.map(function (d) { return d.Category; }) : [];
            var values = data ? data.map(function (d) { return d.Count; }) : [];
            var colors = ['#667eea', '#38ef7d', '#f5576c', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14'];

            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateTopRecyclersTable(data) {
            var tbody = $('#topRecyclersTable tbody');
            tbody.empty();

            if (!data || data.length === 0) {
                tbody.append('<tr><td colspan="4" style="text-align:center;color:#999;">暂无数据</td></tr>');
                return;
            }

            data.forEach(function (item, index) {
                var rankClass = index === 0 ? 'gold' : (index === 1 ? 'silver' : (index === 2 ? 'bronze' : 'normal'));
                var rating = parseFloat(item.Rating).toFixed(1);
                var stars = getStarRating(rating);

                tbody.append(
                    '<tr>' +
                    '<td class="rank"><span class="rank-badge ' + rankClass + '">' + (index + 1) + '</span></td>' +
                    '<td>' + escapeHtml(item.Name) + '</td>' +
                    '<td><span class="rating-stars">' + stars + '</span> ' + rating + '</td>' +
                    '<td>' + item.CompletedOrders + '</td>' +
                    '</tr>'
                );
            });
        }

        function updateRegionTable(data) {
            var tbody = $('#regionTable tbody');
            tbody.empty();

            if (!data || data.length === 0) {
                tbody.append('<tr><td colspan="3" style="text-align:center;color:#999;">暂无数据</td></tr>');
                return;
            }

            data.forEach(function (item, index) {
                var rankClass = index === 0 ? 'gold' : (index === 1 ? 'silver' : (index === 2 ? 'bronze' : 'normal'));

                tbody.append(
                    '<tr>' +
                    '<td class="rank"><span class="rank-badge ' + rankClass + '">' + (index + 1) + '</span></td>' +
                    '<td>' + escapeHtml(item.Region) + '</td>' +
                    '<td>' + item.Count + '</td>' +
                    '</tr>'
                );
            });
        }

        function updateInventoryTable(data) {
            var tbody = $('#inventoryTable tbody');
            tbody.empty();

            if (!data || data.length === 0) {
                tbody.append('<tr><td colspan="2" style="text-align:center;color:#999;">暂无数据</td></tr>');
                return;
            }

            data.forEach(function (item) {
                tbody.append(
                    '<tr>' +
                    '<td>' + escapeHtml(item.CategoryName) + '</td>' +
                    '<td>' + formatNumber(item.TotalWeight, 2) + '</td>' +
                    '</tr>'
                );
            });
        }

        function getStarRating(rating) {
            var fullStars = Math.floor(rating);
            var halfStar = (rating - fullStars) >= 0.5;
            var emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            var html = '';
            for (var i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                html += '<i class="fas fa-star-half-alt"></i>';
            }
            for (var i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star"></i>';
            }
            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }
    </script>
}
