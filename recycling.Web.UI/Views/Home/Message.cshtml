@{
    ViewBag.Title = "我的消息";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .notification-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .notification-header h3 {
        margin: 0;
        color: #333;
    }
    
    .notification-header .badge {
        background-color: #dc3545;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 14px;
        margin-left: 10px;
    }
    
    .notification-actions {
        display: flex;
        gap: 10px;
    }
    
    .notification-actions .btn {
        padding: 6px 15px;
        font-size: 14px;
    }
    
    .notification-list {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .notification-item {
        display: flex;
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
        cursor: pointer;
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .notification-item:hover {
        background-color: #f8f9fa;
    }
    
    .notification-item.unread {
        background-color: #f0f7ff;
    }
    
    .notification-item.unread:hover {
        background-color: #e3f0ff;
    }
    
    .notification-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .notification-icon i {
        font-size: 18px;
        color: white;
    }
    
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    
    .notification-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    
    .notification-title .type-badge {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 10px;
        font-weight: normal;
    }
    
    .notification-text {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 5px;
    }
    
    .notification-time {
        color: #999;
        font-size: 12px;
    }
    
    .notification-actions-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-left: 15px;
    }
    
    .notification-actions-item .btn-action {
        padding: 5px 10px;
        font-size: 12px;
        border: none;
        background: none;
        color: #007bff;
        cursor: pointer;
    }
    
    .notification-actions-item .btn-action:hover {
        text-decoration: underline;
    }
    
    .notification-actions-item .btn-delete {
        color: #dc3545;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state i {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ddd;
    }
    
    .empty-state h4 {
        margin-bottom: 10px;
        color: #666;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        padding: 15px;
    }
    
    .pagination-container .btn {
        margin: 0 5px;
    }
    
    .unread-dot {
        width: 8px;
        height: 8px;
        background-color: #007bff;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner i {
        font-size: 30px;
        color: #007bff;
    }
</style>

<div class="notification-container">
    <div class="notification-header">
        <div>
            <h3>
                <i class="fas fa-bell"></i> 我的消息
                <span id="unreadBadge" class="badge" style="display: none;">0</span>
            </h3>
            <p class="text-muted mb-0" style="font-size: 14px;">接收系统通知和订单状态更新</p>
        </div>
        <div class="notification-actions">
            <button id="btnMarkAllRead" class="btn btn-outline-primary btn-sm" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i> 全部已读
            </button>
            <button id="btnRefresh" class="btn btn-outline-secondary btn-sm" onclick="loadNotifications(1)">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
        </div>
    </div>

    <div class="notification-list" id="notificationList">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
    </div>

    <div class="pagination-container" id="paginationContainer" style="display: none;">
        <button id="btnPrevPage" class="btn btn-outline-secondary btn-sm" onclick="loadNotifications(currentPage - 1)" disabled>
            <i class="fas fa-chevron-left"></i> 上一页
        </button>
        <span id="pageInfo" style="margin: 0 15px; line-height: 32px;"></span>
        <button id="btnNextPage" class="btn btn-outline-secondary btn-sm" onclick="loadNotifications(currentPage + 1)" disabled>
            下一页 <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

@section scripts {
    <script>
        var currentPage = 1;
        var totalPages = 1;
        var pageSize = 15;

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function loadNotifications(page) {
            if (page < 1) page = 1;
            currentPage = page;

            var container = document.getElementById('notificationList');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>加载中...</p></div>';

            fetch('@Url.Action("GetUserNotifications", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'pageIndex=' + page + '&pageSize=' + pageSize
            })
            .then(r => r.json())
            .then(data => {
                container.innerHTML = '';

                if (data.success) {
                    // Update unread badge
                    var badge = document.getElementById('unreadBadge');
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }

                    // Update pagination
                    totalPages = data.totalPages;
                    updatePagination(data.totalCount, page, totalPages);

                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach(function(n) {
                            var itemHtml = createNotificationItem(n);
                            container.innerHTML += itemHtml;
                        });
                    } else {
                        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h4>暂无消息</h4><p>您还没有收到任何通知消息</p></div>';
                    }
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>加载失败</h4><p>' + escapeHtml(data.message || '请稍后重试') + '</p></div>';
                }
            })
            .catch(err => {
                console.error('加载通知失败', err);
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>加载失败</h4><p>网络错误，请稍后重试</p></div>';
            });
        }

        function createNotificationItem(n) {
            var unreadClass = n.isRead ? '' : ' unread';
            var unreadDot = n.isRead ? '' : '<span class="unread-dot"></span>';
            
            var actionButton = '';
            if (n.relatedOrderId && n.notificationType !== 'OrderCancelled') {
                if (n.notificationType === 'ReviewReminder') {
                    actionButton = '<button class="btn-action" onclick="event.stopPropagation(); goToReview(' + n.relatedOrderId + ')">去评价</button>';
                } else {
                    actionButton = '<button class="btn-action" onclick="event.stopPropagation(); goToOrder(' + n.relatedOrderId + ')">查看订单</button>';
                }
            } else if (n.relatedFeedbackId) {
                actionButton = '<button class="btn-action" onclick="event.stopPropagation(); goToFeedback()">查看反馈</button>';
            }

            var html = '<div class="notification-item' + unreadClass + '" data-id="' + n.notificationId + '" onclick="markAsRead(' + n.notificationId + ')">' +
                '<div class="notification-icon" style="background-color: ' + escapeHtml(n.typeColor) + ';">' +
                    '<i class="fas ' + escapeHtml(n.typeIcon) + '"></i>' +
                '</div>' +
                '<div class="notification-content">' +
                    '<div class="notification-title">' +
                        unreadDot +
                        escapeHtml(n.title) +
                        '<span class="type-badge" style="background-color: ' + escapeHtml(n.typeColor) + '22; color: ' + escapeHtml(n.typeColor) + ';">' + escapeHtml(n.typeDisplayName) + '</span>' +
                    '</div>' +
                    '<div class="notification-text">' + escapeHtml(n.content) + '</div>' +
                    '<div class="notification-time"><i class="far fa-clock"></i> ' + escapeHtml(n.createdDate) + '</div>' +
                '</div>' +
                '<div class="notification-actions-item">' +
                    actionButton +
                    '<button class="btn-action btn-delete" onclick="event.stopPropagation(); deleteNotification(' + n.notificationId + ')"><i class="fas fa-trash"></i></button>' +
                '</div>' +
            '</div>';

            return html;
        }

        function updatePagination(total, current, pages) {
            var paginationContainer = document.getElementById('paginationContainer');
            var pageInfo = document.getElementById('pageInfo');
            var btnPrev = document.getElementById('btnPrevPage');
            var btnNext = document.getElementById('btnNextPage');

            if (total > pageSize) {
                paginationContainer.style.display = 'flex';
                pageInfo.textContent = '第 ' + current + ' 页 / 共 ' + pages + ' 页 (共 ' + total + ' 条)';
                
                btnPrev.disabled = current <= 1;
                btnNext.disabled = current >= pages;
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function markAsRead(notificationId) {
            var item = document.querySelector('.notification-item[data-id="' + notificationId + '"]');
            if (item && item.classList.contains('unread')) {
                fetch('@Url.Action("MarkNotificationAsRead", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'notificationId=' + notificationId
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        item.classList.remove('unread');
                        var dot = item.querySelector('.unread-dot');
                        if (dot) dot.remove();
                        
                        // Update badge count
                        var badge = document.getElementById('unreadBadge');
                        var count = parseInt(badge.textContent) - 1;
                        if (count > 0) {
                            badge.textContent = count;
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(err => console.error('标记已读失败', err));
            }
        }

        function markAllAsRead() {
            fetch('@Url.Action("MarkAllNotificationsAsRead", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Reload notifications
                    loadNotifications(currentPage);
                }
            })
            .catch(err => console.error('标记全部已读失败', err));
        }

        function deleteNotification(notificationId) {
            if (!confirm('确定要删除这条通知吗？')) return;

            fetch('@Url.Action("DeleteNotification", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'notificationId=' + notificationId
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Reload notifications
                    loadNotifications(currentPage);
                } else {
                    alert('删除失败：' + (data.message || '请稍后重试'));
                }
            })
            .catch(err => {
                console.error('删除通知失败', err);
                alert('删除失败，请稍后重试');
            });
        }

        function goToOrder(orderId) {
            window.location.href = '@Url.Action("Order", "Home")';
        }

        function goToReview(orderId) {
            window.location.href = '@Url.Action("ReviewOrder", "Home")?orderId=' + orderId;
        }

        function goToFeedback() {
            window.location.href = '@Url.Action("MyFeedback", "Home")';
        }

        // Load notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications(1);
        });
    </script>
}