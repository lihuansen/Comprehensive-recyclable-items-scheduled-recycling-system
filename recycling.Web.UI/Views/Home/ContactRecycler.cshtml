@model dynamic
@{
    ViewBag.Title = "联系回收员";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    #sendMessage {
        background-color: #3498db;
        color: white;
    }

    #endConversationBtn {
        background-color: #e74c3c;
        color: white;
    }

    .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }

    .message-bubble.user-message {
        background-color: #3498db;
        color: white;
    }

    .message-bubble.recycler-message {
        background-color: #ecf0f1;
        color: #2c3e50;
    }

    .message-time {
        font-size: 0.75em;
        color: #7f8c8d;
        margin-top: 4px;
    }

    .message-sender {
        font-size: 0.85em;
        font-weight: 500;
        margin-bottom: 4px;
        color: #7f8c8d;
    }
</style>

<div class="container mt-4">
    <div class="card">
        <!-- 聊天头部（含订单信息） -->
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">与 @ViewBag.RecyclerName 对话</h5>
            <small>订单编号：@ViewBag.OrderNumber</small>
        </div>

        <!-- 聊天消息区域 -->
        <div class="card-body" id="chatMessages" style="height: 500px; overflow-y: auto; background-color: #f8f9fa; padding: 20px;">
            @* 消息列表通过AJAX动态加载 *@
            <div class="text-center text-muted" id="loadingMsg">加载聊天记录中...</div>
        </div>

        <!-- 消息输入区域 -->
        <div class="card-footer">
            <div class="input-group">
                <input type="text" id="messageContent" class="form-control" placeholder="请输入消息内容...">
                <span class="input-group-btn">
                    <button id="sendMessage" class="btn btn-primary">发送</button>
                </span>
                <span class="input-group-btn">
                    <button id="endConversationBtn" class="btn btn-danger">结束对话</button>
                </span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <script>
        // 页面初始化参数（从ViewBag获取）
        var orderId = @ViewBag.OrderId;
        var userId = @ViewBag.UserId;
        var recyclerId = @ViewBag.RecyclerId;

        // 加载历史消息
        function loadMessages() {
            $.ajax({
                url: "/Home/GetUserOrderConversation",
                type: "POST",
                data: { orderId: orderId },
                success: function (res) {
                    if (res.success) {
                        renderMessages(res.data);
                        $("#loadingMsg").hide();
                    } else {
                        $("#chatMessages").html(`<div class="text-danger text-center">加载失败：${res.message}</div>`);
                    }
                },
                error: function () {
                    $("#chatMessages").html(`<div class="text-danger text-center">网络错误，无法加载消息</div>`);
                }
            });
        }

        // 渲染消息列表（区分用户/回收员消息位置）
        function renderMessages(messages) {
            var messagesHtml = "";
            messages.forEach(function (msg) {
                // 判断发送者类型，用户消息居右，回收员消息居左
                var isUserMessage = msg.senderType === "user" && msg.senderId === userId;
                var alignClass = isUserMessage ? "text-right" : "text-left";
                var bubbleClass = isUserMessage ? "user-message" : "recycler-message";
                var senderName = isUserMessage ? "我" : (msg.senderName || "回收员");

                messagesHtml += `
                    <div class="${alignClass} mb-3">
                        <div class="message-sender">${senderName}</div>
                        <div class="message-bubble ${bubbleClass}">
                            ${escapeHtml(msg.content)}
                        </div>
                        <div class="message-time">${formatTime(msg.sentTime)}</div>
                    </div>
                `;
            });
            $("#chatMessages").html(messagesHtml);
            // 滚动到底部
            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
        }

        // HTML转义函数
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // 时间格式化
        function formatTime(isoTime) {
            if (!isoTime) return "";
            var date = new Date(isoTime);
            return date.toLocaleString("zh-CN", {
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        // 发送消息
        $("#sendMessage").click(function () {
            var content = $("#messageContent").val().trim();
            if (!content) {
                alert("请输入消息内容");
                return;
            }

            // Disable button while sending
            var $btn = $(this);
            $btn.prop('disabled', true);
            var originalText = $btn.html();
            $btn.html('<i class="fas fa-spinner fa-spin"></i> 发送中...');

            $.ajax({
                url: "/Home/UserSendMessageToRecycler",
                type: "POST",
                data: {
                    OrderID: orderId,
                    Content: content
                },
                success: function (res) {
                    if (res.success) {
                        $("#messageContent").val("");
                        loadMessages(); // 发送成功后刷新消息列表
                    } else {
                        alert("发送失败：" + res.message);
                    }
                },
                error: function () {
                    alert("网络错误，发送失败");
                },
                complete: function () {
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                }
            });
        });

        // 结束对话功能
        $("#endConversationBtn").click(function () {
            if (!confirm("确认结束本次对话？")) {
                return;
            }

            $.ajax({
                url: "/Home/EndConversation",
                type: "POST",
                data: { orderId: orderId },
                success: function (res) {
                    if (res.success) {
                        alert("对话已结束");
                        loadMessages(); // 重新加载消息以显示对话结束状态
                    } else {
                        alert("结束对话失败：" + res.message);
                    }
                },
                error: function () {
                    alert("网络错误，无法结束对话");
                }
            });
        });

        // 按Enter发送消息
        $("#messageContent").keydown(function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                $("#sendMessage").click();
            }
        });

        // 定时刷新消息（每5秒）
        setInterval(loadMessages, 5000);

        // 页面加载时初始化
        $(function () {
            loadMessages();
            // 标记消息为已读
            $.post("/Home/MarkUserMessagesAsRead", { orderId: orderId });
        });
    </script>
}