@model recycling.Model.AppointmentViewModel

@{
    ViewBag.Title = "预约上门回收 - 第一步";
    Layout = "~/Views/Shared/_Layout.cshtml";
    
    // Declare variables at the top so they are accessible throughout the view including @section Scripts
    var userAddresses = ViewBag.UserAddresses as List<recycling.Model.UserAddresses> ?? new List<recycling.Model.UserAddresses>();
    var streets = ViewBag.Streets as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<!-- 引入Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* 基础样式保持不变，只修改按钮部分 */
    .form-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-next {
        flex: 1;
        height: 60px;
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-cancel {
        flex: 1;
        height: 60px;
        background: #95a5a6;
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
    }

    .btn-next:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(39, 174, 96, 0.3);
    }

    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(149, 165, 166, 0.3);
        color: white;
        text-decoration: none;
    }

    /* 多选样式 */
    .checkbox-list {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .category-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .category-checkbox:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .category-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .category-checkbox.selected {
            border-color: #27ae60;
            background: #e8f5e8;
        }

    .category-name {
        font-weight: 600;
        color: #2c3e50;
    }

    /* 其他样式保持不变 */
    .appointment-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    .appointment-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .appointment-title {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .appointment-subtitle {
        font-size: 16px;
        color: #7f8c8d;
    }

    .appointment-card {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .form-section {
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
        display: flex;
        align-items: center;
    }

        .section-title i {
            margin-right: 10px;
            color: #3498db;
        }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        height: 50px;
        border-radius: 10px;
        border: 2px solid #ecf0f1;
        font-size: 16px;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

    textarea.form-control {
        height: 120px;
        resize: vertical;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

    .image-upload-area {
        border: 2px dashed #bdc3c7;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .image-upload-area:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

    .image-upload-icon {
        font-size: 48px;
        color: #bdc3c7;
        margin-bottom: 15px;
    }

    .image-upload-text {
        color: #7f8c8d;
        margin-bottom: 10px;
    }

    .image-upload-hint {
        font-size: 12px;
        color: #95a5a6;
    }

    .form-note {
        background: #e8f4fd;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
    }

        .form-note p {
            margin: 0;
            color: #2c3e50;
            font-size: 14px;
        }

    .required-field::after {
        content: " *";
        color: #e74c3c;
    }

    /* 类别重量输入样式 */
    .category-weight-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .category-weight-item:hover {
        border-color: #3498db;
        background: #e3f2fd;
    }

    .category-weight-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        display: block;
        font-size: 16px;
    }

    .category-weight-label i {
        color: #3498db;
        margin-right: 8px;
    }

    .weight-input-wrapper {
        position: relative;
    }

    .weight-input-wrapper .form-control {
        padding-right: 60px;
    }

    .weight-unit {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #7f8c8d;
        font-weight: 500;
    }

    #calculateTotalBtn {
        background: linear-gradient(45deg, #3498db, #2980b9);
        border: none;
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    #calculateTotalBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
    }

    #calculateTotalBtn i {
        margin-right: 8px;
    }

    /* 地址选择样式 */
    .address-selection-wrapper {
        margin-bottom: 15px;
    }

    .selected-address-info {
        margin-top: 15px;
    }

    .address-detail-card {
        background: #e8f5e8;
        border: 2px solid #27ae60;
        border-radius: 10px;
        padding: 20px;
    }

    .address-detail-row {
        display: flex;
        margin-bottom: 10px;
    }

    .address-detail-row:last-child {
        margin-bottom: 0;
    }

    .address-detail-row .label {
        font-weight: 600;
        color: #2c3e50;
        min-width: 100px;
    }

    .address-detail-row .label i {
        margin-right: 8px;
        color: #27ae60;
    }

    .address-detail-row .value {
        color: #34495e;
        flex: 1;
    }

    .new-address-card {
        background: #f8f9fa;
        border: 2px solid #3498db;
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
    }

    .new-address-title {
        color: #3498db;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }

    .new-address-title i {
        margin-right: 8px;
    }

    #saveNewAddressBtn {
        height: 50px;
        font-size: 16px;
        font-weight: bold;
    }

    #saveNewAddressBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(39, 174, 96, 0.3);
    }

    @@media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 15px;
        }

        .appointment-card {
            padding: 20px;
        }

        .appointment-title {
            font-size: 24px;
        }

        .checkbox-list {
            flex-direction: column;
        }

        .form-buttons {
            flex-direction: column;
        }

        .address-detail-row {
            flex-direction: column;
        }

        .address-detail-row .label {
            min-width: auto;
            margin-bottom: 5px;
        }
    }
</style>

<div class="appointment-container">
    <div class="appointment-header">
        <h1 class="appointment-title">
            <i class="fas fa-calendar-check"></i>预约上门回收
        </h1>
        <p class="appointment-subtitle">步骤1/2：填写基本信息</p>
    </div>

    <div class="appointment-card">
        @using (Html.BeginForm("Appointment", "User", FormMethod.Post, new { enctype = "multipart/form-data", id = "appointmentForm" }))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

            <!-- 基本信息 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>基本信息
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required-field">预约类型</label>
                        @Html.DropDownListFor(m => m.AppointmentType, new SelectList(ViewBag.AppointmentTypes, "Key", "Value"), "请选择预约类型", new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.AppointmentType, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>

            <!-- 回收品类多选 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-list"></i>回收品类
                </div>

                <div class="form-group">
                    <label class="form-label required-field">请选择回收品类（可多选）</label>
                    <div class="checkbox-list" id="categoryCheckboxes">
                        @foreach (var category in ViewBag.RecyclingCategories)
                        {
                            <label class="category-checkbox" data-category-key="@category.Key" data-category-name="@category.Value">
                                <input type="checkbox" name="SelectedCategories" value="@category.Key" class="category-checkbox-input"
                                       @(Model.SelectedCategories != null && Model.SelectedCategories.Contains(category.Key) ? "checked" : "") />
                                <span class="category-name">@category.Value</span>
                            </label>
                        }
                    </div>
                    @Html.ValidationMessage("SelectedCategories", new { @class = "text-danger" })
                </div>

                <!-- 动态显示的类别重量输入区域 -->
                <div id="categoryWeightsContainer" style="margin-top: 20px;"></div>

                <!-- 总重量显示区域 -->
                <div id="totalWeightSection" style="margin-top: 20px; display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <button type="button" id="calculateTotalBtn" class="btn btn-info" style="height: 50px; width: 100%;">
                                <i class="fas fa-calculator"></i> 计算总重量
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="form-label required-field">总重量 (公斤)</label>
                            @Html.TextBoxFor(m => m.EstimatedWeight, new { @class = "form-control", type = "number", step = "0.1", min = "0.1", max = "1000", placeholder = "点击计算按钮自动计算", @readonly = "readonly" })
                            @Html.ValidationMessageFor(m => m.EstimatedWeight, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>
            </div>

            <!-- 时间安排 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-clock"></i>时间安排
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required-field">预约日期</label>
                        @Html.TextBoxFor(m => m.AppointmentDate, new { @class = "form-control", type = "date", min = DateTime.Today.AddDays(1).ToString("yyyy-MM-dd") })
                        @Html.ValidationMessageFor(m => m.AppointmentDate, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label class="form-label required-field">时间段</label>
                        @Html.DropDownListFor(m => m.TimeSlot, new SelectList(ViewBag.TimeSlots, "Key", "Value"), "请选择时间段", new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.TimeSlot, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="checkbox-group">
                    @Html.CheckBoxFor(m => m.IsUrgent, new { id = "IsUrgent" })
                    <label for="IsUrgent" class="form-label" style="margin-bottom:0;">加急服务（需额外费用）</label>
                </div>
            </div>

            <!-- 联系信息 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-user"></i>联系信息
                </div>

                <!-- 地址选择区域 -->
                <div class="form-group">
                    <label class="form-label required-field">选择收货地址</label>
                    <div class="address-selection-wrapper">
                        @{
                            var addressOptions = new List<SelectListItem>
                            {
                                new SelectListItem { Value = "0", Text = "-- 新增地址 --" }
                            };
                            foreach (var addr in userAddresses)
                            {
                                // 将街道键转换为显示名称以构建完整地址
                                string streetDisplayName = addr.Street;
                                if (!string.IsNullOrEmpty(addr.Street) && streets.ContainsKey(addr.Street))
                                {
                                    streetDisplayName = streets[addr.Street];
                                }
                                string formattedAddress = $"{addr.Province}{addr.City}{addr.District}{streetDisplayName}{addr.DetailAddress}";
                                
                                addressOptions.Add(new SelectListItem
                                {
                                    Value = addr.AddressID.ToString(),
                                    Text = $"{addr.ContactName} {addr.ContactPhone} - {formattedAddress}" + (addr.IsDefault ? " [默认]" : ""),
                                    Selected = Model.SelectedAddressID.HasValue && Model.SelectedAddressID.Value == addr.AddressID
                                });
                            }
                        }
                        @Html.DropDownListFor(m => m.SelectedAddressID, addressOptions, new { @class = "form-control", id = "addressSelect" })
                        @Html.ValidationMessageFor(m => m.SelectedAddressID, "", new { @class = "text-danger" })
                    </div>
                </div>

                <!-- 选中地址的详情显示 -->
                <div id="selectedAddressInfo" class="selected-address-info" style="display: none;">
                    <div class="address-detail-card">
                        <div class="address-detail-row">
                            <span class="label"><i class="fas fa-user"></i> 联系人：</span>
                            <span id="displayContactName" class="value"></span>
                        </div>
                        <div class="address-detail-row">
                            <span class="label"><i class="fas fa-phone"></i> 电话：</span>
                            <span id="displayContactPhone" class="value"></span>
                        </div>
                        <div class="address-detail-row">
                            <span class="label"><i class="fas fa-map-marker-alt"></i> 地址：</span>
                            <span id="displayFullAddress" class="value"></span>
                        </div>
                    </div>
                </div>

                <!-- 新增地址表单（默认隐藏） -->
                <div id="newAddressForm" style="display: none;">
                    <div class="new-address-card">
                        <h5 class="new-address-title"><i class="fas fa-plus-circle"></i> 新增地址</h5>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required-field">联系人姓名</label>
                                @Html.TextBoxFor(m => m.ContactName, new { @class = "form-control", placeholder = "请输入联系人姓名", id = "newContactName" })
                                @Html.ValidationMessageFor(m => m.ContactName, "", new { @class = "text-danger" })
                            </div>

                            <div class="form-group">
                                <label class="form-label required-field">联系电话</label>
                                @Html.TextBoxFor(m => m.ContactPhone, new { @class = "form-control", placeholder = "请输入手机号码", id = "newContactPhone" })
                                @Html.ValidationMessageFor(m => m.ContactPhone, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">省份</label>
                                <input type="text" class="form-control" value="广东省" readonly style="background-color: #f8f9fa; cursor: not-allowed;" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">城市</label>
                                <input type="text" class="form-control" value="深圳市" readonly style="background-color: #f8f9fa; cursor: not-allowed;" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">区域</label>
                                <input type="text" class="form-control" value="罗湖区" readonly style="background-color: #f8f9fa; cursor: not-allowed;" />
                            </div>

                            <div class="form-group">
                                <label class="form-label required-field">街道</label>
                                @Html.DropDownListFor(m => m.Street, new SelectList(ViewBag.Streets ?? new Dictionary<string, string>(), "Key", "Value"), "请选择街道", new { @class = "form-control", id = "newStreet" })
                                @Html.ValidationMessageFor(m => m.Street, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required-field">详细地址</label>
                            @Html.TextBoxFor(m => m.Address, new { @class = "form-control", placeholder = "请输入详细地址，包括门牌号等信息", id = "newDetailAddress" })
                            @Html.ValidationMessageFor(m => m.Address, "", new { @class = "text-danger" })
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="saveAsDefault" />
                                <label for="saveAsDefault" class="form-label" style="margin-bottom:0;">设为默认地址</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" id="saveNewAddressBtn" class="btn btn-success" style="width: 100%;">
                                <i class="fas fa-save"></i> 保存并使用此地址
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图片上传 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-images"></i>物品图片（选填）
                </div>

                <div class="image-upload-area" onclick="document.getElementById('imageUpload').click()">
                    <div class="image-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="image-upload-text">点击上传物品图片</div>
                    <div class="image-upload-hint">支持 JPG、PNG 格式，最多5张图片，每张不超过5MB</div>
                    <input type="file" id="imageUpload" name="Images" multiple accept="image/*" style="display: none;" onchange="handleImageSelection(this)">
                </div>
                <div id="imagePreview" style="margin-top: 15px;"></div>
            </div>

            <!-- 特殊要求 -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-edit"></i>特殊要求（选填）
                </div>

                <div class="form-group">
                    @Html.TextAreaFor(m => m.SpecialRequirements, new { @class = "form-control", placeholder = "如有特殊要求或说明，请在此处填写...", rows = "4" })
                    @Html.ValidationMessageFor(m => m.SpecialRequirements, "", new { @class = "text-danger" })
                </div>
            </div>

            <!-- 按钮区域 -->
            <div class="form-buttons">
                <a href="@Url.Action("Index", "Home")" class="btn-cancel">
                    <i class="fas fa-times"></i>取消
                </a>
                <button type="submit" class="btn-next" id="nextBtn">
                    <i class="fas fa-arrow-right"></i>下一步
                </button>
            </div>

            <div class="form-note">
                <p><i class="fas fa-info-circle"></i> 下一步将根据您选择的品类，询问详细情况以获得更准确的价格预估。</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // 设置最小日期为明天
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];

            const dateInput = document.getElementById('AppointmentDate');
            if (dateInput) {
                dateInput.min = minDate;
                if (!dateInput.value) {
                    dateInput.value = minDate;
                }
            }

            // 品类多选样式
            const checkboxes = document.querySelectorAll('.category-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const label = this.closest('.category-checkbox');
                    if (this.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                    // 更新重量输入区域
                    updateCategoryWeightInputs();
                });

                // 初始化样式
                if (checkbox.checked) {
                    checkbox.closest('.category-checkbox').classList.add('selected');
                }
            });

            // 初始化时更新重量输入区域
            updateCategoryWeightInputs();

            // 动态更新类别重量输入框
            function updateCategoryWeightInputs() {
                const container = document.getElementById('categoryWeightsContainer');
                const totalWeightSection = document.getElementById('totalWeightSection');
                const selectedCategories = [];

                // 获取所有选中的类别
                document.querySelectorAll('.category-checkbox-input:checked').forEach(checkbox => {
                    const label = checkbox.closest('.category-checkbox');
                    selectedCategories.push({
                        key: checkbox.value,
                        name: label.getAttribute('data-category-name')
                    });
                });

                // 清空容器
                container.innerHTML = '';

                if (selectedCategories.length > 0) {
                    // 显示总重量区域
                    totalWeightSection.style.display = 'block';

                    // 为每个选中的类别创建重量输入框
                    selectedCategories.forEach(category => {
                        const weightItem = document.createElement('div');
                        weightItem.className = 'category-weight-item';
                        weightItem.innerHTML = `
                            <label class="category-weight-label">
                                <i class="fas fa-weight-hanging"></i>${category.name} - 重量
                            </label>
                            <div class="weight-input-wrapper">
                                <input type="number" 
                                       class="form-control category-weight-input" 
                                       name="CategoryWeights[${category.key}]"
                                       data-category-key="${category.key}"
                                       step="0.1" 
                                       min="0.1" 
                                       max="1000" 
                                       placeholder="请输入${category.name}的重量（公斤）"
                                       required>
                                <span class="weight-unit">公斤</span>
                            </div>
                        `;
                        container.appendChild(weightItem);
                    });
                } else {
                    // 隐藏总重量区域
                    totalWeightSection.style.display = 'none';
                    // 清空总重量
                    document.getElementById('EstimatedWeight').value = '';
                }
            }

            // 计算总重量按钮事件
            document.getElementById('calculateTotalBtn').addEventListener('click', function () {
                let totalWeight = 0;
                let allFilled = true;
                const weightInputs = document.querySelectorAll('.category-weight-input');

                weightInputs.forEach(input => {
                    const value = parseFloat(input.value);
                    if (value && value > 0) {
                        totalWeight += value;
                    } else {
                        allFilled = false;
                    }
                });

                if (!allFilled) {
                    alert('请先填写所有类别的重量！');
                    return;
                }

                if (totalWeight > 0) {
                    document.getElementById('EstimatedWeight').value = totalWeight.toFixed(1);
                    // 添加视觉反馈
                    const estimatedWeightInput = document.getElementById('EstimatedWeight');
                    estimatedWeightInput.style.background = '#e8f5e9';
                    estimatedWeightInput.style.color = '#27ae60';
                    estimatedWeightInput.style.fontWeight = 'bold';
                    
                    setTimeout(() => {
                        estimatedWeightInput.style.background = '';
                        estimatedWeightInput.style.color = '';
                        estimatedWeightInput.style.fontWeight = '';
                    }, 2000);
                } else {
                    alert('请输入有效的重量值！');
                }
            });

            // 修复表单提交处理 - 只在验证通过时禁用按钮
            const form = document.getElementById('appointmentForm');
            const nextBtn = document.getElementById('nextBtn');

            if (form && nextBtn) {
                form.addEventListener('submit', function (e) {
                    // 先进行jQuery验证
                    if (!$(form).valid()) {
                        e.preventDefault();
                        return;
                    }

                    // 验证通过后才禁用按钮
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
                });
            }

            // 地址选择功能
            const addressSelect = document.getElementById('addressSelect');
            const selectedAddressInfo = document.getElementById('selectedAddressInfo');
            const newAddressForm = document.getElementById('newAddressForm');

            // 存储地址数据
            var addressCache = {};
            @foreach (var addr in userAddresses)
            {
                // 将街道键转换为显示名称以构建完整地址
                string streetDisplayNameJs = addr.Street;
                if (!string.IsNullOrEmpty(addr.Street) && streets.ContainsKey(addr.Street))
                {
                    streetDisplayNameJs = streets[addr.Street];
                }
                string formattedAddressJs = $"{addr.Province}{addr.City}{addr.District}{streetDisplayNameJs}{addr.DetailAddress}";
                
                <text>
                addressCache[@addr.AddressID] = {
                    contactName: '@HttpUtility.JavaScriptStringEncode(addr.ContactName)',
                    contactPhone: '@HttpUtility.JavaScriptStringEncode(addr.ContactPhone)',
                    fullAddress: '@HttpUtility.JavaScriptStringEncode(formattedAddressJs)'
                };
                </text>
            }

            // 地址选择变化事件
            if (addressSelect) {
                addressSelect.addEventListener('change', function() {
                    const selectedValue = parseInt(this.value);
                    handleAddressSelection(selectedValue);
                });

                // 初始化时触发一次
                handleAddressSelection(parseInt(addressSelect.value));
            }

            function handleAddressSelection(selectedValue) {
                if (selectedValue === 0 || isNaN(selectedValue)) {
                    // 选择新增地址
                    selectedAddressInfo.style.display = 'none';
                    newAddressForm.style.display = 'block';
                } else {
                    // 选择已有地址
                    newAddressForm.style.display = 'none';
                    
                    // 从缓存获取地址信息
                    if (addressCache[selectedValue]) {
                        const address = addressCache[selectedValue];
                        document.getElementById('displayContactName').textContent = address.contactName;
                        document.getElementById('displayContactPhone').textContent = address.contactPhone;
                        document.getElementById('displayFullAddress').textContent = address.fullAddress;
                        selectedAddressInfo.style.display = 'block';
                    } else {
                        // 如果缓存没有，通过API获取
                        fetchAddressById(selectedValue);
                    }
                }
            }

            function fetchAddressById(addressId) {
                $.ajax({
                    url: '@Url.Action("GetAddressById", "User")',
                    type: 'GET',
                    data: { addressId: addressId },
                    success: function(response) {
                        if (response.success) {
                            const address = response.data;
                            document.getElementById('displayContactName').textContent = address.contactName;
                            document.getElementById('displayContactPhone').textContent = address.contactPhone;
                            document.getElementById('displayFullAddress').textContent = address.fullAddress;
                            selectedAddressInfo.style.display = 'block';
                            
                            // 更新缓存
                            addressCache[addressId] = {
                                contactName: address.contactName,
                                contactPhone: address.contactPhone,
                                fullAddress: address.fullAddress
                            };
                        } else {
                            alert('获取地址信息失败：' + response.message);
                        }
                    },
                    error: function() {
                        alert('获取地址信息失败，请重试');
                    }
                });
            }

            // 保存新地址按钮事件
            const saveNewAddressBtn = document.getElementById('saveNewAddressBtn');
            if (saveNewAddressBtn) {
                saveNewAddressBtn.addEventListener('click', function() {
                    const street = document.getElementById('newStreet').value;
                    const detailAddress = document.getElementById('newDetailAddress').value;
                    const contactName = document.getElementById('newContactName').value;
                    const contactPhone = document.getElementById('newContactPhone').value;
                    const isDefault = document.getElementById('saveAsDefault').checked;

                    // 验证必填字段
                    if (!street) {
                        alert('请选择街道');
                        return;
                    }
                    if (!detailAddress) {
                        alert('请输入详细地址');
                        return;
                    }
                    if (!contactName) {
                        alert('请输入联系人姓名');
                        return;
                    }
                    if (!contactPhone) {
                        alert('请输入联系电话');
                        return;
                    }
                    // 验证手机号格式
                    if (!/^1[3-9]\d{9}$/.test(contactPhone)) {
                        alert('请输入有效的11位手机号码');
                        return;
                    }

                    // 禁用按钮
                    saveNewAddressBtn.disabled = true;
                    saveNewAddressBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

                    // 获取CSRF令牌
                    var token = $('input[name="__RequestVerificationToken"]').val();

                    // 发送请求保存地址
                    $.ajax({
                        url: '@Url.Action("AddAddressForAppointment", "User")',
                        type: 'POST',
                        data: {
                            __RequestVerificationToken: token,
                            street: street,
                            detailAddress: detailAddress,
                            contactName: contactName,
                            contactPhone: contactPhone,
                            isDefault: isDefault
                        },
                        success: function(response) {
                            if (response.success) {
                                const newAddress = response.data;
                                
                                // 添加新选项到下拉框
                                const option = document.createElement('option');
                                option.value = newAddress.addressId;
                                option.text = newAddress.contactName + ' ' + newAddress.contactPhone + ' - ' + newAddress.fullAddress + (newAddress.isDefault ? ' [默认]' : '');
                                addressSelect.add(option);
                                
                                // 更新缓存
                                addressCache[newAddress.addressId] = {
                                    contactName: newAddress.contactName,
                                    contactPhone: newAddress.contactPhone,
                                    fullAddress: newAddress.fullAddress
                                };
                                
                                // 选中新添加的地址
                                addressSelect.value = newAddress.addressId;
                                handleAddressSelection(newAddress.addressId);
                                
                                // 清空新增表单
                                document.getElementById('newStreet').value = '';
                                document.getElementById('newDetailAddress').value = '';
                                document.getElementById('newContactName').value = '';
                                document.getElementById('newContactPhone').value = '';
                                document.getElementById('saveAsDefault').checked = false;
                                
                                alert('地址添加成功！');
                            } else {
                                alert('添加地址失败：' + response.message);
                            }
                        },
                        error: function() {
                            alert('添加地址失败，请重试');
                        },
                        complete: function() {
                            // 恢复按钮
                            saveNewAddressBtn.disabled = false;
                            saveNewAddressBtn.innerHTML = '<i class="fas fa-save"></i> 保存并使用此地址';
                        }
                    });
                });
            }
        });

        // 图片选择处理（保持不变）
        function handleImageSelection(input) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            if (input.files && input.files.length > 0) {
                if (input.files.length > 5) {
                    alert('最多只能上传5张图片');
                    input.value = '';
                    return;
                }

                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];

                    if (file.size > 5 * 1024 * 1024) {
                        alert(`文件 "${file.name}" 大小超过5MB限制`);
                        input.value = '';
                        preview.innerHTML = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgContainer = document.createElement('div');
                        imgContainer.style.cssText = `
                                display: inline-block;
                                margin: 5px;
                                position: relative;
                            `;

                        imgContainer.innerHTML = `
                                <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
                                <button type="button" onclick="removeImage(this)" style="
                                    position: absolute;
                                    top: -5px;
                                    right: -5px;
                                    background: #e74c3c;
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    cursor: pointer;
                                    font-size: 12px;
                                ">×</button>
                            `;

                        preview.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function removeImage(button) {
            button.parentElement.remove();
        }
    </script>
}
}