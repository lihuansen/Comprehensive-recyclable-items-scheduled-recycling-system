# 基地管理功能快速指南

## 功能概述

基地人员端新增**基地管理**功能，包含两大模块：

### 1. 运输管理 📦
- **功能**：查看运输中的订单通知
- **访问**：基地管理 → 运输管理
- **特点**：
  - 实时显示运输中订单
  - 自动30秒刷新
  - 显示回收员、运输员、预估重量等信息

### 2. 仓库管理 🏭
- **功能**：处理可回收物入库
- **访问**：基地管理 → 仓库管理
- **特点**：
  - 创建入库单
  - 自动清零暂存点重量
  - 发送通知给回收员
  - 查看入库历史记录

## 快速开始

### 步骤1：访问基地管理
```
登录 → 顶部导航"基地管理" → 选择功能模块
```

### 步骤2：查看运输通知
```
基地管理 → 运输管理 → 查看运输中订单列表
```

### 步骤3：创建入库单
```
基地管理 → 仓库管理 → 选择运输单 → 填写信息 → 创建
```

## 核心流程

### 入库流程
```
1. 运输单完成 ✅
   ↓
2. 在运输管理中查看 👀
   ↓
3. 进入仓库管理 📝
   ↓
4. 选择运输单并填写入库信息
   ↓
5. 系统自动：
   - 生成入库单号 (WR202601040001)
   - 清零暂存点重量 ⚡
   - 发送通知给回收员 📧
   ↓
6. 完成入库 ✓
```

## 重要说明

### ⚠️ 注意事项
1. **只能为已完成的运输单创建入库单**
2. **每个运输单只能创建一次入库单**
3. **入库后会自动清零对应暂存点的重量**
4. **入库重量必须大于0**

### ✅ 验证机制
- 运输单状态检查
- 防止重复入库
- 自动通知回收员
- 数据完整性保证

## 数据格式

### 入库单号格式
```
WR + 年月日 + 4位序号
示例：WR202601040001
```

### 物品类别JSON格式（可选）
```json
[
  {
    "categoryKey": "paper",
    "categoryName": "纸类",
    "weight": 20.5
  },
  {
    "categoryKey": "plastic",
    "categoryName": "塑料",
    "weight": 15.0
  }
]
```

## 界面说明

### 基地管理主页
```
┌─────────────────────────────────────┐
│         基地管理                     │
├─────────────────┬───────────────────┤
│   运输管理      │    仓库管理       │
│                 │                   │
│ 🚚 查看运输中   │ 📦 创建入库单     │
│    订单         │    处理入库       │
│                 │                   │
└─────────────────┴───────────────────┘
```

### 运输管理页面
```
运输管理
─────────────────────────────────
📊 统计：运输中订单 [5]

📋 运输中订单列表
┌──────────────────────────────┐
│ 运输单号 | 回收员 | 预估重量 │
│ TO...001 | 张三   | 45.5kg   │
│ TO...002 | 李四   | 30.2kg   │
└──────────────────────────────┘
```

### 仓库管理页面
```
仓库管理
─────────────────────────────────
左侧：选择运输单        右侧：入库记录
┌────────────┐         ┌────────────┐
│ 可入库列表 │         │ 历史记录   │
│            │         │            │
│ [TO...001] │         │ WR...001   │
│ [TO...002] │         │ WR...002   │
└────────────┘         └────────────┘
```

## 权限要求

**角色要求：** 基地工作人员 (sortingcenterworker)

**必须登录：** 是

## 技术实现

### 新增数据库表
- `WarehouseReceipts` - 入库单表

### 新增Model
- `WarehouseReceipts.cs`
- `WarehouseReceiptViewModel.cs`
- `TransportNotificationViewModel.cs`

### 新增BLL
- `WarehouseReceiptBLL.cs`

### 新增DAL
- `WarehouseReceiptDAL.cs`

### 新增Controller Actions
- `BaseManagement()`
- `BaseTransportationManagement()`
- `BaseWarehouseManagement()`
- `GetInTransitOrders()`
- `CreateWarehouseReceipt()`
- `GetWarehouseReceipts()`
- `CheckWarehouseReceipt()`

### 新增Views
- `BaseManagement.cshtml`
- `BaseTransportationManagement.cshtml`
- `BaseWarehouseManagement.cshtml`

## API接口

### 1. 获取运输中订单
```
POST /Staff/GetInTransitOrders
返回：运输中订单列表
```

### 2. 创建入库单
```
POST /Staff/CreateWarehouseReceipt
参数：transportOrderId, totalWeight, itemCategories, notes
返回：receiptId, receiptNumber
```

### 3. 获取入库记录
```
POST /Staff/GetWarehouseReceipts
参数：page, pageSize, status
返回：入库记录列表
```

### 4. 检查入库单
```
POST /Staff/CheckWarehouseReceipt
参数：transportOrderId
返回：hasReceipt (boolean)
```

## 常见问题

**Q: 为什么看不到运输中订单？**
A: 运输人员需要先开始运输，状态变为"运输中"。

**Q: 入库后能撤销吗？**
A: 目前不支持撤销，请仔细核对后再创建。

**Q: 暂存点清零了怎么办？**
A: 这是正常功能，表示物品已入库到基地。

**Q: 重复入库怎么办？**
A: 系统会自动防止，每个运输单只能入库一次。

## 测试建议

### 测试场景
1. ✅ 查看运输中订单
2. ✅ 创建入库单（正常流程）
3. ✅ 尝试重复入库（应该被阻止）
4. ✅ 验证暂存点清零
5. ✅ 查看入库记录
6. ✅ 验证通知发送

### 测试数据
需要：
- 已完成的运输单
- 有效的回收员账号
- 基地人员账号

## 性能优化

- ✅ 数据库索引优化
- ✅ 分页查询
- ✅ 事务处理
- ✅ 自动刷新（30秒）

## 安全性

- ✅ 登录验证
- ✅ 角色权限检查
- ✅ CSRF防护
- ✅ SQL注入防护
- ✅ 数据验证

## 相关文档

- 详细实现指南：`BASE_MANAGEMENT_IMPLEMENTATION_GUIDE.md`
- 数据库脚本：`Database/CreateWarehouseReceiptsTable.sql`

## 更新日志

**版本 1.0** - 2026-01-04
- ✨ 新增基地管理功能
- ✨ 新增运输管理模块
- ✨ 新增仓库管理模块
- ✨ 实现入库单创建
- ✨ 实现暂存点清零
- ✨ 实现通知功能

---

**快速帮助：** 如有问题请查看完整实现指南或联系开发团队
