# 用户与管理员联系功能 - 架构图

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户端 (User Side)                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────┐         ┌──────────────────┐                   │
│  │  问题反馈页面   │  -----> │  联系管理员页面   │                   │
│  │  Feedback.cshtml│         │ ContactAdmin.cshtml│                  │
│  └────────────────┘         └──────────────────┘                   │
│         │                             │                              │
│         │ 点击"联系我们"              │ 实时聊天界面                  │
│         └─────────────────────────────┘                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/AJAX
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        控制器层 (Controllers)                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              HomeController (用户端)                        │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  • ContactAdmin()              - 显示联系页面               │    │
│  │  • StartAdminContact()         - 开始/重用会话             │    │
│  │  • GetAdminContactMessages()   - 获取历史消息              │    │
│  │  • SendAdminContactMessage()   - 发送消息                  │    │
│  │  • GetUserAdminConversations() - 获取会话列表              │    │
│  │  • EndAdminContact()           - 结束会话                  │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              │ 调用业务逻辑层                         │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │             StaffController (管理员端)                      │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  • FeedbackManagement()               - 显示管理页面        │    │
│  │  • GetAllAdminContacts()              - 获取所有会话        │    │
│  │  • GetAdminContactMessagesForAdmin()  - 获取消息记录        │    │
│  │  • SendAdminContactMessageAsAdmin()   - 发送回复            │    │
│  │  • EndAdminContactAsAdmin()           - 结束会话            │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (BLL - Business Logic)               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    AdminContactBLL                          │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  职责：                                                      │    │
│  │  • 输入验证 (UserID > 0, Content 长度等)                    │    │
│  │  • 业务规则验证 (SenderType 必须是 user/admin/system)      │    │
│  │  • 异常处理                                                  │    │
│  │  • 返回 OperationResult                                     │    │
│  │                                                              │    │
│  │  方法：                                                      │    │
│  │  • GetOrCreateConversation()  - 获取或创建会话              │    │
│  │  • SendMessage()              - 发送消息（含验证）          │    │
│  │  • GetConversationMessages()  - 获取消息记录                │    │
│  │  • EndConversationByUser()    - 用户结束会话                │    │
│  │  • EndConversationByAdmin()   - 管理员结束会话              │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              │ 调用数据访问层                         │
│                              ▼                                       │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│                   数据访问层 (DAL - Data Access Layer)              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    AdminContactDAL                          │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  职责：                                                      │    │
│  │  • SQL 查询执行                                             │    │
│  │  • 参数化查询（防止 SQL 注入）                              │    │
│  │  • 数据映射（DataReader → Model）                          │    │
│  │  • 事务管理                                                  │    │
│  │                                                              │    │
│  │  核心查询：                                                  │    │
│  │                                                              │    │
│  │  1. 会话查询（GetOrCreateConversation）：                   │    │
│  │     SELECT TOP 1 ConversationID                             │    │
│  │     FROM AdminContactConversations                          │    │
│  │     WHERE UserID = @UserID AND AdminEnded = 0               │    │
│  │     ↑ 关键：只检查 AdminEnded，确保会话重用                 │    │
│  │                                                              │    │
│  │  2. 消息查询（GetConversationMessages）：                   │    │
│  │     SELECT * FROM AdminContactMessages                      │    │
│  │     WHERE UserID = @UserID                                  │    │
│  │     ORDER BY SentTime ASC                                   │    │
│  │     ↑ 关键：不按 ConversationID 过滤，加载所有历史消息      │    │
│  │                                                              │    │
│  │  3. 消息插入（SendMessage）：                               │    │
│  │     INSERT INTO AdminContactMessages                        │    │
│  │     (UserID, AdminID, SenderType, Content, SentTime)        │    │
│  │     VALUES (@UserID, @AdminID, @SenderType, @Content, NOW) │    │
│  │     ↑ 支持三种类型：user, admin, system                     │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              │ SQL 查询                              │
│                              ▼                                       │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│                      数据库层 (Database - SQL Server)               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              AdminContactMessages 表                        │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  MessageID (PK)      │ INT IDENTITY(1,1)                   │    │
│  │  UserID (FK → Users) │ INT NOT NULL                        │    │
│  │  AdminID             │ INT NULL                            │    │
│  │  SenderType          │ NVARCHAR(20) ✓ user/admin/system   │    │
│  │  Content             │ NVARCHAR(2000) NOT NULL             │    │
│  │  SentTime            │ DATETIME2 NOT NULL                  │    │
│  │  IsRead              │ BIT DEFAULT 0                       │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  索引：                                                      │    │
│  │  • IX_AdminContactMessages_UserID                          │    │
│  │  • IX_AdminContactMessages_AdminID                         │    │
│  │  • IX_AdminContactMessages_SentTime                        │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │           AdminContactConversations 表                      │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  ConversationID (PK) │ INT IDENTITY(1,1)                   │    │
│  │  UserID (FK → Users) │ INT NOT NULL                        │    │
│  │  AdminID             │ INT NULL                            │    │
│  │  StartTime           │ DATETIME2 NOT NULL                  │    │
│  │  UserEndedTime       │ DATETIME2 NULL                      │    │
│  │  AdminEndedTime      │ DATETIME2 NULL                      │    │
│  │  UserEnded           │ BIT DEFAULT 0                       │    │
│  │  AdminEnded          │ BIT DEFAULT 0 ← 关键字段            │    │
│  │  LastMessageTime     │ DATETIME2 NULL                      │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │  索引：                                                      │    │
│  │  • IX_AdminContactConversations_UserID                     │    │
│  │  • IX_AdminContactConversations_AdminID                    │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## 消息持久化流程图

```
用户重新登录后的消息加载流程：

┌─────────────┐
│  用户登录    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│ 访问"联系我们"           │
│ (点击 Feedback 页面链接) │
└──────┬──────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ ContactAdmin.cshtml 加载                │
│ • JavaScript: startNewConversation()   │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ AJAX POST: /Home/StartAdminContact     │
│ • Controller: StartAdminContact()      │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ BLL: GetOrCreateConversation(userId)   │
└──────┬─────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ DAL: 查询数据库                          │
│ SELECT TOP 1 ConversationID             │
│ FROM AdminContactConversations          │
│ WHERE UserID = @UserID                  │
│   AND AdminEnded = 0  ← 检查管理员状态  │
└──────┬──────────────────────────────────┘
       │
       ├──► 找到会话？
       │     │
       │     ├─ Yes ─► 返回现有 ConversationID
       │     │         (重用会话，不创建新的)
       │     │
       │     └─ No ──► 创建新会话
       │               INSERT INTO AdminContactConversations
       │               返回新 ConversationID
       │
       ▼
┌────────────────────────────────────────┐
│ 返回给前端：                            │
│ {                                      │
│   success: true,                       │
│   conversationId: 123,                 │
│   userId: 456                          │
│ }                                      │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ JavaScript: loadMessages()             │
│ • 调用获取历史消息 API                  │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ AJAX POST: /Home/GetAdminContactMessages│
│ • Body: { userId: 456 }                │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ DAL: 查询所有历史消息                   │
│ SELECT * FROM AdminContactMessages     │
│ WHERE UserID = @UserID                 │
│ ORDER BY SentTime ASC                  │
│                                        │
│ ↑ 关键：不按 ConversationID 过滤       │
│   这样可以加载所有历史消息              │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ 返回消息列表：                          │
│ [                                      │
│   { senderType: "system",              │
│     content: "您好，这里是在线客服",    │
│     sentTime: "2024-01-01 10:00" },   │
│   { senderType: "user",                │
│     content: "我有个问题",              │
│     sentTime: "2024-01-01 10:01" },   │
│   { senderType: "admin",               │
│     content: "请问有什么可以帮您的？",  │
│     sentTime: "2024-01-01 10:02" }    │
│ ]                                      │
└──────┬─────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ JavaScript: displayMessages()          │
│ • 遍历消息列表                          │
│ • 根据 senderType 应用不同样式          │
│   - user: 右对齐，紫色渐变背景          │
│   - admin: 左对齐，白色背景             │
│   - system: 居中，灰色背景 ← 关键      │
│ • 滚动到底部                            │
└────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────┐
│ ✅ 用户看到所有历史消息                 │
│    包括系统消息、之前的对话等            │
└────────────────────────────────────────┘
```

## 实时更新机制

```
轮询机制（每3秒执行一次）：

┌────────────────┐
│  页面加载完成   │
└───────┬────────┘
        │
        ▼
┌────────────────────────┐
│ startPolling()         │
│ setInterval(3000ms)    │
└───────┬────────────────┘
        │
        │ 每3秒执行一次
        ▼
┌─────────────────────────────────┐
│ 检查：                           │
│ • isHistoryMode? (查看历史模式)  │
│ • currentUserId? (有当前用户)    │
│ • isConversationEnded? (会话结束)│
└───────┬─────────────────────────┘
        │
        ├─ 所有条件满足 ─┐
        │                 │
        ▼                 ▼
┌──────────────┐    ┌──────────────┐
│ loadMessages │    │checkConversation│
│    (true)    │    │    Status()  │
│  静默加载     │    │              │
└──────┬───────┘    └──────┬───────┘
       │                   │
       │                   ▼
       │            检查 AdminEnded
       │            └─► 如果结束：
       │                • 停止轮询
       │                • 禁用输入
       │                • 显示"已结束"
       │
       ▼
获取新消息（如果有）
└─► 只有消息数量变化时才更新 DOM
    减少不必要的重绘
```

## 系统消息流程

```
系统消息的生命周期：

触发场景1：用户首次开始会话
┌────────────────┐
│ 创建新会话      │
└───────┬────────┘
        │
        ▼
┌──────────────────────────────────┐
│ if (isNewConversation) {         │
│   SendMessage(                   │
│     userId,                      │
│     null,        ← 无管理员ID     │
│     "system",    ← 系统消息类型   │
│     "您好，这里是在线客服"        │
│   )                              │
│ }                                │
└───────┬──────────────────────────┘
        │
        ▼
┌──────────────────────────────────┐
│ INSERT INTO AdminContactMessages │
│ VALUES (                         │
│   UserID = 456,                  │
│   AdminID = NULL,                │
│   SenderType = 'system',         │
│   Content = '您好，这里是在线客服'│
│   SentTime = NOW                 │
│ )                                │
└───────┬──────────────────────────┘
        │
        ▼
┌──────────────────────────────────┐
│ ✅ 系统消息已保存到数据库         │
└──────────────────────────────────┘

触发场景2：用户结束会话
┌────────────────┐
│ 用户点击        │
│ "结束对话"按钮  │
└───────┬────────┘
        │
        ▼
┌──────────────────────────────────┐
│ EndConversationByUser()          │
│ • UPDATE UserEnded = 1           │
│ • SendMessage("system",          │
│     "用户已结束对话")             │
└──────────────────────────────────┘

触发场景3：管理员结束会话
┌────────────────┐
│ 管理员点击      │
│ "结束对话"按钮  │
└───────┬────────┘
        │
        ▼
┌──────────────────────────────────┐
│ EndConversationByAdmin()         │
│ • UPDATE AdminEnded = 1          │
│ • SendMessage("system",          │
│     "管理员已结束对话")           │
└──────────────────────────────────┘

前端显示：
┌──────────────────────────────────┐
│ if (senderType === 'system') {   │
│   wrapper.className =            │
│     'message-wrapper system';    │
│   messageDiv.className =         │
│     'message system';            │
│   // 居中显示，灰色背景          │
│ }                                │
└──────────────────────────────────┘
```

## 数据库表关系图

```
┌─────────────────────┐
│       Users         │
│ ─────────────────── │
│ UserID (PK)         │◄───────┐
│ Username            │        │
│ PasswordHash        │        │
│ PhoneNumber         │        │
│ Email               │        │
└─────────────────────┘        │
                               │ FK
                               │
         ┌─────────────────────┴──────────────────────┐
         │                                             │
         │                                             │
┌────────┴──────────────────┐     ┌──────────────────┴─────────────┐
│ AdminContactConversations │     │   AdminContactMessages          │
│ ───────────────────────── │     │ ────────────────────────────── │
│ ConversationID (PK)       │     │ MessageID (PK)                 │
│ UserID (FK)               │◄────┤ UserID (FK)                    │
│ AdminID                   │  关  │ AdminID                        │
│ StartTime                 │  联  │ SenderType ← user/admin/system │
│ UserEnded                 │  关  │ Content                        │
│ AdminEnded ← 关键字段      │  系  │ SentTime                       │
│ UserEndedTime             │  ?  │ IsRead                         │
│ AdminEndedTime            │     └────────────────────────────────┘
│ LastMessageTime           │          │
└───────────────────────────┘          │
                                       │ 注意：消息不直接关联
                                       │ ConversationID！
                                       │ 这是持久化的关键设计
                                       ▼
                               通过 UserID 关联
                               而不是 ConversationID
                               这样可以跨会话保留消息
```

## 安全防护层

```
┌──────────────────────────────────────────────────────┐
│               安全防护层 (Security Layers)            │
├──────────────────────────────────────────────────────┤
│                                                       │
│  1. 身份验证层 (Authentication)                       │
│     ┌─────────────────────────────────────┐         │
│     │ if (Session["LoginUser"] == null)   │         │
│     │    return RedirectToLogin();        │         │
│     └─────────────────────────────────────┘         │
│                                                       │
│  2. 授权层 (Authorization)                           │
│     ┌─────────────────────────────────────┐         │
│     │ if (user.UserID != userId)          │         │
│     │    return Unauthorized();           │         │
│     └─────────────────────────────────────┘         │
│                                                       │
│  3. 输入验证层 (Input Validation)                    │
│     ┌─────────────────────────────────────┐         │
│     │ • UserID > 0                        │         │
│     │ • Content.Length <= 2000            │         │
│     │ • SenderType in [user,admin,system] │         │
│     └─────────────────────────────────────┘         │
│                                                       │
│  4. SQL 注入防护 (SQL Injection Protection)          │
│     ┌─────────────────────────────────────┐         │
│     │ cmd.Parameters.AddWithValue(...)    │         │
│     │ // 参数化查询                        │         │
│     └─────────────────────────────────────┘         │
│                                                       │
│  5. XSS 防护 (XSS Protection)                        │
│     ┌─────────────────────────────────────┐         │
│     │ function escapeHtml(str) {          │         │
│     │   return str.replace(/</g, '&lt;')  │         │
│     │             .replace(/>/g, '&gt;'); │         │
│     │ }                                   │         │
│     └─────────────────────────────────────┘         │
│                                                       │
└──────────────────────────────────────────────────────┘
```

## 关键设计决策

### 1. 为什么不按 ConversationID 过滤消息？

```
❌ 错误的设计：
SELECT * FROM AdminContactMessages 
WHERE ConversationID = @ConversationID

问题：
• 每次创建新会话，历史消息就看不到了
• 用户体验不连续

✅ 正确的设计：
SELECT * FROM AdminContactMessages 
WHERE UserID = @UserID

优点：
• 用户可以看到所有历史对话
• 跨会话保留消息
• 体验连续性好
```

### 2. 为什么只检查 AdminEnded 而不检查 UserEnded？

```
会话重用逻辑：
WHERE UserID = @UserID AND AdminEnded = 0

原因：
• 管理员是服务提供方，他们决定会话是否结束
• 用户可以随时回来继续之前的对话
• 只有管理员点击"结束对话"后，才创建新会话
• 这样设计更灵活，用户体验更好
```

### 3. 为什么使用轮询而不是 WebSocket/SignalR？

```
当前实现：3秒轮询

优点：
• 实现简单
• 兼容性好
• 不需要额外的 SignalR 配置
• 对于客服场景，3秒延迟可以接受

未来改进：
• 可以考虑使用 SignalR 实现真正的实时推送
• 减少服务器负载
• 提供更好的实时性
```

---

**文档版本**：1.0.0  
**创建日期**：2025-11-14  
**适用范围**：用户与管理员联系功能
