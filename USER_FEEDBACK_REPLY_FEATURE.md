# 用户反馈回复查看功能实现文档

## 功能概述

本功能实现了用户端查看管理员对反馈回复的功能，使得用户可以在个人中心查看自己提交的所有反馈记录以及管理员的回复，实现用户与管理员之间的双向交互。

## 实现细节

### 1. 数据访问层 (DAL)

**文件**: `recycling.DAL/FeedbackDAL.cs`

新增方法：
```csharp
public List<UserFeedback> GetUserFeedbacks(int userId)
```

**功能**：根据用户ID获取该用户的所有反馈记录
**参数**：
- `userId`: 用户ID

**返回值**：用户的反馈列表，按创建时间倒序排列

**SQL查询**：
```sql
SELECT FeedbackID, UserID, FeedbackType, Subject, Description, 
       ContactEmail, Status, AdminReply, CreatedDate, UpdatedDate 
FROM UserFeedback
WHERE UserID = @UserID
ORDER BY CreatedDate DESC
```

### 2. 业务逻辑层 (BLL)

**文件**: `recycling.BLL/FeedbackBLL.cs`

新增方法：
```csharp
public List<UserFeedback> GetUserFeedbacks(int userId)
```

**功能**：获取指定用户的所有反馈，包含业务逻辑验证
**参数**：
- `userId`: 用户ID

**业务规则**：
- 验证用户ID是否有效（大于0）
- 无效时返回空列表

### 3. 控制器层 (Controller)

**文件**: `recycling.Web.UI/Controllers/HomeController.cs`

新增Action方法：
```csharp
[HttpGet]
public ActionResult MyFeedback()
```

**功能**：处理用户查看反馈记录的请求
**路由**：`/Home/MyFeedback`
**访问权限**：需要用户登录

**处理流程**：
1. 验证用户登录状态
2. 获取当前登录用户信息
3. 调用BLL层获取用户的反馈记录
4. 返回视图并传递反馈列表

### 4. 视图层 (View)

**文件**: `recycling.Web.UI/Views/Home/MyFeedback.cshtml`

**功能特性**：

#### 页面布局
- 渐变色页面标题
- 反馈筛选器（按状态和类型）
- 反馈卡片列表
- 提交新反馈的快捷按钮

#### 反馈卡片显示
每个反馈卡片包含：
- 反馈ID
- 反馈主题
- 反馈类型（带图标）
- 状态徽章（反馈中/已完成）
- 反馈详细描述
- 提交时间和更新时间
- 联系邮箱（如果提供）
- 管理员回复区域（如有回复则显示）

#### 筛选功能
- **状态筛选**：全部状态、反馈中、已完成
- **类型筛选**：全部类型、问题反馈、功能建议、投诉举报、其他

#### 空状态处理
- 无反馈记录时显示友好提示
- 筛选无结果时显示相应提示

### 5. 个人中心入口

**文件**: `recycling.Web.UI/Views/Home/Profile.cshtml`

在个人中心的功能卡片区域新增"我的反馈"卡片：
- 图标：评论图标
- 标题：我的反馈
- 描述：查看您提交的反馈以及管理员的回复
- 按钮：查看反馈

## 用户使用流程

1. **访问个人中心**
   - 登录后访问：`/Home/Profile`
   - 点击"我的反馈"卡片

2. **查看反馈列表**
   - 页面显示所有提交的反馈
   - 可以通过筛选器按状态和类型过滤

3. **查看反馈详情**
   - 每个反馈卡片显示完整信息
   - 如果管理员已回复，回复内容会高亮显示在卡片底部

4. **提交新反馈**
   - 点击"提交新反馈"按钮
   - 跳转到反馈提交页面

## 管理员回复流程

管理员在后台通过以下流程回复用户反馈：

1. 登录管理员账号
2. 访问"反馈管理"页面
3. 点击某个反馈的"回复"按钮
4. 输入回复内容
5. 提交回复

用户在"我的反馈"页面即可看到管理员的回复。

## 数据库表结构

使用现有的 `UserFeedback` 表，包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| FeedbackID | int | 反馈ID（主键） |
| UserID | int | 用户ID |
| FeedbackType | nvarchar(50) | 反馈类型 |
| Subject | nvarchar(200) | 反馈主题 |
| Description | nvarchar(2000) | 反馈描述 |
| ContactEmail | nvarchar(100) | 联系邮箱 |
| Status | nvarchar(50) | 状态（反馈中/已完成） |
| AdminReply | nvarchar(1000) | 管理员回复 |
| CreatedDate | datetime2 | 创建时间 |
| UpdatedDate | datetime2 | 更新时间 |

## 测试指南

### 前置条件
1. 确保数据库中存在 `UserFeedback` 表
2. 确保有至少一个注册用户
3. 确保有至少一个管理员账号

### 测试步骤

#### 1. 测试查看空反馈列表
1. 使用新注册的用户登录
2. 访问个人中心
3. 点击"我的反馈"
4. **预期结果**：显示空状态提示，提示用户暂无反馈记录

#### 2. 测试提交反馈并查看
1. 在"我的反馈"页面点击"提交新反馈"
2. 填写反馈信息并提交
3. 返回"我的反馈"页面
4. **预期结果**：能看到刚提交的反馈，状态为"反馈中"，显示"管理员暂未回复"

#### 3. 测试查看管理员回复
1. 切换到管理员账号
2. 访问"反馈管理"页面
3. 找到刚才提交的反馈
4. 点击"回复"并输入回复内容
5. 切换回用户账号
6. 访问"我的反馈"页面
7. **预期结果**：能看到管理员的回复显示在反馈卡片底部的高亮区域

#### 4. 测试筛选功能
1. 在"我的反馈"页面
2. 使用状态筛选器选择"已完成"
3. **预期结果**：只显示状态为"已完成"的反馈
4. 使用类型筛选器选择"问题反馈"
5. **预期结果**：只显示类型为"问题反馈"的反馈

#### 5. 测试权限控制
1. 未登录状态下直接访问 `/Home/MyFeedback`
2. **预期结果**：自动跳转到登录选择页面

## 安全考虑

1. **权限验证**：所有操作都需要用户登录
2. **数据隔离**：用户只能查看自己的反馈，无法查看其他用户的反馈
3. **SQL注入防护**：使用参数化查询防止SQL注入
4. **XSS防护**：视图中的数据自动进行HTML编码

## 性能优化建议

1. **分页**：如果反馈记录很多，建议添加分页功能
2. **缓存**：可以考虑缓存用户的反馈统计信息
3. **索引**：在 `UserFeedback` 表的 `UserID` 字段上添加索引

## 未来扩展

1. **实时通知**：当管理员回复时，向用户发送通知
2. **邮件通知**：如果用户填写了联系邮箱，可以发送邮件通知
3. **追问功能**：允许用户对管理员的回复进行追问
4. **满意度评价**：允许用户对管理员的回复进行评分
5. **附件上传**：允许用户在反馈中上传截图等附件

## 故障排查

### 问题1：页面显示"加载反馈记录失败"
**可能原因**：
- 数据库连接问题
- UserFeedback 表不存在
- 权限问题

**解决方法**：
- 检查数据库连接字符串
- 确认 UserFeedback 表存在
- 检查数据库用户权限

### 问题2：筛选功能不工作
**可能原因**：
- JavaScript 错误
- jQuery 未加载

**解决方法**：
- 检查浏览器控制台是否有JavaScript错误
- 确认 jQuery 已正确加载

### 问题3：个人中心没有"我的反馈"卡片
**可能原因**：
- 缓存问题
- 视图文件未正确部署

**解决方法**：
- 清除浏览器缓存
- 确认 Profile.cshtml 文件已更新
- 重启应用程序

## 技术栈

- **后端框架**：ASP.NET MVC (.NET Framework 4.8)
- **数据库**：SQL Server
- **前端框架**：jQuery
- **UI组件**：Bootstrap, Font Awesome
- **数据访问**：ADO.NET (SqlConnection, SqlCommand)

## 代码规范

遵循项目现有的代码规范：
- 使用中文注释
- 方法添加XML文档注释
- 异常处理使用 try-catch
- 数据库连接使用 using 语句确保资源释放

## 总结

本功能完整实现了用户查看反馈回复的需求，为用户与管理员之间的沟通提供了一个有效的渠道。通过美观的界面设计和完善的功能实现，提升了用户体验。
