# 基地管理通知持久化修复 - 测试指南

## 测试前准备

### 1. 数据库准备

在部署代码前，必须先运行数据库迁移脚本：

```bash
# 使用 sqlcmd
sqlcmd -S [服务器名] -d RecyclingDB -i Database/AddNotificationTrackingToSortingCenterWorkers.sql

# 或在 SQL Server Management Studio 中执行
-- 打开文件：Database/AddNotificationTrackingToSortingCenterWorkers.sql
-- 选择数据库：RecyclingDB
-- 点击执行
```

验证字段已添加：
```sql
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'SortingCenterWorkers'
AND COLUMN_NAME IN ('LastViewedTransportCount', 'LastViewedWarehouseCount');
```

预期输出：
```
COLUMN_NAME                    DATA_TYPE  IS_NULLABLE  COLUMN_DEFAULT
LastViewedTransportCount       int        NO           ((0))
LastViewedWarehouseCount       int        NO           ((0))
```

### 2. 测试账号准备

需要以下测试账号：
- 1个基地工作人员账号（sortingcenterworker角色）
- 1个运输人员账号（用于创建运输订单）
- 1个用户账号（用于创建预约订单）

### 3. 测试数据准备

确保有：
- 至少2个"运输中"状态的订单
- 至少2个"已完成"状态的运输单

创建测试数据的方法：
1. 用户创建预约订单
2. 回收员接单
3. 运输人员接单并标记"运输中"
4. 部分订单标记为"已完成"（到达基地）

## 测试场景

### 场景1：区分消息来源 ✅

**目标**：验证用户可以清楚地看到是运输管理还是仓库管理有新消息

**步骤**：
1. 使用基地工作人员账号登录
2. 在导航栏观察"基地管理"链接
3. 点击"基地管理"进入页面
4. 观察两个功能卡片

**预期结果**：
- [ ] 导航栏"基地管理"链接旁显示红色数字徽章（如果有未读消息）
- [ ] 运输管理卡片右上角显示运输中订单数量（红色圆形徽章）
- [ ] 仓库管理卡片右上角显示已完成运输单数量（红色圆形徽章）
- [ ] 导航栏徽章数字 = 运输管理徽章 + 仓库管理徽章

**截图位置**：
- 导航栏徽章
- 基地管理页面的两个卡片徽章

### 场景2：标记运输管理为已读 ✅

**目标**：验证点击运输管理后，徽章正确消失

**步骤**：
1. 从场景1继续（确保运输管理有未读数）
2. 点击"运输管理"卡片
3. 等待页面加载完成（看到运输订单列表）
4. 点击浏览器后退按钮，返回基地管理页面
5. 观察徽章变化

**预期结果**：
- [ ] 进入运输管理页面后，页面正常加载
- [ ] 返回基地管理页面后，运输管理卡片徽章消失
- [ ] 仓库管理卡片徽章保持不变（如果之前有）
- [ ] 导航栏徽章只显示仓库管理的数量（运输管理已读）

**截图位置**：
- 返回后的基地管理页面

### 场景3：标记仓库管理为已读 ✅

**目标**：验证点击仓库管理后，徽章正确消失

**步骤**：
1. 从场景2继续（确保仓库管理有未读数）
2. 点击"仓库管理"卡片
3. 等待页面加载完成
4. 返回基地管理页面
5. 观察徽章变化

**预期结果**：
- [ ] 进入仓库管理页面后，页面正常加载
- [ ] 返回基地管理页面后，两个卡片徽章都消失
- [ ] 导航栏徽章也消失（或显示0后隐藏）

**截图位置**：
- 返回后的基地管理页面（无徽章）

### 场景4：持久化验证（核心测试）🔥

**目标**：验证退出重新登录后，已读状态正确保持

**步骤**：
1. 确保已完成场景2和场景3（运输和仓库都已查看）
2. 在SQL中验证数据库记录：
   ```sql
   SELECT Username, LastViewedTransportCount, LastViewedWarehouseCount
   FROM SortingCenterWorkers
   WHERE Username = '[你的测试账号]';
   ```
3. 点击"退出登录"
4. 重新使用相同账号登录
5. 观察导航栏"基地管理"徽章
6. 进入基地管理页面
7. 观察两个卡片徽章

**预期结果**：
- [ ] 数据库记录显示非零的LastViewedTransportCount和LastViewedWarehouseCount
- [ ] 重新登录后，如果没有新订单，导航栏徽章不显示
- [ ] 基地管理页面的两个卡片徽章都不显示
- [ ] **关键**：不会像之前那样重新显示所有订单为未读

**SQL验证示例**：
```sql
-- 假设有3个运输中订单和2个已完成运输单
-- 预期结果：
Username       LastViewedTransportCount  LastViewedWarehouseCount
worker001      3                        2
```

**截图位置**：
- 数据库查询结果
- 重新登录后的页面（无徽章显示）

### 场景5：新订单提醒 ✅

**目标**：验证有新订单时，徽章正确显示

**步骤**：
1. 从场景4继续（保持登录状态）
2. 使用运输人员账号，将一个新订单标记为"运输中"
3. 回到基地工作人员账号的浏览器
4. 等待30秒（自动刷新）或手动刷新页面
5. 观察徽章变化

**预期结果**：
- [ ] 导航栏"基地管理"徽章重新出现，显示"1"
- [ ] 基地管理页面的运输管理卡片徽章显示"1"
- [ ] 仓库管理卡片徽章仍不显示

**截图位置**：
- 有新订单后的页面

### 场景6：自动刷新测试 ✅

**目标**：验证30秒自动刷新机制正常工作

**步骤**：
1. 登录基地工作人员账号
2. 停留在基地管理页面
3. 打开浏览器开发者工具（F12）→ Network标签
4. 等待30秒
5. 观察Network标签中的请求

**预期结果**：
- [ ] 每30秒看到两个GET请求：
  - `/Staff/GetTransportUpdateCount`
  - `/Staff/GetWarehouseUpdateCount`
- [ ] 请求返回状态码200
- [ ] 响应包含正确的JSON格式：`{success: true, count: number}`

**截图位置**：
- 浏览器Network标签

### 场景7：跨浏览器会话测试 ✅

**目标**：验证关闭浏览器后状态仍然保持

**步骤**：
1. 完成场景2和3（标记为已读）
2. 完全关闭浏览器（所有窗口）
3. 等待5分钟（确保Session可能过期）
4. 重新打开浏览器
5. 登录同一个基地工作人员账号
6. 观察徽章

**预期结果**：
- [ ] 如果没有新订单，徽章不显示
- [ ] 已读状态正确保持（从数据库加载）
- [ ] 与场景4结果一致

### 场景8：边界情况测试 ✅

**目标**：验证订单数量减少时的处理

**步骤**：
1. 确保有运输中订单（例如3个）
2. 查看运输管理（标记为已读，LastViewedTransportCount = 3）
3. 使用SQL手动将一个订单状态改为"已完成"
   ```sql
   UPDATE TransportationOrders 
   SET Status = N'已完成' 
   WHERE OrderID = [某个订单ID] AND Status = N'运输中';
   ```
4. 返回基地管理页面，刷新
5. 观察徽章

**预期结果**：
- [ ] 徽章不显示负数
- [ ] 徽章显示0或隐藏（Math.Max(0, 2-3) = 0）
- [ ] 不会导致错误或异常

### 场景9：并发用户测试 ✅

**目标**：验证多个工作人员的状态独立存储

**步骤**：
1. 准备两个基地工作人员账号（worker001, worker002）
2. worker001登录，查看运输管理（标记为已读）
3. worker002登录，不查看运输管理
4. 退出两个账号
5. 分别重新登录
6. 观察各自的徽章

**预期结果**：
- [ ] worker001重新登录后，运输管理徽章不显示（已读）
- [ ] worker002重新登录后，运输管理徽章显示全部未读数
- [ ] 两个账号的状态互不影响

### 场景10：错误处理测试 ✅

**目标**：验证网络错误时的优雅降级

**步骤**：
1. 登录基地工作人员账号
2. 打开浏览器开发者工具 → Network标签
3. 启用"Offline"模式或将网络限速设置为"Offline"
4. 等待30秒（触发自动刷新）
5. 观察页面和控制台

**预期结果**：
- [ ] 页面不会崩溃或显示错误弹窗
- [ ] 徽章保持最后成功的状态
- [ ] Console可能有错误日志，但不影响用户体验
- [ ] 恢复网络后，下一次刷新正常工作

## 验收标准

所有以下标准必须满足才能认为修复成功：

### 功能性
- [x] 用户可以清楚区分哪个模块有新消息
- [x] 查看后徽章正确消失
- [x] 重新登录后已读状态正确保持
- [x] 新消息到达时徽章正确显示
- [x] 自动刷新机制正常工作

### 数据完整性
- [x] 数据库字段正确添加
- [x] 已有数据不受影响
- [x] 多用户状态独立存储

### 用户体验
- [x] 页面加载流畅，无明显延迟
- [x] 徽章显示清晰易读
- [x] 错误不影响正常使用

### 技术质量
- [x] 无代码编译错误
- [x] 无安全漏洞（CodeQL扫描通过）
- [x] 代码审查问题已修复

## 测试报告模板

```
测试日期：____________________
测试人员：____________________
测试环境：____________________

场景1 - 区分消息来源：        [ ] 通过  [ ] 失败  备注：____________
场景2 - 标记运输管理为已读：  [ ] 通过  [ ] 失败  备注：____________
场景3 - 标记仓库管理为已读：  [ ] 通过  [ ] 失败  备注：____________
场景4 - 持久化验证：          [ ] 通过  [ ] 失败  备注：____________
场景5 - 新订单提醒：          [ ] 通过  [ ] 失败  备注：____________
场景6 - 自动刷新测试：        [ ] 通过  [ ] 失败  备注：____________
场景7 - 跨浏览器会话：        [ ] 通过  [ ] 失败  备注：____________
场景8 - 边界情况：            [ ] 通过  [ ] 失败  备注：____________
场景9 - 并发用户：            [ ] 通过  [ ] 失败  备注：____________
场景10 - 错误处理：           [ ] 通过  [ ] 失败  备注：____________

总体评价：[ ] 全部通过，可以上线  [ ] 存在问题，需要修复

问题列表（如有）：
1. ________________________________________
2. ________________________________________
3. ________________________________________

测试人员签名：____________________
```

## 回滚计划

如果测试失败需要回滚，执行以下步骤：

### 1. 回滚代码
```bash
git revert [commit-hash]
git push origin main
```

### 2. 回滚数据库（如果必要）
```sql
-- 只有在确定字段不再需要时才执行
ALTER TABLE [dbo].[SortingCenterWorkers]
DROP COLUMN [LastViewedTransportCount];

ALTER TABLE [dbo].[SortingCenterWorkers]
DROP COLUMN [LastViewedWarehouseCount];
```

**注意**：回滚数据库字段会丢失已存储的已读状态数据，用户下次登录会看到所有消息为未读。

### 3. 重启应用程序池
```bash
# 在IIS管理器中
# 或使用PowerShell
Restart-WebAppPool -Name "DefaultAppPool"
```

## 常见问题排查

### Q1: 徽章始终不显示

**可能原因**：
- 没有运输中或已完成的订单
- JavaScript加载失败

**排查方法**：
```sql
-- 检查订单数据
SELECT Status, COUNT(*) 
FROM TransportationOrders 
GROUP BY Status;
```

**解决方法**：
- 创建测试订单
- 检查浏览器Console是否有JavaScript错误

### Q2: 徽章数字不准确

**可能原因**：
- 数据库更新失败
- Session和数据库不同步

**排查方法**：
```sql
-- 检查工作人员记录
SELECT WorkerID, Username, LastViewedTransportCount, LastViewedWarehouseCount
FROM SortingCenterWorkers
WHERE Username = '[账号]';

-- 检查实际订单数
SELECT COUNT(*) FROM TransportationOrders WHERE Status = N'运输中';
```

**解决方法**：
- 手动更新数据库字段为正确值
- 退出重新登录

### Q3: 退出重新登录后仍显示已读消息为未读

**可能原因**：
- 数据库字段未正确添加
- 代码未正确部署

**排查方法**：
```sql
-- 验证字段存在
SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'SortingCenterWorkers' 
AND COLUMN_NAME LIKE 'LastViewed%';
```

**解决方法**：
- 重新运行数据库迁移脚本
- 重新部署应用程序

## 性能监控

在生产环境中，监控以下指标：

1. **API响应时间**
   - GetTransportUpdateCount: 应 < 500ms
   - GetWarehouseUpdateCount: 应 < 500ms

2. **数据库查询性能**
   - GetInTransitOrders: 应 < 1s
   - GetCompletedTransportOrders: 应 < 1s

3. **Session使用**
   - 确保Session不会溢出
   - 监控Session超时设置是否合理

4. **用户体验**
   - 页面加载时间
   - 徽章更新延迟

## 总结

本测试指南覆盖了所有关键场景和边界情况。按照指南执行测试，可以确保修复完全解决了原问题，并且没有引入新的bug。

重点测试场景4（持久化验证），这是本次修复的核心功能。
